<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Custom Styles -->
  <link rel="stylesheet" href="/market/styles/styles.css" />
  <!-- Inline CSS for theme variables and basic styles -->
  <style>
    :root {
      --bg-color-light: #ffffff;
      --text-color-light: #333333;
      --bg-color-dark: #121212;
      --text-color-dark: #f4f4f4;
      --primary-color: #f39c12;
      /* Otras variables para cards y modales */
      --card-bg: #f8f9fa;
      --card-border: #f39c12;
    }

    body {
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
      font-family: "Share Tech Mono", monospace;
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark-theme {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }

    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Menu Component Container -->
  <div id="menu"></div>

  <div class="container my-4">
    <!-- Header Section -->
    <header class="text-center mb-4">
      <h1>Welcome to PunkQuest â€“ Unleash Your Inner Punk! ðŸš€</h1>
      <button id="theme-toggle" class="btn btn-secondary">Toggle Theme</button>
    </header>

    <!-- Wallet Connection Section -->
    <section class="mb-4">
      <button id="connect-wallet" class="btn btn-primary">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <!-- Featured NFT Section -->
    <section class="mb-4">
      <h2>Featured NFT</h2>
      <div id="featured-nft" class="card">
        <img id="nft-image" src="" alt="NFT Image" class="img-fluid" />
        <p id="nft-id" class="mt-2"></p>
      </div>
    </section>

    <!-- $ADRIAN Token Balance Section -->
    <section class="mb-4">
      <h2>$ADRIAN Token Balance</h2>
      <div id="token-balance" class="card">
        <p>Balance: <span id="adrian-balance">0</span></p>
      </div>
    </section>

    <!-- Floor Offer Section -->
    <section class="mb-4">
      <h2>Floor Offer</h2>
      <div id="floor-offer" class="card">
        <p>Coming soon... ðŸŽ‰</p>
      </div>
    </section>

    <!-- Project Information Section -->
    <section class="mb-4">
      <h2>About PunkQuest</h2>
      <div class="card">
        <p>
          PunkQuest is a decentralized application built on Ethereum, featuring unique NFTs, engaging tokenomics with $ADRIAN, and innovative staking functionalities. Join us and unleash your inner punk! ðŸŽ‰ðŸš€
        </p>
      </div>
    </section>

    <!-- SecciÃ³n: Tokens en la Wallet de AdrianPunks -->
    <section class="mb-4">
      <h2>Mis Tokens de AdrianPunks</h2>
      <div class="card">
        <select id="punk-tokens-list" class="form-select mb-2">
          <!-- Se llenarÃ¡ dinÃ¡micamente con los tokens de la wallet -->
        </select>
        <button id="load-tokens" class="btn btn-secondary">Cargar Tokens</button>
      </div>
    </section>

    <!-- SecciÃ³n: Acciones de PunkQuest -->
    <section class="mb-4">
      <h2>Acciones de PunkQuest</h2>
      <div class="card">
        <button id="stake-token" class="btn btn-primary mb-2">Stake Token</button>
        <button id="claim-rewards" class="btn btn-primary mb-2">Claim Rewards</button>
        <button id="unstake-token" class="btn btn-primary mb-2">Unstake Token</button>
        <button id="get-staking-info" class="btn btn-info mb-2">Ver Info de Staking</button>
        <button id="get-pending-rewards" class="btn btn-info mb-2">Ver Pending Rewards</button>
        <hr>
        <div class="mb-3">
          <label for="itemId" class="form-label">Item ID para Upgrade</label>
          <input type="number" id="itemId" class="form-control" placeholder="Ingrese Item ID" />
        </div>
        <div class="mb-3">
          <label for="quantity" class="form-label">Cantidad</label>
          <input type="number" id="quantity" class="form-control" placeholder="Ingrese cantidad" />
        </div>
        <button id="purchase-item-upgrade" class="btn btn-warning mb-2">Purchase Item Upgrade</button>
        <button id="purchase-fast-level" class="btn btn-warning mb-2">Fast Level Upgrade</button>
        <div id="action-output" class="mt-2"></div>
      </div>
    </section>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Cargar dinÃ¡micamente el componente del menÃº (HTML y JS asociado) -->
  <script>
    fetch('/market/components/menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('menu').innerHTML = html;
        const menuScript = document.createElement('script');
        menuScript.src = '/market/components/menu.js';
        document.body.appendChild(menuScript);
      })
      .catch(err => console.error("Failed to load menu component:", err));
  </script>

  <!-- Scripts inline para funcionalidad de tema, conexiÃ³n de wallet e interacciÃ³n con contratos -->
  <script>
    // FunciÃ³n para mostrar salida en el Ã¡rea de acciones
    function displayOutput(message) {
      document.getElementById("action-output").innerHTML = message;
    }

    // Funcionalidad del Theme Toggle
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
      localStorage.setItem('theme', theme);
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const currentTheme = localStorage.getItem('theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      applyTheme(newTheme);
    });

    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(savedTheme);
    });

    // Variables globales para ethers.js
    let provider, signer;
    let tokenContract, stakingContract, nftContract;
    const connectWalletButton = document.getElementById("connect-wallet");
    const walletInfoDiv = document.getElementById("wallet-info");

    // Direcciones de contratos
    const AD_TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const AD_PUNKS_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const STAKING_ADDRESS = "0xeEC1A809acB57acABa196C6677f65EcC4c6f4491";

    // ABI mÃ­nimo para token ($ADRIAN)
    const tokenABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    // ABI para NFT de AdrianPunks (ERC721 Enumerable)
    const nftABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
      "function tokenURI(uint256 tokenId) view returns (string)"
    ];

    // ABI del contrato de staking de AdrianPunks (con funciones de read y write)
    const stakingABI = [
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "stake",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "claimRewards",
        "outputs": [{"internalType": "uint256", "name": "rewardAmount", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "unstake",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "pendingRewards",
        "outputs": [{"internalType": "uint256", "name": "rewardAmount", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "purchaseFastLevelUpgrade",
        "outputs": [{"internalType": "uint256", "name": "bonusAdded", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
          {"internalType": "uint256", "name": "itemId", "type": "uint256"},
          {"internalType": "uint256", "name": "quantity", "type": "uint256"}
        ],
        "name": "purchaseItemUpgrade",
        "outputs": [{"internalType": "uint256", "name": "bonusAdded", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "getTokenStakingInfo",
        "outputs": [
          {"internalType": "uint256", "name": "stakeStart", "type": "uint256"},
          {"internalType": "uint256", "name": "lastClaim", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelBonus", "type": "uint256"},
          {"internalType": "uint256", "name": "itemBonus", "type": "uint256"},
          {"internalType": "uint256", "name": "pendingReward", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getBasicGamificationParameters",
        "outputs": [
          {"internalType": "uint256", "name": "activationFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "exitFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeBonusIncrement_", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getSocialStakingParameters",
        "outputs": [
          {"internalType": "uint256", "name": "socialMinTokens_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostBonus_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostDuration_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostActiveUntil_", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getLevelParameters",
        "outputs": [
          {"internalType": "uint256[]", "name": "thresholds", "type": "uint256[]"},
          {"internalType": "uint256[]", "name": "bonuses", "type": "uint256[]"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "itemId", "type": "uint256"}],
        "name": "getItem",
        "outputs": [
          {"internalType": "uint256", "name": "price", "type": "uint256"},
          {"internalType": "uint256", "name": "bonus", "type": "uint256"},
          {"internalType": "bool", "name": "exists", "type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // Evento de conexiÃ³n de wallet
    connectWalletButton.addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          walletInfoDiv.innerHTML = `<p>Wallet: ${walletAddress}</p>`;

          // Inicializar contratos
          tokenContract = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, signer);
          stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer); // La direcciÃ³n del contrato de staking es configurable
          nftContract = new ethers.Contract(AD_PUNKS_ADDRESS, nftABI, signer);

          // Obtener y actualizar el balance de $ADRIAN
          const balance = await tokenContract.balanceOf(walletAddress);
          document.getElementById("adrian-balance").innerText = ethers.utils.formatUnits(balance, 18);
        } catch (err) {
          console.error("Error al conectar la wallet:", err);
          walletInfoDiv.innerHTML = `<p style="color:red;">Connection failed. Please try again.</p>`;
        }
      } else {
        walletInfoDiv.innerHTML = `<p style="color:red;">Please install MetaMask!</p>`;
      }
    });

    // Cargar datos dinÃ¡micos del JSON para el NFT destacado
    fetch("/punkquest/adrianpunks.json")
      .then(response => response.json())
      .then(data => {
        const collection = data.collection;
        if (collection && collection.length > 0) {
          // Seleccionar aleatoriamente uno de los primeros 5 NFTs
          const randomIndex = Math.floor(Math.random() * Math.min(5, collection.length));
          const featuredNFT = collection[randomIndex];
          document.getElementById("nft-image").src = featuredNFT.image || "";
          document.getElementById("nft-id").innerText = `NFT ID: ${featuredNFT.id || "N/A"}`;
        }
      })
      .catch(err => console.error("Error loading NFT data:", err));

    // FunciÃ³n para cargar los tokens de AdrianPunks en la wallet
    document.getElementById("load-tokens").addEventListener("click", async () => {
      if (nftContract && signer) {
        try {
          const walletAddress = await signer.getAddress();
          const nftSelect = document.getElementById("punk-tokens-list");
          nftSelect.innerHTML = "";
          const balance = await nftContract.balanceOf(walletAddress);
          const count = balance.toNumber();
          for (let i = 0; i < count; i++) {
            const tokenId = await nftContract.tokenOfOwnerByIndex(walletAddress, i);
            const option = document.createElement("option");
            option.value = tokenId;
            option.innerText = "Token " + tokenId;
            nftSelect.appendChild(option);
          }
          displayOutput("Tokens cargados: " + count);
        } catch (error) {
          displayOutput("Error loading tokens: " + error.message);
        }
      } else {
        displayOutput("Por favor conecta tu wallet primero.");
      }
    });

    // Funcionalidades de escritura y lectura del contrato de staking

    // Stake Token
    document.getElementById("stake-token").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      if (!tokenId) return;
      try {
        const tx = await stakingContract.stake(tokenId);
        await tx.wait();
        displayOutput("Token " + tokenId + " staked successfully!");
      } catch (error) {
        displayOutput("Error staking token " + tokenId + ": " + error.message);
      }
    });

    // Claim Rewards
    document.getElementById("claim-rewards").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      if (!tokenId) return;
      try {
        const tx = await stakingContract.claimRewards(tokenId);
        await tx.wait();
        displayOutput("Rewards for token " + tokenId + " claimed successfully!");
      } catch (error) {
        displayOutput("Error claiming rewards for token " + tokenId + ": " + error.message);
      }
    });

    // Unstake Token
    document.getElementById("unstake-token").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      if (!tokenId) return;
      try {
        const tx = await stakingContract.unstake(tokenId);
        await tx.wait();
        displayOutput("Token " + tokenId + " unstaked successfully!");
      } catch (error) {
        displayOutput("Error unstaking token " + tokenId + ": " + error.message);
      }
    });

    // Ver Info de Staking
    document.getElementById("get-staking-info").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      if (!tokenId) return;
      try {
        const info = await stakingContract.getTokenStakingInfo(tokenId);
        let output = `Staking Info for token ${tokenId}:<br>`;
        output += `Stake Start: ${info[0].toString()}<br>`;
        output += `Last Claim: ${info[1].toString()}<br>`;
        output += `Fast Level Bonus: ${info[2].toString()}<br>`;
        output += `Item Bonus: ${info[3].toString()}<br>`;
        output += `Pending Reward: ${info[4].toString()}<br>`;
        displayOutput(output);
      } catch (error) {
        displayOutput("Error getting staking info for token " + tokenId + ": " + error.message);
      }
    });

    // Ver Pending Rewards
    document.getElementById("get-pending-rewards").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      if (!tokenId) return;
      try {
        const pending = await stakingContract.pendingRewards(tokenId);
        displayOutput("Pending rewards for token " + tokenId + ": " + pending.toString());
      } catch (error) {
        displayOutput("Error getting pending rewards for token " + tokenId + ": " + error.message);
      }
    });

    // Fast Level Upgrade
    document.getElementById("purchase-fast-level").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      if (!tokenId) return;
      try {
        const tx = await stakingContract.purchaseFastLevelUpgrade(tokenId);
        await tx.wait();
        displayOutput("Fast Level Upgrade purchased for token " + tokenId + " successfully!");
      } catch (error) {
        displayOutput("Error in Fast Level Upgrade for token " + tokenId + ": " + error.message);
      }
    });

    // Purchase Item Upgrade
    document.getElementById("purchase-item-upgrade").addEventListener("click", async () => {
      const tokenId = document.getElementById("punk-tokens-list").value;
      const itemId = document.getElementById("itemId").value;
      const quantity = document.getElementById("quantity").value;
      if (!tokenId || !itemId || !quantity) return;
      try {
        const tx = await stakingContract.purchaseItemUpgrade(tokenId, itemId, quantity);
        await tx.wait();
        displayOutput("Item Upgrade purchased for token " + tokenId + " successfully!");
      } catch (error) {
        displayOutput("Error purchasing item upgrade for token " + tokenId + ": " + error.message);
      }
    });
  </script>
</body>
</html>