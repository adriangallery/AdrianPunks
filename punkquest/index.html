<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Retro - Stake & Claim Rewards</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/market/styles.css">
  <style>
    /* Original PunkQuest visual styles */
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
      --scanline-color: rgba(0,0,0,0.03);
      --pixel-shadow: -1px -1px 0 var(--accent-red), 1px 1px 0 var(--accent-blue);
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      background-image: repeating-linear-gradient(0deg, var(--scanline-color), var(--scanline-color) 1px, transparent 1px, transparent 4px);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 0 1px var(--accent-red), 0 0 0 2px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, var(--card-bg) 0%, var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
      position: relative;
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1.5rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      padding: 1rem;
    }
    .token-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 200px;
    }
    .token-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .token-card img {
      width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 4px;
    }
    .selected-token {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px var(--accent-blue);
    }
    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.8rem 1.2rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0.5rem;
      box-shadow: 3px 3px 0 var(--primary-text);
    }
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0 var(--primary-text);
      border-color: var(--accent-blue);
    }
    .btn:active {
      transform: translate(2px, 2px);
      box-shadow: none;
      border-color: var(--accent-red);
    }
    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monos-serif;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin: 1rem 0;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    #total-rewards {
      font-size: 2.5rem;
      color: var(--primary-text);
      text-align: center;
      margin: 1rem 0;
      padding: 1rem;
      font-weight: 600;
    }
    .wallet-address {
      font-family: 'Space Mono', monos-serif;
      font-size: 0.9rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    @keyframes rewardsUpdate {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .rewards-update {
      animation: rewardsUpdate 0.5s ease;
    }
    /* end original PunkQuest CSS */

    /* Market-specific tweaks */
    #tokenBalance {
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      #tokenBalance {
        margin-top: 70px;
      }
      .card-title {
        font-size: 1rem;
        line-height: 1.2;
        margin-bottom: 0.25rem;
      }
      .nft-card .card-body {
        padding: 0.5rem;
      }
      .nft-card .card-text {
        font-size: 0.85rem;
      }
      .action-btn {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
      }
      .action-btn.dropdown-toggle::after {
        margin-left: 0.3rem;
      }
    }
    .modal-dialog {
      max-width: 500px;
    }
    .modal-body img {
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }
    .modal-backdrop {
      opacity: 0.5;
    }
    body.modal-open {
      overflow: auto !important;
      padding-right: 0 !important;
    }
    .offer-form {
      transition: all 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    .offer-form.hiding {
      opacity: 0;
      transform: translateY(-10px);
    }
    .modal-body {
      max-height: 80vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .trait-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      font-size: 0.9em;
      padding: 8px 12px;
    }
    .trait-categories {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .trait-category {
      margin-bottom: 1rem;
    }
    .trait-category-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
    }
    .trait-values {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
    }
    .trait-value-item button {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }
    #activeFilters {
      margin-bottom: 1rem;
    }
    #activeFilters .badge {
      font-size: 0.8rem;
      padding: 0.35rem 0.65rem;
    }
    #traitFilterMenu {
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest</h1>
      <p>Your journey begins here</p>
    </header>

    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <section id="total-rewards-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Total Pending Rewards</h2>
        <div id="total-rewards" class="big-number">0 A$</div>
      </div>
    </section>

    <section id="tokens-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Tokens</h2>
        <div id="tokens-grid" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3 token-grid"></div>
      </div>
    </section>

    <section id="token-stats" class="mb-4">
      <div class="card">
        <h2 class="section-title">Token Statistics</h2>
        <div id="individual-token-stats" class="terminal">Select one or more tokens to view detailed statistics.</div>
      </div>
    </section>

    <section id="stake-actions" class="mb-4">
      <div class="card">
        <h2 class="section-title">Actions</h2>
        <button id="stake-token" class="btn mb-3">Stake Token(s)</button>
        <button id="unstake-token" class="btn mb-3">Unstake Token(s)</button>
        <button id="claim-token" class="btn mb-3">Claim Rewards</button>
        <button id="refresh-info" class="btn mb-3">Refresh Stats</button>
        <div id="action-output" class="terminal"></div>
        <div id="fee-info" class="terminal"></div>
      </div>
    </section>

    <div id="general-output" class="terminal"></div>
  </div>

  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider, signer;
    let tokenContract, stakingContract, nftContract;
    let selectedTokenIds = [];
    let rewardsUpdateInterval;

    const AD_TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const AD_PUNKS_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const STAKING_ADDRESS = "0x64c46fca3f46442c7abd5303dc1c56a79f4e4273";

    // ABIs
    const tokenABI = [
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)",
      "function decimals() view returns (uint8)"
    ];
    const stakingABI = [
      "function activationFee() view returns (uint256)",
      "function exitFee() view returns (uint256)",
      "function batchStake(uint256[]) returns ()",
      "function batchUnstake(uint256[]) returns ()",
      "function batchClaimRewards(uint256[]) returns (uint256)"
    ];
    const nftABI = [
      "function balanceOf(address) view returns (uint256)",
      "function tokenOfOwnerByIndex(address,uint256) view returns (uint256)"
    ];

    // Helpers to format amounts
    function formatAmount(amount) {
      const value = parseFloat(ethers.utils.formatUnits(amount, 18));
      return value.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " $ADRIAN";
    }

    // Display fee info
    async function displayFeeInfo() {
      if (!stakingContract) return;
      try {
        const activationFee = await stakingContract.activationFee();
        const exitFee = await stakingContract.exitFee();
        document.getElementById('fee-info').textContent = `Stake Cost: ${formatAmount(activationFee)} | Unstake Cost: ${formatAmount(exitFee)}`;
      } catch (e) {
        document.getElementById('fee-info').textContent = "Error fetching fee info: " + e.message;
      }
    }

    // Load tokens with images from JSON
    async function loadTokens() {
      try {
        const walletAddress = await signer.getAddress();
        const response = await fetch('/punkquest/adrianpunks.json');
        const data = await response.json();
        const collection = data.collection;
        const balance = await nftContract.balanceOf(walletAddress);
        const count = balance.toNumber();
        const grid = document.getElementById('tokens-grid');
        grid.innerHTML = '';
        selectedTokenIds = [];
        for (let i = 0; i < count; i++) {
          const tokenId = (await nftContract.tokenOfOwnerByIndex(walletAddress, i)).toString();
          const tokenInfo = collection.find(item => {
            const parts = item.name?.split("#");
            return parts?.[1] === tokenId;
          });
          const imgSrc = tokenInfo ? tokenInfo.image : `https://via.placeholder.com/150?text=Token+${tokenId}`;
          const col = document.createElement('div'); col.className = 'col';
          const card = document.createElement('div'); card.className = 'card token-card'; card.dataset.tokenId = tokenId;
          const img = document.createElement('img'); img.src = imgSrc; img.alt = `Token ${tokenId}`;
          const label = document.createElement('div'); label.style.textAlign = 'center'; label.style.marginTop = '0.5rem'; label.textContent = `Token ${tokenId}`;
          card.append(img, label);
          card.addEventListener('click', () => {
            const id = card.dataset.tokenId;
            if (selectedTokenIds.includes(id)) {
              selectedTokenIds = selectedTokenIds.filter(x => x !== id);
              card.classList.remove('selected-token');
            } else {
              selectedTokenIds.push(id);
              card.classList.add('selected-token');
            }
            document.getElementById('action-output').textContent = 'Selected tokens: ' + selectedTokenIds.join(', ');
            displayFeeInfo();
          });
          col.appendChild(card);
          grid.appendChild(col);
        }
        displayAggregateRewards();
        displayFeeInfo();
      } catch (error) {
        document.getElementById('general-output').textContent = "Error loading tokens: " + error.message;
      }
    }

    // Display aggregate rewards (placeholder)
    async function displayAggregateRewards() {
      // Implement based on stakingContract details
    }

    // Función para mostrar mensajes
    function showMessage(message, type = 'info') {
      const messageDiv = document.getElementById('general-output');
      messageDiv.textContent = message;
      messageDiv.className = `message ${type}`;
      setTimeout(() => {
        messageDiv.textContent = '';
        messageDiv.className = 'message';
      }, 5000);
    }

    // Función para seleccionar/deseleccionar tokens
    function toggleTokenSelection(card) {
      card.classList.toggle('selected');
      updateSelectedTokensCount();
    }

    // Función para actualizar el contador de tokens seleccionados
    function updateSelectedTokensCount() {
      const selectedCount = document.querySelectorAll('.token-card.selected').length;
      const selectedTokensCount = document.getElementById('selected-tokens-count');
      if (selectedTokensCount) {
        selectedTokensCount.textContent = selectedCount;
      }
    }

    // Stake tokens in batch
    async function stakeTokens() {
      try {
        if (!window.ethereum) {
          throw new Error('MetaMask no está instalado');
        }

        const selectedCards = document.querySelectorAll('.token-card.selected');
        if (selectedCards.length === 0) {
          throw new Error('Por favor, selecciona al menos un token');
        }

        const selectedTokens = Array.from(selectedCards).map(card => parseInt(card.dataset.tokenId));
        const activationFee = await stakingContract.activationFee();
        const totalCost = activationFee.mul(selectedTokens.length);

        // Solicitar aprobación directamente
        const approveTx = await tokenContract.approve(
          stakingContract.address,
          totalCost,
          {
            customData: {
              title: "PunkQuest - Staking Approval",
              description: `Aprobando ${ethers.utils.formatEther(totalCost)} ADRIAN para staking de ${selectedTokens.length} tokens`
            }
          }
        );
        await approveTx.wait();

        // Ejecutar batchStake
        const stakeTx = await stakingContract.batchStake(selectedTokens, {
          customData: {
            title: "PunkQuest - Staking",
            description: `Staking ${selectedTokens.length} tokens`
          }
        });
        await stakeTx.wait();

        // Actualizar UI
        await loadTokens();
        await displayAggregateRewards();
        showMessage('Tokens staked exitosamente', 'success');
      } catch (error) {
        console.error('Error en stakeTokens:', error);
        showMessage(error.message || 'Error al hacer stake de los tokens', 'error');
      }
    }

    document.getElementById('connect-wallet').addEventListener('click', async () => {
      if (!window.ethereum) {
        document.getElementById('wallet-info').innerHTML = '<p>Please install MetaMask!</p>';
        return;
      }
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        tokenContract = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, signer);
        stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer);
        nftContract = new ethers.Contract(AD_PUNKS_ADDRESS, nftABI, signer);

        const address = await signer.getAddress();
        const shortAddr = address.substring(0,6) + '...' + address.slice(-4);
        const rawBalance = await tokenContract.balanceOf(address);
        const decimals = await tokenContract.decimals();
        const bal = parseFloat(ethers.utils.formatUnits(rawBalance, decimals)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('wallet-info').innerHTML = `<p class="wallet-address">Connected: ${shortAddr}</p><p class="wallet-address">Balance: ${bal} $ADRIAN</p>`;

        loadTokens();
        // Optionally start auto-update
        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged', () => location.reload());
      } catch (error) {
        document.getElementById('wallet-info').innerHTML = `<p>Error: ${error.message}</p>`;
      }
    });

    document.getElementById('stake-token').addEventListener('click', stakeTokens);
    document.getElementById('unstake-token').addEventListener('click', () => {
      // Implement batchUnstake similar to stakeTokens
    });
    document.getElementById('claim-token').addEventListener('click', () => {
      // Implement batchClaimRewards if desired
    });
    document.getElementById('refresh-info').addEventListener('click', () => {
      loadTokens();
    });
  </script>
</body>
</html>
