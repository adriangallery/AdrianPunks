<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Custom Styles -->
  <link rel="stylesheet" href="/market/styles/styles.css" />
  <!-- Inline CSS for theme variables and basic styles -->
  <style>
    :root {
      --bg-color-light: #ffffff;
      --text-color-light: #333333;
      --bg-color-dark: #121212;
      --text-color-dark: #f4f4f4;
      --primary-color: #f39c12;
      /* Additional variables for card, modal, etc. */
      --card-bg: #f8f9fa;
      --card-border: #f39c12;
    }

    body {
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
      font-family: "Share Tech Mono", monospace;
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark-theme {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }

    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Menu Component Container -->
  <div id="menu"></div>

  <div class="container my-4">
    <!-- Header Section -->
    <header class="text-center mb-4">
      <h1>Welcome to PunkQuest â€“ Unleash Your Inner Punk! ðŸš€</h1>
      <button id="theme-toggle" class="btn btn-secondary">Toggle Theme</button>
    </header>

    <!-- Wallet Connection Section -->
    <section class="mb-4">
      <button id="connect-wallet" class="btn btn-primary">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <!-- Featured NFT Section -->
    <section class="mb-4">
      <h2>Featured NFT</h2>
      <div id="featured-nft" class="card">
        <img id="nft-image" src="" alt="NFT Image" class="img-fluid" />
        <p id="nft-id" class="mt-2"></p>
      </div>
    </section>

    <!-- $ADRIAN Token Balance Section -->
    <section class="mb-4">
      <h2>$ADRIAN Token Balance</h2>
      <div id="token-balance" class="card">
        <p>Balance: <span id="adrian-balance">0</span></p>
      </div>
    </section>

    <!-- Floor Offer Section -->
    <section class="mb-4">
      <h2>Floor Offer</h2>
      <div id="floor-offer" class="card">
        <p>Coming soon... ðŸŽ‰</p>
      </div>
    </section>

    <!-- Project Information Section -->
    <section class="mb-4">
      <h2>About PunkQuest</h2>
      <div class="card">
        <p>
          PunkQuest is a decentralized application built on Ethereum, featuring unique NFTs, engaging tokenomics with $ADRIAN, and innovative staking functionalities. Join us and unleash your inner punk! ðŸŽ‰ðŸš€
        </p>
      </div>
    </section>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Dynamically Load the Menu Component (HTML and associated JS) -->
  <script>
    fetch('/market/components/menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('menu').innerHTML = html;
        // Dynamically load the menu interactions
        const menuScript = document.createElement('script');
        menuScript.src = '/market/components/menu.js';
        document.body.appendChild(menuScript);
      })
      .catch(err => console.error("Failed to load menu component:", err));
  </script>

  <!-- Inline Scripts for Theme Toggle, Wallet Connection, Contract Integration, and Dynamic Content Loading -->
  <script>
    // Theme Toggle Functionality
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
      localStorage.setItem('theme', theme);
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const currentTheme = localStorage.getItem('theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      applyTheme(newTheme);
    });

    // Apply theme preference on page load
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(savedTheme);
    });

    // Ethers.js Integration for Wallet Connection and Contract Setup
    let provider, signer;
    const connectWalletButton = document.getElementById('connect-wallet');
    const walletInfoDiv = document.getElementById('wallet-info');

    // Contract Addresses
    const AD_TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const AD_PUNKS_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const STAKING_ADDRESS = "0xeEC1A809acB57acABa196C6677f65EcC4c6f4491";

    // Minimal ABI for the token contract ($ADRIAN)
    const tokenABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    // ABI del contrato de staking de AdrianPunks (integrando las funciones del contrato)
    const stakingABI = [
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "stake",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "claimRewards",
        "outputs": [{"internalType": "uint256", "name": "rewardAmount", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "unstake",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "pendingRewards",
        "outputs": [{"internalType": "uint256", "name": "rewardAmount", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "purchaseFastLevelUpgrade",
        "outputs": [{"internalType": "uint256", "name": "bonusAdded", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
          {"internalType": "uint256", "name": "itemId", "type": "uint256"},
          {"internalType": "uint256", "name": "quantity", "type": "uint256"}
        ],
        "name": "purchaseItemUpgrade",
        "outputs": [{"internalType": "uint256", "name": "bonusAdded", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "getTokenStakingInfo",
        "outputs": [
          {"internalType": "uint256", "name": "stakeStart", "type": "uint256"},
          {"internalType": "uint256", "name": "lastClaim", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelBonus", "type": "uint256"},
          {"internalType": "uint256", "name": "itemBonus", "type": "uint256"},
          {"internalType": "uint256", "name": "pendingReward", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getBasicGamificationParameters",
        "outputs": [
          {"internalType": "uint256", "name": "activationFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "exitFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeBonusIncrement_", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getSocialStakingParameters",
        "outputs": [
          {"internalType": "uint256", "name": "socialMinTokens_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostBonus_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostDuration_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostActiveUntil_", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getLevelParameters",
        "outputs": [
          {"internalType": "uint256[]", "name": "thresholds", "type": "uint256[]"},
          {"internalType": "uint256[]", "name": "bonuses", "type": "uint256[]"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "itemId", "type": "uint256"}],
        "name": "getItem",
        "outputs": [
          {"internalType": "uint256", "name": "price", "type": "uint256"},
          {"internalType": "uint256", "name": "bonus", "type": "uint256"},
          {"internalType": "bool", "name": "exists", "type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // Contract Instances (will be initialized after wallet connection)
    let tokenContract, stakingContract;

    connectWalletButton.addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          walletInfoDiv.innerHTML = `<p>Wallet: ${walletAddress}</p>`;

          // Initialize token and staking contracts
          tokenContract = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, signer);
          stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer); // La direcciÃ³n del contrato de staking es configurable

          // Fetch $ADRIAN token balance and update UI
          const balance = await tokenContract.balanceOf(walletAddress);
          document.getElementById("adrian-balance").innerText = ethers.utils.formatUnits(balance, 18);
        } catch (err) {
          console.error("Wallet connection error:", err);
          walletInfoDiv.innerHTML = `<p style="color:red;">Connection failed. Please try again.</p>`;
        }
      } else {
        walletInfoDiv.innerHTML = `<p style="color:red;">Please install MetaMask!</p>`;
      }
    });

    // Dynamic Content Loading for NFT Data
    fetch("/punkquest/adrianpunks.json")
      .then((response) => response.json())
      .then((data) => {
        const collection = data.collection;
        if (collection && collection.length > 0) {
          // Randomly select one of the first five NFTs in the collection
          const randomIndex = Math.floor(Math.random() * Math.min(5, collection.length));
          const featuredNFT = collection[randomIndex];
          document.getElementById("nft-image").src = featuredNFT.image || "";
          document.getElementById("nft-id").innerText = `NFT ID: ${featuredNFT.id || "N/A"}`;
        }
      })
      .catch((err) => console.error("Error loading NFT data:", err));
  </script>
</body>
</html>