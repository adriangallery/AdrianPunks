<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Retro - Stake & Claim Rewards</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Fuentes modernas -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <!-- Estilos -->
  <style>
    :root {
      --bg-color: #f8f9fa;      /* Gris muy claro para el fondo */
      --primary-text: #2c3e50;  /* Azul oscuro grisáceo */
      --accent-red: #ff6b6b;    /* Rojo suave */
      --accent-blue: #4dabf7;   /* Azul suave */
      --card-bg: #ffffff;       /* Blanco para las tarjetas */
      --card-border: #e9ecef;   /* Gris muy claro para bordes */
      --screen-bg: #ffffff;     /* Blanco para el fondo principal */
      --scanline-color: rgba(0,0,0,0.03);
      --pixel-shadow: -1px -1px 0 var(--accent-red), 1px 1px 0 var(--accent-blue);
    }
    
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      background-image: 
        repeating-linear-gradient(0deg, 
          var(--scanline-color), 
          var(--scanline-color) 1px, 
          transparent 1px, 
          transparent 4px
        );
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 
        0 0 0 1px var(--accent-red),
        0 0 0 2px var(--accent-blue),
        0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, 
        var(--card-bg) 0%,
        var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
      position: relative;
    }

    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }

    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1.5rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1.5rem;
      padding: 1rem;
    }

    .token-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .token-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .token-card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }

    .selected-token {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px var(--accent-blue);
    }

    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.8rem 1.2rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0.5rem;
      position: relative;
      box-shadow: 
        3px 3px 0 var(--primary-text);
    }

    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0 var(--primary-text);
      border-color: var(--accent-blue);
    }

    .btn:active {
      transform: translate(2px, 2px);
      box-shadow: none;
      border-color: var(--accent-red);
    }

    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      position: relative;
      margin: 1rem 0;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    #total-rewards {
      font-size: 2.5rem;
      color: var(--primary-text);
      text-align: center;
      margin: 1rem 0;
      padding: 1rem;
      font-weight: 600;
    }

    /* Formato para dirección de wallet acortada */
    .wallet-address {
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
      color: var(--primary-text);
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      header h1 {
        font-size: 1.8rem;
      }

      .token-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .btn {
        width: 100%;
        margin: 0.5rem 0;
        font-size: 0.7rem;
        padding: 0.7rem;
      }

      #total-rewards {
        font-size: 1.8rem;
      }
    }

    @media (max-width: 375px) {
      header h1 {
        font-size: 1.4rem;
      }

      .token-grid {
        grid-template-columns: 1fr;
      }

      .btn {
        font-size: 0.6rem;
        padding: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sección de Encabezado -->
    <header>
      <h1>PunkQuest</h1>
      <p>Your journey begins here</p>
    </header>

    <!-- Sección de Conexión de Wallet -->
    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <!-- Sección "My Tokens" -->
    <section id="tokens-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Tokens</h2>
        <div id="tokens-grid" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3 token-grid">
          <!-- Los tokens se cargarán dinámicamente -->
        </div>
      </div>
    </section>

    <!-- Sección de Estadísticas de Tokens -->
    <section id="token-stats" class="mb-4">
      <div class="card">
        <h2 class="section-title">Token Statistics</h2>
        <div id="individual-token-stats" class="terminal">
          Select a token to view detailed statistics.
        </div>
      </div>
      <div class="card">
        <h2 class="section-title">Total Pending Rewards</h2>
        <div id="total-rewards" class="big-number">
          0 A$
        </div>
      </div>
    </section>

    <!-- Sección de Acciones -->
    <section id="stake-actions" class="mb-4">
      <div class="card">
        <h2 class="section-title">Actions</h2>
        <button id="stake-token" class="btn mb-3">Stake Token</button>
        <button id="refresh-info" class="btn mb-3">Refresh Stats</button>
        <div id="action-output" class="terminal"></div>
      </div>
    </section>

    <!-- Mensaje General -->
    <div id="general-output" class="terminal"></div>
  </div>

  <!-- Bootstrap 5 JS y Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // Variables globales para ethers.js y contratos
    let provider, signer;
    let tokenContract, stakingContract, nftContract;
    let selectedTokenId = null;

    // Direcciones de contratos
    const AD_TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const AD_PUNKS_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const STAKING_ADDRESS = "0xeEC1A809acB57acABa196C6677f65EcC4c6f4491";

    // ABI mínimos
    const tokenABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
    const nftABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
      "function tokenURI(uint256 tokenId) view returns (string)"
    ];
    const stakingABI = [
      "function stake(uint256 tokenId) external",
      "function claimRewards(uint256 tokenId) external returns (uint256)",
      "function unstake(uint256 tokenId) external",
      "function pendingRewards(uint256 tokenId) view returns (uint256)",
      "function getTokenDetailedInfo(uint256 tokenId) view returns (uint256, uint256, uint256, uint256, uint256, int256, uint256)",
      "function getBasicGamificationParameters() view returns (uint256, uint256, uint256, uint256)",
      "function getGlobalStats() view returns (uint256, uint256, uint256, uint256, uint256)"
    ];

    // Funciones helper para formatear montos
    function formatAmount(amount) {
      const value = parseFloat(ethers.utils.formatUnits(amount, 18));
      return value.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " $A";
    }
    function formatReward(amount) {
      const value = parseFloat(ethers.utils.formatUnits(amount, 18));
      return value.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 }) + " A$";
    }

    // Carga los tokens y muestra la grilla
    async function loadTokens() {
      try {
        const walletAddress = await signer.getAddress();
        // Se puede usar JSON para más detalles de los tokens
        const response = await fetch("/punkquest/adrianpunks.json");
        const data = await response.json();
        const jsonCollection = data.collection;
        const balance = await nftContract.balanceOf(walletAddress);
        const count = balance.toNumber();
        const gridContainer = document.getElementById("tokens-grid");
        gridContainer.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const tokenId = (await nftContract.tokenOfOwnerByIndex(walletAddress, i)).toString();
          const tokenInfo = jsonCollection.find(item => {
            if (item.name) {
              const parts = item.name.split("#");
              return parts.length === 2 && parts[1] === tokenId;
            }
            return false;
          });
          const imgSrc = tokenInfo ? tokenInfo.image : `https://via.placeholder.com/150?text=Token+${tokenId}`;
          const col = document.createElement("div");
          col.className = "col";
          const card = document.createElement("div");
          card.className = "card token-card";
          card.dataset.tokenId = tokenId;
          const img = document.createElement("img");
          img.src = imgSrc;
          img.alt = "Token " + tokenId;
          const overlay = document.createElement("div");
          overlay.style.textAlign = "center";
          overlay.style.marginTop = "0.5rem";
          overlay.textContent = "Token " + tokenId;
          card.appendChild(img);
          card.appendChild(overlay);
          col.appendChild(card);
          gridContainer.appendChild(col);
          // Al hacer clic se selecciona el token y se refrescan las estadísticas
          card.addEventListener("click", () => {
            document.querySelectorAll(".token-card").forEach(el => el.classList.remove("selected-token"));
            card.classList.add("selected-token");
            selectedTokenId = tokenId;
            document.getElementById("action-output").textContent = "Token seleccionado: " + selectedTokenId;
            refreshTokenStats();
          });
        }
        loadAggregateRewards();
      } catch (error) {
        document.getElementById("general-output").textContent = "Error al cargar tokens: " + error.message;
      }
    }

    // Refresca estadísticas para el token seleccionado usando getTokenDetailedInfo
    async function refreshTokenStats() {
      if (!selectedTokenId) return alert("Por favor, selecciona un token primero.");
      try {
        const info = await stakingContract.getTokenDetailedInfo(selectedTokenId);
        // info: (stakeStart, lastClaim, fastLevelBonus, itemBonus, specialBoost, fixedAdjustment, pendingReward)
        const stakeStart = new Date(info[0] * 1000).toLocaleString();
        const lastClaim = new Date(info[1] * 1000).toLocaleString();
        const fastLevelBonus = ethers.utils.formatUnits(info[2], 18);
        const itemBonus = ethers.utils.formatUnits(info[3], 18);
        const specialBoost = ethers.utils.formatUnits(info[4], 18);
        const fixedAdjustment = info[5].toString();
        const pendingReward = formatReward(info[6]);
        const statsHTML = `
          <strong>Token ${selectedTokenId}:</strong><br>
          Stake iniciado: ${stakeStart}<br>
          Último claim: ${lastClaim}<br>
          Bonificación Fast Level: ${fastLevelBonus}<br>
          Bonificación por ítems: ${itemBonus}<br>
          Boost especial: ${specialBoost}<br>
          Ajuste fijo: ${fixedAdjustment}<br><br>
          <span style="font-size:2rem; color: var(--accent);">
            Rewards Pendientes: ${pendingReward}
          </span>
        `;
        document.getElementById("individual-token-stats").innerHTML = statsHTML;
      } catch (error) {
        document.getElementById("individual-token-stats").textContent = "Error: " + error.message;
      }
    }

    // Calcula el total de rewards pendientes de todos los tokens en la wallet
    async function loadAggregateRewards() {
      try {
        const walletAddress = await signer.getAddress();
        const balance = await nftContract.balanceOf(walletAddress);
        const count = balance.toNumber();
        let totalRewards = ethers.BigNumber.from(0);
        for (let i = 0; i < count; i++) {
          const tokenId = (await nftContract.tokenOfOwnerByIndex(walletAddress, i)).toString();
          try {
            const info = await stakingContract.getTokenDetailedInfo(tokenId);
            // pendingReward es info[6]
            totalRewards = totalRewards.add(info[6]);
          } catch (e) {
            console.error("Error al obtener estadísticas del token " + tokenId + ": " + e.message);
          }
        }
        document.getElementById("total-rewards").textContent = formatReward(totalRewards);
      } catch (error) {
        document.getElementById("general-output").textContent = "Error al calcular rewards totales: " + error.message;
      }
    }

    // Conexión de Wallet e inicialización de contratos
    document.getElementById("connect-wallet").addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          // Formatear la dirección de la wallet
          const shortAddress = walletAddress.substring(0, 6) + '...' + walletAddress.substring(walletAddress.length - 4);
          document.getElementById("wallet-info").innerHTML = '<p class="wallet-address">Connected: ' + shortAddress + '</p>';
          
          tokenContract = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, signer);
          stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer);
          nftContract = new ethers.Contract(AD_PUNKS_ADDRESS, nftABI, signer);
          
          // Cargar tokens y estadísticas
          loadTokens();
        } catch (error) {
          document.getElementById("wallet-info").innerHTML = "<p>Error connecting wallet: " + error.message + "</p>";
        }
      } else {
        document.getElementById("wallet-info").innerHTML = "<p>Please install MetaMask!</p>";
      }
    });

    // Función para hacer stake del token seleccionado
    document.getElementById("stake-token").addEventListener("click", async () => {
      if (!selectedTokenId) return alert("Por favor, selecciona un token primero.");
      try {
        const walletAddress = await signer.getAddress();
        const params = await stakingContract.getBasicGamificationParameters();
        const activationFee = params[0];
        const currentAllowance = await tokenContract.allowance(walletAddress, STAKING_ADDRESS);
        if (currentAllowance.lt(activationFee)) {
          document.getElementById("general-output").innerHTML = "Aprobando gasto para fee de staking. Espera...";
          const approveTx = await tokenContract.approve(STAKING_ADDRESS, activationFee);
          await approveTx.wait();
          document.getElementById("general-output").innerHTML = "Aprobación exitosa. Procediendo con el staking...";
        }
        const tx = await stakingContract.stake(selectedTokenId);
        await tx.wait();
        document.getElementById("general-output").innerHTML = "Token " + selectedTokenId + " staked successfully.";
        refreshTokenStats();
        loadAggregateRewards();
      } catch (error) {
        document.getElementById("general-output").innerHTML = "Error al hacer stake: " + error.message;
      }
    });

    // Actualiza estadísticas al presionar el botón de refresco
    document.getElementById("refresh-info").addEventListener("click", () => {
      if (selectedTokenId) {
        refreshTokenStats();
      }
      loadAggregateRewards();
    });
  </script>
</body>
</html>