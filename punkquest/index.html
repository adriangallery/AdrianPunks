<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Retro - Stake & Claim Rewards</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Modern fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
      --scanline-color: rgba(0,0,0,0.03);
      --pixel-shadow: -1px -1px 0 var(--accent-red), 1px 1px 0 var(--accent-blue);
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      background-image: repeating-linear-gradient(0deg, var(--scanline-color), var(--scanline-color) 1px, transparent 1px, transparent 4px);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 0 1px var(--accent-red), 0 0 0 2px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, var(--card-bg) 0%, var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1.5rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      padding: 1rem;
    }
    .token-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 200px;
    }
    .token-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .token-card img {
      width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 4px;
    }
    .selected-token {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px var(--accent-blue);
    }
    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.8rem 1.2rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0.5rem;
      box-shadow: 3px 3px 0 var(--primary-text);
    }
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0 var(--primary-text);
      border-color: var(--accent-blue);
    }
    .btn:active {
      transform: translate(2px, 2px);
      box-shadow: none;
      border-color: var(--accent-red);
    }
    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monos-serif;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin: 1rem 0;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    #total-rewards {
      font-size: 2.5rem;
      color: var(--primary-text);
      text-align: center;
      margin: 1rem 0;
      padding: 1rem;
      font-weight: 600;
    }
    .wallet-address {
      font-family: 'Space Mono', monos-serif;
      font-size: 0.9rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    @keyframes rewardsUpdate {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .rewards-update {
      animation: rewardsUpdate 0.5s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest</h1>
      <p>Your journey begins here</p>
    </header>

    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <section id="total-rewards-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Total Pending Rewards</h2>
        <div id="total-rewards" class="big-number">0 A$</div>
      </div>
    </section>

    <section id="tokens-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Tokens</h2>
        <div id="tokens-grid" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3 token-grid"></div>
      </div>
    </section>

    <section id="token-stats" class="mb-4">
      <div class="card">
        <h2 class="section-title">Token Statistics</h2>
        <div id="individual-token-stats" class="terminal">Select one or more tokens to view detailed statistics.</div>
      </div>
    </section>

    <section id="stake-actions" class="mb-4">
      <div class="card">
        <h2 class="section-title">Actions</h2>
        <button id="stake-token" class="btn mb-3">Stake Token(s)</button>
        <button id="unstake-token" class="btn mb-3">Unstake Token(s)</button>
        <button id="claim-token" class="btn mb-3">Claim Rewards</button>
        <button id="refresh-info" class="btn mb-3">Refresh Stats</button>
        <div id="action-output" class="terminal"></div>
        <div id="fee-info" class="terminal"></div>
      </div>
    </section>

    <div id="general-output" class="terminal"></div>
  </div>

  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // RPC solo lectura (Infura Key)
    const readProvider = new ethers.providers.JsonRpcProvider('https://mainnet.infura.io/v3/YOUR_INFURA_KEY');
    let web3Provider, signer;

    // Contratos
    const AD_TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const AD_PUNKS_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const STAKING_ADDRESS  = "0x64c46fca3f46442c7abd5303dc1c56a79f4e4273";

    // ABIs
    const tokenABI = [
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function name() view returns (string)"
    ];
    const stakingABI = [
      "function activationFee() view returns (uint256)",
      "function exitFee() view returns (uint256)",
      "function claimFee() view returns (uint256)",
      "function batchStake(uint256[] calldata) external",
      "function batchUnstake(uint256[] calldata) external",
      "function batchClaimRewards(uint256[] calldata) external returns (uint256)",
      "function stakes(uint256) view returns (uint256 stakeStart, uint256 lastClaim),",
      "function tokenFastLevelBonus(uint256) view returns (uint256)",
      "function tokenItemsBonus(uint256) view returns (uint256)",
      "function specialTokenBoost(uint256) view returns (uint256)",
      "function tokenFixedAdjustment(uint256) view returns (int256)"
    ];
    const nftABI = [
      "function balanceOf(address) view returns (uint256)",
      "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
    ];

    // Contratos de lectura
    const readTokenContract   = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, readProvider);
    const readStakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, readProvider);

    // Contratos de escritura (MetaMask)
    let tokenContract, stakingContract, nftContract;
    let selectedTokenIds = [];

    // Funciones utilitarias
    function formatAmount(amount) {
      return parseFloat(ethers.utils.formatUnits(amount, 18))
        .toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    }
    function showMessage(msg, type = 'info') {
      const out = document.getElementById('general-output');
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.color = type === 'error'
        ? 'var(--accent-red)'
        : type === 'success'
          ? 'var(--accent-blue)'
          : 'var(--primary-text)';
    }

    async function connectWallet() {
      try {
        if (typeof web3Provider === 'undefined') {
          web3Provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = web3Provider.getSigner();
          tokenContract = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, signer);
          stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer);
          nftContract = new ethers.Contract(AD_PUNKS_ADDRESS, nftABI, signer);
          await updateWalletInfo();
          await updateTokens();
          await updateTotalRewards();
          document.getElementById('connect-wallet').textContent = 'Wallet Connected';
        }
      } catch (error) {
        console.error('Error connecting to wallet:', error);
        showMessage('Error connecting to wallet', 'error');
      }
    }

    async function updateWalletInfo() {
      try {
        const balance = await signer.getBalance();
        const formattedBalance = formatAmount(balance);
        document.getElementById('wallet-info').textContent = `Balance: ${formattedBalance} A$`;
      } catch (error) {
        console.error('Error getting wallet balance:', error);
        showMessage('Error getting wallet balance', 'error');
      }
    }

    async function updateTokens() {
      try {
        const totalTokens = await tokenContract.balanceOf(signer.address);
        const tokens = [];
        for (let i = 0; i < totalTokens; i++) {
          const tokenId = await tokenContract.tokenOfOwnerByIndex(signer.address, i);
          tokens.push(tokenId.toString());
        }
        displayTokens(tokens);
      } catch (error) {
        console.error('Error getting tokens:', error);
        showMessage('Error getting tokens', 'error');
      }
    }

    async function updateTotalRewards() {
      try {
        const totalRewards = await readStakingContract.stakes(signer.address);
        const formattedRewards = formatAmount(totalRewards.totalRewards);
        document.getElementById('total-rewards').textContent = formattedRewards;
      } catch (error) {
        console.error('Error getting total rewards:', error);
        showMessage('Error getting total rewards', 'error');
      }
    }

    function displayTokens(tokens) {
      const tokenGrid = document.getElementById('tokens-grid');
      tokenGrid.innerHTML = '';
      tokens.forEach(tokenId => {
        const tokenCard = document.createElement('div');
        tokenCard.className = 'token-card';
        tokenCard.innerHTML = `
          <img src="https://ipfs.io/ipfs/QmNrhZHUaEqxhyLfqoq1mtHSipkWHeT31LNHb1QEbDHgncaI/QmNrhZHUaEqxhyLfqoq1mtHSipkWHeT31LNHb1QEbDHgncaI.png" alt="Token ${tokenId}">
          <p>${tokenId}</p>
        `;
        tokenCard.onclick = () => {
          if (selectedTokenIds.includes(tokenId)) {
            selectedTokenIds = selectedTokenIds.filter(id => id !== tokenId);
            tokenCard.classList.remove('selected-token');
          } else {
            selectedTokenIds.push(tokenId);
            tokenCard.classList.add('selected-token');
          }
        };
        tokenGrid.appendChild(tokenCard);
      });
    }

    async function stakeTokens() {
      try {
        const totalFee = await stakingContract.activationFee();
        const approveTx = await tokenContract.approve(
          STAKING_ADDRESS,
          totalFee,
          {
            gasLimit: 100000
          }
        );
        const stakeTx = await stakingContract.batchStake(selectedTokenIds, {
          gasLimit: 300000
        });
        await approveTx.wait();
        await stakeTx.wait();
        showMessage('Tokens staked successfully', 'success');
        await updateTotalRewards();
      } catch (error) {
        console.error('Error staking tokens:', error);
        showMessage('Error staking tokens', 'error');
      }
    }

    async function unstakeTokens() {
      try {
        const totalFee = await stakingContract.exitFee();
        const approveTx = await tokenContract.approve(
          STAKING_ADDRESS,
          totalFee,
          {
            gasLimit: 100000
          }
        );
        const unstakeTx = await stakingContract.batchUnstake(selectedTokenIds, {
          gasLimit: 300000
        });
        await approveTx.wait();
        await unstakeTx.wait();
        showMessage('Tokens unstaked successfully', 'success');
        await updateTotalRewards();
      } catch (error) {
        console.error('Error unstaking tokens:', error);
        showMessage('Error unstaking tokens', 'error');
      }
    }

    async function claimRewards() {
      try {
        const totalFee = await stakingContract.claimFee();
        const approveTx = await tokenContract.approve(
          STAKING_ADDRESS,
          totalFee,
          {
            gasLimit: 100000
          }
        );
        const claimTx = await stakingContract.batchClaimRewards(selectedTokenIds, {
          gasLimit: 300000
        });
        await approveTx.wait();
        await claimTx.wait();
        showMessage('Rewards claimed successfully', 'success');
        await updateTotalRewards();
      } catch (error) {
        console.error('Error claiming rewards:', error);
        showMessage('Error claiming rewards', 'error');
      }
    }

    document.getElementById('connect-wallet').onclick = connectWallet;
    document.getElementById('stake-token').onclick = stakeTokens;
    document.getElementById('unstake-token').onclick = unstakeTokens;
    document.getElementById('claim-token').onclick = claimRewards;
    document.getElementById('refresh-info').onclick = updateTotalRewards;
  </script>
</body>
</html>
