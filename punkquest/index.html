<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Retro - Stake & Claim Rewards</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/market/styles.css">
  <style>
    /* Original PunkQuest visual styles */
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
      --scanline-color: rgba(0,0,0,0.03);
      --pixel-shadow: -1px -1px 0 var(--accent-red), 1px 1px 0 var(--accent-blue);
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      background-image: repeating-linear-gradient(0deg, var(--scanline-color), var(--scanline-color) 1px, transparent 1px, transparent 4px);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 0 1px var(--accent-red), 0 0 0 2px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, var(--card-bg) 0%, var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1.5rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    /* end original PunkQuest CSS */

    /* Market-specific tweaks */
    #tokenBalance {
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      #tokenBalance {
        margin-top: 70px;
      }
      .card-title {
        font-size: 1rem;
        line-height: 1.2;
        margin-bottom: 0.25rem;
      }
      .nft-card .card-body {
        padding: 0.5rem;
      }
      .nft-card .card-text {
        font-size: 0.85rem;
      }
      .action-btn {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
      }
      .action-btn.dropdown-toggle::after {
        margin-left: 0.3rem;
      }
    }
    .modal-dialog {
      max-width: 500px;
    }
    .modal-body img {
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }
    .modal-backdrop {
      opacity: 0.5;
    }
    body.modal-open {
      overflow: auto !important;
      padding-right: 0 !important;
    }
    .offer-form {
      transition: all 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    .offer-form.hiding {
      opacity: 0;
      transform: translateY(-10px);
    }
    .modal-body {
      max-height: 80vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .trait-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      font-size: 0.9em;
      padding: 8px 12px;
    }
    .trait-categories {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .trait-category {
      margin-bottom: 1rem;
    }
    .trait-category-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
    }
    .trait-values {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
    }
    .trait-value-item button {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }
    #activeFilters {
      margin-bottom: 1rem;
    }
    #activeFilters .badge {
      font-size: 0.8rem;
      padding: 0.35rem 0.65rem;
    }
    #traitFilterMenu {
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest</h1>
      <p>Your journey begins here</p>
    </header>

    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <section id="total-rewards-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Total Pending Rewards</h2>
        <div id="total-rewards" class="big-number">0 A$</div>
      </div>
    </section>

    <section id="tokens-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Tokens</h2>
        <div id="tokens-grid" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3 token-grid"></div>
      </div>
    </section>

    <section id="token-stats" class="mb-4">
      <div class="card">
        <h2 class="section-title">Token Statistics</h2>
        <div id="individual-token-stats" class="terminal">Select one or more tokens to view detailed statistics.</div>
      </div>
    </section>

    <section id="stake-actions" class="mb-4">
      <div class="card">
        <h2 class="section-title">Actions</h2>
        <button id="stake-token" class="btn mb-3">Stake Token(s)</button>
        <button id="unstake-token" class="btn mb-3">Unstake Token(s)</button>
        <button id="claim-token" class="btn mb-3">Claim Rewards</button>
        <button id="refresh-info" class="btn mb-3">Refresh Stats</button>
        <div id="action-output" class="terminal"></div>
        <div id="fee-info" class="terminal"></div>
      </div>
    </section>

    <div id="general-output" class="terminal"></div>
  </div>

  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let web3Provider, signer;
    let tokenContract, stakingContract, nftContract;
    let selectedTokenIds = [];

    // Contratos
    const AD_TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const AD_PUNKS_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const STAKING_ADDRESS  = "0x64c46fca3f46442c7abd5303dc1c56a79f4e4273";

    // ABIs
    const tokenABI = [
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function name() view returns (string)"
    ];
    const stakingABI = [
      "function activationFee() view returns (uint256)",
      "function exitFee() view returns (uint256)",
      "function claimFee() view returns (uint256)",
      "function batchStake(uint256[]) returns ()",
      "function batchUnstake(uint256[]) returns ()",
      "function batchClaimRewards(uint256[]) returns (uint256)",
      "function stakes(uint256) view returns (uint256,uint256)",
      "function totalStaked() view returns (uint256)"
    ];
    const nftABI = [
      "function balanceOf(address) view returns (uint256)",
      "function tokenOfOwnerByIndex(address,uint256) view returns (uint256)",
      "function ownerOf(uint256) view returns (address)"
    ];

    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          showMessage('Please install MetaMask to use this application', 'error');
          return;
        }

        // Solicitar conexión a la wallet
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        // Inicializar el provider y el signer
        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = web3Provider.getSigner();
        
        // Inicializar los contratos
        tokenContract = new ethers.Contract(AD_TOKEN_ADDRESS, tokenABI, signer);
        stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer);
        nftContract = new ethers.Contract(AD_PUNKS_ADDRESS, nftABI, signer);

        // Actualizar la información de la wallet
        await updateWalletInfo();
        await updateTokens();
        await updateTotalRewards();
        
        // Actualizar el botón de conexión
        document.getElementById('connect-wallet').textContent = 'Wallet Connected';
        document.getElementById('connect-wallet').disabled = true;

        // Escuchar cambios en la cuenta
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);

      } catch (error) {
        console.error('Error connecting to wallet:', error);
        showMessage('Error connecting to wallet: ' + error.message, 'error');
      }
    }

    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        // Wallet desconectada
        document.getElementById('connect-wallet').textContent = 'Connect Wallet';
        document.getElementById('connect-wallet').disabled = false;
        document.getElementById('wallet-info').textContent = '';
        document.getElementById('total-rewards').textContent = '0 A$';
        document.getElementById('tokens-grid').innerHTML = '';
      } else {
        // Actualizar la información con la nueva cuenta
        updateWalletInfo();
        updateTokens();
        updateTotalRewards();
      }
    }

    function handleChainChanged(chainId) {
      // Recargar la página cuando cambie la red
      window.location.reload();
    }

    async function updateWalletInfo() {
      try {
        const balance = await signer.getBalance();
        const formattedBalance = ethers.utils.formatEther(balance);
        document.getElementById('wallet-info').textContent = `Balance: ${formattedBalance} ETH`;
      } catch (error) {
        console.error('Error getting wallet balance:', error);
        showMessage('Error getting wallet balance', 'error');
      }
    }

    async function updateTokens() {
      try {
        const balance = await nftContract.balanceOf(await signer.getAddress());
        const tokens = [];
        for (let i = 0; i < balance.toNumber(); i++) {
          const tokenId = await nftContract.tokenOfOwnerByIndex(await signer.getAddress(), i);
          tokens.push(tokenId.toString());
        }
        displayTokens(tokens);
      } catch (error) {
        console.error('Error getting tokens:', error);
        showMessage('Error getting tokens', 'error');
      }
    }

    async function updateTotalRewards() {
      try {
        let totalRewards = ethers.BigNumber.from(0);
        const balance = await nftContract.balanceOf(await signer.getAddress());
        
        for (let i = 0; i < balance.toNumber(); i++) {
          const tokenId = await nftContract.tokenOfOwnerByIndex(await signer.getAddress(), i);
          const stakeInfo = await stakingContract.stakes(tokenId);
          if (stakeInfo[0].gt(0)) { // Si está staked
            const rewards = await stakingContract.batchClaimRewards([tokenId]);
            totalRewards = totalRewards.add(rewards);
          }
        }
        
        const formattedRewards = ethers.utils.formatEther(totalRewards);
        document.getElementById('total-rewards').textContent = `${formattedRewards} A$`;
      } catch (error) {
        console.error('Error getting total rewards:', error);
        showMessage('Error getting total rewards', 'error');
      }
    }

    function displayTokens(tokens) {
      const tokenGrid = document.getElementById('tokens-grid');
      tokenGrid.innerHTML = '';
      tokens.forEach(tokenId => {
        const tokenCard = document.createElement('div');
        tokenCard.className = 'col token-card';
        tokenCard.innerHTML = `
          <div class="card h-100">
            <img src="https://ipfs.io/ipfs/QmNrhZHUaEqxhyLfqoq1mtHSipkWHeT31LNHb1QEbDHgncaI/QmNrhZHUaEqxhyLfqoq1mtHSipkWHeT31LNHb1QEbDHgncaI.png" 
                 class="card-img-top" alt="Token ${tokenId}">
            <div class="card-body">
              <h5 class="card-title">Token #${tokenId}</h5>
            </div>
          </div>
        `;
        tokenCard.onclick = () => {
          if (selectedTokenIds.includes(tokenId)) {
            selectedTokenIds = selectedTokenIds.filter(id => id !== tokenId);
            tokenCard.classList.remove('selected-token');
          } else {
            selectedTokenIds.push(tokenId);
            tokenCard.classList.add('selected-token');
          }
          updateTokenStats();
        };
        tokenGrid.appendChild(tokenCard);
      });
    }

    function updateTokenStats() {
      const statsDiv = document.getElementById('individual-token-stats');
      if (selectedTokenIds.length === 0) {
        statsDiv.textContent = 'Select one or more tokens to view detailed statistics.';
        return;
      }
      statsDiv.textContent = `Selected ${selectedTokenIds.length} token(s)`;
    }

    function showMessage(message, type = 'info') {
      const output = document.getElementById('action-output');
      output.textContent = message;
      output.className = `terminal ${type}`;
    }

    // Asignar eventos a los botones
    document.getElementById('connect-wallet').onclick = connectWallet;
    document.getElementById('stake-token').onclick = stakeTokens;
    document.getElementById('unstake-token').onclick = unstakeTokens;
    document.getElementById('claim-token').onclick = claimRewards;
    document.getElementById('refresh-info').onclick = updateTotalRewards;
  </script>
</body>
</html>
