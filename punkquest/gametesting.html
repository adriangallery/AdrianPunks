<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punk Quest DApp</title>

  <!-- --- CSS frameworks & fonts --- -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap">

  <!-- Global style placeholder — Section 12 will be pasted here -->
  <style id="GLOBAL-STYLES"></style>
</head>

<body class="bg-dark text-light" style="font-family:'Share Tech Mono', monospace;">
  <!-- Menu placeholder — Section 3 will inject HTML here -->
  <nav id="MAIN-MENU"></nav>

  <!-- Router outlet where each screen template mounts -->
  <main id="APP" class="container py-4"></main>

  <!-- Global scripts placeholder — every JS section is concatenated below -->
  <script id="GLOBAL-SCRIPTS"></script>

  <!-- Ethers (UMD build) for provider / signer utilities -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- ───────── SECTION 2: PUNK QUEST CONFIG ───────── -->
  <script id="PQ-CONFIG">
  /*  Replace ALL "0x…" placeholders and YOUR_INFURA_KEY_HERE
      with your real addresses / keys before deploying.          */

  (() => {
    /* Core ABIs – only the functions/events we actually call */
    const PUNK_QUEST_ABI = [
      // staking & rewards
      "function stake(uint256 id)",
      "function batchStake(uint256[] ids)",
      "function claimRewards(uint256 id) returns (uint256)",
      "function batchClaimRewards(uint256[] ids) returns (uint256)",
      "function unstake(uint256 id)",
      "function batchUnstake(uint256[] ids)",
      "function purchaseFastLevelUpgrade(uint256 id)",
      // views
      "function pendingPassiveReward(uint256 id) view returns (uint256)",
      "function pendingGameReward(uint256 id) view returns (uint256)",
      "function pendingTotalReward(uint256 id) view returns (uint256)",
      "function getTokenStats(uint256 id) view returns (uint256 passive,uint256 game)",
      "function getWalletStats(address w,uint256[] tokenIds) view returns (uint256[] stakedIds,uint256 pendingPassive,uint256 pendingGame)",
      "function getGlobalStats() view returns (uint256 staked,uint256 base,uint256 socialEnd)",
      // store / armory (templates + instances)
      "function buyItem(uint256 id,uint256 qty)",
      "function batchBuyItems(uint256[] ids,uint256[] qtys)",
      "function equipItem(uint256 tokenId,uint256 itemId)",
      "function equipItemInstance(uint256 tokenId,uint256 instId)",
      "function equipExtraItemInstance(uint256 tokenId,uint256 instId)",
      "function batchArmoryActionsInstances(uint256[] tokenIds,uint8[] acts,uint256[] insts,uint256[] idxs)",
      "function purchaseExtraSlots(uint256 tokenId,uint256 qty)",
      "function repairItem(uint256 inst,uint256 tokenId)",
      // detail helpers
      "function getTokenArmoryDetails(uint256 id) view returns (uint256 weapon,uint256 armor,uint256[] extras,uint256 lastEvent)"
    ];

    const PUNK_NFT_ABI = [
      "function ownerOf(uint256 tokenId) view returns (address)"
    ];

    const ERC20_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    /* Enumeration helpers for quick look-ups in Armory UI */
    const ENUMS = {
      ArmoryActionType:        { EquipDefault: 0, EquipExtra: 1, UnequipExtra: 2, UnequipAll: 3 },
      AdvancedArmoryActionType:{ EquipDefault: 0, EquipExtra: 1, UnequipExtra: 2, UnequipAll: 3 }
    };

    /* Public, mutable DApp-wide config object */
    window.PQ_CONFIG = {
      /* ── network ── */
      chainId:        1,                         // 1 = Ethereum Mainnet
      chainName:      "Ethereum Mainnet",
      rpcViaInfura:   "https://mainnet.infura.io/v3/YOUR_INFURA_KEY_HERE",
      explorer:       "https://etherscan.io",
      nativeCurrency: { name:"Ether", symbol:"ETH", decimals:18 },

      /* ── contracts ── */
      contracts: {
        punkQuest: {
          address: "0xPUNKQUEST_ADDRESS",
          abi:     PUNK_QUEST_ABI
        },
        punkNFT: {
          address: "0xPUNK_NFT_ADDRESS",
          abi:     PUNK_NFT_ABI
        },
        rewardToken: {
          address: "0xREWARD_TOKEN_ADDRESS",
          abi:     ERC20_ABI
        }
      },

      /* ── ui helpers ── */
      enums: ENUMS,

      /* ── misc constants ── */
      gasLimitBuffer: 1.15                       // add 15 % head-room to estimated gas
    };
  })();
  </script>
  <!-- ───────── END SECTION 2 ───────── -->

  <!-- ───────── SECTION 3: MENU & ROUTER ───────── -->
  <!-- 1️⃣  Template that renders the top navigation bar -->
  <template id="TEMPLATE-MENU">
    <nav class="navbar navbar-expand-lg navbar-dark bg-secondary shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#/dashboard">PunkQuest</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#pqNav" aria-controls="pqNav" aria-expanded="false"
                aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="pqNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="#/dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="#/store">Store</a></li>
            <li class="nav-item"><a class="nav-link" href="#/armory">Armory</a></li>
            <li class="nav-item"><a class="nav-link" href="#/events">Events</a></li>
            <li class="nav-item"><a class="nav-link" href="#/stats">Stats</a></li>
          </ul>

          <!-- Connect / account button -->
          <button id="btn-connect" class="btn btn-outline-light">Connect Wallet</button>
        </div>
      </div>
    </nav>
  </template>

  <!-- 2️⃣  Router + menu bootstrapper -->
  <script id="PQ-ROUTER">
  (() => {
    /* ----- Inject the nav bar into #MAIN-MENU ----- */
    const menuClone = document.getElementById('TEMPLATE-MENU').content.cloneNode(true);
    document.getElementById('MAIN-MENU').replaceWith(menuClone);

    /* ----- Basic wallet-connect stub (Section 4 will override) ----- */
    const connectBtn = document.getElementById('btn-connect');
    connectBtn.addEventListener('click', async () => {
      if (window.PQ_WALLET?.connect) {
        return window.PQ_WALLET.connect();
      }
      if (window.ethereum?.request) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
        } catch (err) {
          alert(err.message || err);
        }
      } else {
        alert('MetaMask (or a compatible wallet) isn't detected.');
      }
    });

    /* ----- Hash-based router ----- */
    const SCREENS = {
      dashboard : 'screen-dashboard',
      store     : 'screen-store',
      armory    : 'screen-armory',
      events    : 'screen-events',
      stats     : 'screen-stats'
    };

    /* Create (empty) screen containers that later sections will fill */
    const appRoot = document.getElementById('APP');
    Object.values(SCREENS).forEach(id => {
      const el = document.createElement('section');
      el.id = id;
      el.className = 'screen-hidden';
      appRoot.appendChild(el);
    });

    function showScreen(name) {
      const targetId = SCREENS[name] || SCREENS.dashboard;
      Object.values(SCREENS).forEach(id => {
        document.getElementById(id)
          .classList.toggle('screen-hidden', id !== targetId);
      });

      /* Highlight active menu tab */
      document.querySelectorAll('#pqNav .nav-link').forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#/' + name);
      });

      window.scrollTo({ top: 0, behavior: 'instant' });
    }

    function handleRoute() {
      const page = location.hash.replace('#/', '') || 'dashboard';
      showScreen(page);
    }

    window.addEventListener('hashchange', handleRoute);
    handleRoute();            // first load
  })();
  </script>

  <!-- 3️⃣  Bootstrap JS bundle (for navbar toggler) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- ───────── END SECTION 3 ───────── -->
</body>
</html>