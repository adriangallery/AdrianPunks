<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Armory Shopping Cart</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Modern fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      background-image: repeating-linear-gradient(0deg, rgba(0,0,0,0.03), rgba(0,0,0,0.03) 1px, transparent 1px, transparent 4px);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 0 1px var(--accent-red), 0 0 0 2px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, var(--card-bg) 0%, var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .items-grid {
      display: grid;
      gap: 1rem;
      padding: 1rem;
    }
    /* Responsive grid: 2 columnas en móvil, 4 columnas en tablet/desktop */
    @media (max-width: 575px) {
      .items-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 576px) {
      .items-grid { grid-template-columns: repeat(4, 1fr); }
    }
    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-height: 400px;
    }
    .item-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .item-image {
      width: 100%;
      aspect-ratio: 1;
      margin-bottom: 1rem;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .durability-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 107, 107, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .bonus-badge {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(77, 171, 247, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .item-details {
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .item-details h4 {
      margin: 0.5rem 0;
      color: var(--primary-text);
      font-size: 1.1rem;
    }
    .item-details p {
      margin: 0.25rem 0;
      font-size: 0.9rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .item-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--primary-text);
      opacity: 0.7;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, margin 0.3s ease;
      text-align: left;
      width: 100%;
    }
    .item-description.expanded {
      max-height: 200px;
      margin: 0.5rem 0;
    }
    .description-toggle {
      background: none;
      border: none;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      margin: 0.5rem 0;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    .description-toggle:hover {
      opacity: 1;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin: 1rem 0;
      padding: 0.5rem;
      background: var(--bg-color);
      border-radius: 4px;
    }
    .quantity-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .quantity-input input {
      width: 50px;
      text-align: center;
      border: 1px solid var(--card-border);
      border-radius: 4px;
      padding: 4px;
    }
    .price-display {
      font-weight: 600;
      color: var(--primary-text);
      background: var(--card-bg);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--card-border);
    }
    .cart-summary {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--card-border);
    }
    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 0.5rem;
      box-shadow: 2px 2px 0 var(--primary-text);
    }
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 var(--accent-blue);
      border-color: var(--accent-blue);
    }
    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monos-serif;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest Armory Shopping Cart</h1>
      <p>Select multiple items and quantities to purchase in one go</p>
    </header>
    
    <!-- Wallet Connection Section -->
    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>
    
    <!-- Items Display Section -->
    <section id="items-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Available Items</h2>
        <div id="itemsGrid" class="items-grid">
          <!-- The item cards will be loaded here -->
        </div>
      </div>
    </section>
    
    <!-- Shopping Cart Section -->
    <section id="cart-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Shopping Cart</h2>
        <div id="cart-list" class="terminal">Your cart is empty.</div>
        <div id="cart-total" class="terminal">Total: 0 A$</div>
        <button id="buy-all-btn" class="btn" disabled>Buy All</button>
      </div>
    </section>
    
    <!-- User Inventory Section -->
    <section id="inventory-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Inventory Items</h2>
        <div id="inventory-items" class="terminal">Loading inventory...</div>
      </div>
    </section>
    
    <!-- General Output Section -->
    <section id="general-output-section" class="mb-4">
      <div id="general-output" class="terminal"></div>
    </section>
  </div>
  
  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider, signer, punkQuestContract;
    // Actualiza la dirección del contrato al nuevo CA
    const PUNKQUEST_ADDRESS = "0xaf22843e195b792a3f874562ab7cee751066665e";
    const NFT_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";  // Dirección del contrato NFT
    let itemsData = {}; // Almacenará los datos de los items

    // Cargar datos de items desde el archivo JSON
    async function loadItemsData() {
      try {
        const response = await fetch('weapons.json');
        itemsData = await response.json();
        console.log('Items data loaded:', itemsData);
      } catch (error) {
        console.error('Error loading items data:', error);
      }
    }

    // Cargar datos al iniciar
    loadItemsData();

    const punkQuestABI = [
      "function items(uint256) view returns (uint256 price, uint256 bonus, uint256 durability, bool exists, uint8 itemType, bool degradable)",
      "function purchaseItem(uint256 itemId) external",
      "function equipItem(uint256 tokenId, uint256 itemId) external",
      "function unequipItem(uint256 tokenId, uint256 itemId) external",
      "function repairItem(uint256 tokenId, uint256 itemId) external",
      "function getTokenItems(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenEquippedItems(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenItemDurability(uint256 tokenId, uint256 itemId) view returns (uint256)",
      "function getTokenItemBonus(uint256 tokenId, uint256 itemId) view returns (uint256)",
      "function getTokenItemPrice(uint256 tokenId, uint256 itemId) view returns (uint256)",
      "function getTokenItemType(uint256 tokenId, uint256 itemId) view returns (uint8)",
      "function getTokenItemDegradable(uint256 tokenId, uint256 itemId) view returns (bool)",
      "function getTokenItemExists(uint256 tokenId, uint256 itemId) view returns (bool)",
      "function getTokenItemCount(uint256 tokenId) view returns (uint256)",
      "function getTokenEquippedItemCount(uint256 tokenId) view returns (uint256)",
      "function getTokenItemList(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenEquippedItemList(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenItemDurabilityList(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenItemBonusList(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenItemPriceList(uint256 tokenId) view returns (uint256[] memory)",
      "function getTokenItemTypeList(uint256 tokenId) view returns (uint8[] memory)",
      "function getTokenItemDegradableList(uint256 tokenId) view returns (bool[] memory)",
      "function getTokenItemExistsList(uint256 tokenId) view returns (bool[] memory)",
      "function getTokenItemCountList(uint256[] memory tokenIds) view returns (uint256[] memory)",
      "function getTokenEquippedItemCountList(uint256[] memory tokenIds) view returns (uint256[] memory)",
      "function getTokenItemListList(uint256[] memory tokenIds) view returns (uint256[][] memory)",
      "function getTokenEquippedItemListList(uint256[] memory tokenIds) view returns (uint256[][] memory)",
      "function getTokenItemDurabilityListList(uint256[] memory tokenIds) view returns (uint256[][] memory)",
      "function getTokenItemBonusListList(uint256[] memory tokenIds) view returns (uint256[][] memory)",
      "function getTokenItemPriceListList(uint256[] memory tokenIds) view returns (uint256[][] memory)",
      "function getTokenItemTypeListList(uint256[] memory tokenIds) view returns (uint8[][] memory)",
      "function getTokenItemDegradableListList(uint256[] memory tokenIds) view returns (bool[][] memory)",
      "function getTokenItemExistsListList(uint256[] memory tokenIds) view returns (bool[][] memory)"
    ];
    const nftABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
      "function ownerOf(uint256 tokenId) view returns (address)"
    ];

    document.getElementById("connect-wallet").addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          // Configurar el provider de MetaMask para transacciones
          const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = web3Provider.getSigner();
          
          // Configurar el provider de Base para consultas usando Infura
          const etherscanProvider = new ethers.providers.JsonRpcProvider("https://base-mainnet.infura.io/v3/cc0c8013b1e044dcba79d4f7ec3b2ba1", {
            name: "base",
            chainId: 8453
          });
          
          const walletAddress = await signer.getAddress();
          const shortAddr = walletAddress.substring(0, 6) + "..." + walletAddress.substring(walletAddress.length - 4);
          document.getElementById("wallet-info").innerHTML = `<p class="wallet-address">Connected: ${shortAddr}</p>`;
          
          // Crear instancia del contrato con el provider de Infura para consultas
          punkQuestContract = new ethers.Contract(PUNKQUEST_ADDRESS, punkQuestABI, etherscanProvider);
          
          // Cargar tokens del usuario
          await loadTokens();
        } catch (error) {
          document.getElementById("wallet-info").innerHTML = `<p>Error connecting: ${error.message}</p>`;
        }
      } else {
        document.getElementById("wallet-info").innerHTML = `<p>Please install MetaMask!</p>`;
      }
    });

    // Función para cargar tokens del usuario
    async function loadTokens() {
      if (!punkQuestContract) return;
      
      try {
        // Obtener la dirección de la wallet conectada
        const walletAddress = await signer.getAddress();
        
        // Obtener el balance de tokens del usuario
        const nftContract = new ethers.Contract(
          NFT_ADDRESS,
          nftABI,
          punkQuestContract.provider
        );
        
        const balance = await nftContract.balanceOf(walletAddress);
        const tokenIds = [];
        
        // Obtener los IDs de los tokens
        for (let i = 0; i < balance.toNumber(); i++) {
          const tokenId = await nftContract.tokenOfOwnerByIndex(walletAddress, i);
          tokenIds.push(tokenId);
        }
        
        const tokenContainer = document.getElementById("itemsGrid");
        tokenContainer.innerHTML = "";
        
        if (tokenIds.length === 0) {
          tokenContainer.innerHTML = "<p>No tokens found in your wallet.</p>";
          return;
        }
        
        for (const tokenId of tokenIds) {
          const tokenCard = document.createElement("div");
          tokenCard.className = "item-card";
          tokenCard.innerHTML = `
            <div class="item-image">
              <img src="https://emerald-above-tick-265.mypinata.cloud/ipfs/bafybeicmy7xqtfe4xji4dcffiwkzodbotujre63wzavbbp7im673p2io5a/${tokenId}.png" alt="Token ${tokenId}">
            </div>
            <div class="item-details">
              <h4>Token #${tokenId}</h4>
              <button class="btn" onclick="selectToken(${tokenId})">Select</button>
            </div>
          `;
          tokenContainer.appendChild(tokenCard);
        }
      } catch (error) {
        console.error("Error loading tokens:", error);
        document.getElementById("itemsGrid").innerHTML = "<p>Error loading tokens. Please try again.</p>";
      }
    }

    // Función para seleccionar un token
    window.selectToken = async function(tokenId) {
      if (!punkQuestContract) return;
      
      try {
        const items = await punkQuestContract.getTokenItems(tokenId);
        const equippedItems = await punkQuestContract.getTokenEquippedItems(tokenId);
        
        const itemsContainer = document.getElementById("inventory-items");
        itemsContainer.innerHTML = "";
        
        if (items.length === 0) {
          itemsContainer.innerHTML = "<p>No items found for this token.</p>";
          return;
        }
        
        for (const itemId of items) {
          // Buscar el item en el JSON por su ID
          const itemData = itemsData.find(item => item.id === itemId.toNumber());
          if (!itemData) {
            console.log(`Item ID ${itemId} not found in JSON`);
            continue;
          }

          const isEquipped = equippedItems.includes(itemId);
          const durability = await punkQuestContract.getTokenItemDurability(tokenId, itemId);
          
          const itemCard = document.createElement("div");
          itemCard.className = "item-card";
          itemCard.innerHTML = `
            <div class="item-image">
              <img src="${itemData.image}" alt="${itemData.name}">
              <div class="durability-badge">${durability}/${itemData.durability}</div>
              <div class="bonus-badge">+${itemData.bonus}</div>
            </div>
            <div class="item-details">
              <h4>${itemData.name}</h4>
              <p>Type: ${itemData.type}</p>
              <p>Price: ${itemData.price} tokens</p>
              <p>Description: ${itemData.description}</p>
              <p>Status: ${isEquipped ? "Equipped" : "Not Equipped"}</p>
              <button class="btn" onclick="equipItem(${tokenId}, ${itemId})" ${isEquipped ? "disabled" : ""}>Equip</button>
              <button class="btn" onclick="unequipItem(${tokenId}, ${itemId})" ${!isEquipped ? "disabled" : ""}>Unequip</button>
              <button class="btn" onclick="repairItem(${tokenId}, ${itemId})">Repair</button>
            </div>
          `;
          itemsContainer.appendChild(itemCard);
        }
      } catch (error) {
        console.error("Error loading items:", error);
        document.getElementById("inventory-items").innerHTML = "<p>Error loading items. Please try again.</p>";
      }
    };

    // Función para equipar un item
    window.equipItem = async function(tokenId, itemId) {
      if (!punkQuestContract) return;
      
      try {
        const punkQuestContractWithSigner = new ethers.Contract(
          PUNKQUEST_ADDRESS,
          punkQuestABI,
          new ethers.providers.JsonRpcProvider("https://base-mainnet.infura.io/v3/cc0c8013b1e044dcba79d4f7ec3b2ba1", {
            name: "base",
            chainId: 8453
          })
        ).connect(signer);

        const tx = await punkQuestContractWithSigner.equipItem(tokenId, itemId);
        document.getElementById("transaction-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("transaction-output").innerText = "Item equipped successfully!";
        await selectToken(tokenId);
      } catch (error) {
        document.getElementById("transaction-output").innerText = "Error equipping item: " + error.message;
      }
    };

    // Función para desequipar un item
    window.unequipItem = async function(tokenId, itemId) {
      if (!punkQuestContract) return;
      
      try {
        const punkQuestContractWithSigner = new ethers.Contract(
          PUNKQUEST_ADDRESS,
          punkQuestABI,
          new ethers.providers.JsonRpcProvider("https://base-mainnet.infura.io/v3/cc0c8013b1e044dcba79d4f7ec3b2ba1", {
            name: "base",
            chainId: 8453
          })
        ).connect(signer);

        const tx = await punkQuestContractWithSigner.unequipItem(tokenId, itemId);
        document.getElementById("transaction-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("transaction-output").innerText = "Item unequipped successfully!";
        await selectToken(tokenId);
      } catch (error) {
        document.getElementById("transaction-output").innerText = "Error unequipping item: " + error.message;
      }
    };

    // Función para reparar un item
    window.repairItem = async function(tokenId, itemId) {
      if (!punkQuestContract) return;
      
      try {
        const punkQuestContractWithSigner = new ethers.Contract(
          PUNKQUEST_ADDRESS,
          punkQuestABI,
          new ethers.providers.JsonRpcProvider("https://base-mainnet.infura.io/v3/cc0c8013b1e044dcba79d4f7ec3b2ba1", {
            name: "base",
            chainId: 8453
          })
        ).connect(signer);

        const tx = await punkQuestContractWithSigner.repairItem(tokenId, itemId);
        document.getElementById("transaction-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("transaction-output").innerText = "Item repaired successfully!";
        await selectToken(tokenId);
      } catch (error) {
        document.getElementById("transaction-output").innerText = "Error repairing item: " + error.message;
      }
    };
  </script>
</body>
</html>