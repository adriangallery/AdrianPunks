<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Armory Shopping Cart</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Modern fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      background-image: repeating-linear-gradient(0deg, rgba(0,0,0,0.03), rgba(0,0,0,0.03) 1px, transparent 1px, transparent 4px);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 0 1px var(--accent-red), 0 0 0 2px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, var(--card-bg) 0%, var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .items-grid {
      display: grid;
      gap: 1rem;
      padding: 1rem;
    }
    /* Responsive grid: 2 columns on mobile, 4 on tablet/desktop */
    @media (max-width: 575px) {
      .items-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 576px) {
      .items-grid { grid-template-columns: repeat(4, 1fr); }
    }
    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-height: 400px;
    }
    .item-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .item-image {
      width: 100%;
      aspect-ratio: 1;
      margin-bottom: 1rem;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .durability-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 107, 107, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .bonus-badge {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(77, 171, 247, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .item-details {
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .item-details h4 {
      margin: 0.5rem 0;
      color: var(--primary-text);
      font-size: 1.1rem;
    }
    .item-details p {
      margin: 0.25rem 0;
      font-size: 0.9rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .item-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--primary-text);
      opacity: 0.7;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, margin 0.3s ease;
      text-align: left;
      width: 100%;
    }
    .item-description.expanded {
      max-height: 200px;
      margin: 0.5rem 0;
    }
    .description-toggle {
      background: none;
      border: none;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      margin: 0.5rem 0;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    .description-toggle:hover {
      opacity: 1;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin: 1rem 0;
      padding: 0.5rem;
      background: var(--bg-color);
      border-radius: 4px;
    }
    .quantity-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .quantity-input input {
      width: 50px;
      text-align: center;
      border: 1px solid var(--card-border);
      border-radius: 4px;
      padding: 4px;
    }
    .price-display {
      font-weight: 600;
      color: var(--primary-text);
      background: var(--card-bg);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--card-border);
    }
    .cart-summary {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--card-border);
    }
    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 0.5rem;
      box-shadow: 2px 2px 0 var(--primary-text);
    }
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 var(--accent-blue);
      border-color: var(--accent-blue);
    }
    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monos-serif;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest Armory Shopping Cart</h1>
      <p>Select multiple items and quantities to purchase in one go</p>
    </header>
    
    <!-- Wallet Connection Section -->
    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>
    
    <!-- Items Display Section -->
    <section id="items-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Available Items</h2>
        <div id="itemsGrid" class="items-grid">
          <!-- Items will be loaded here -->
        </div>
      </div>
    </section>
    
    <!-- Shopping Cart Section -->
    <section id="cart-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Shopping Cart</h2>
        <div id="cart-list" class="terminal">
          Your cart is empty.
        </div>
        <div id="cart-total" class="terminal">
          Total: 0 A$
        </div>
        <button id="buy-all-btn" class="btn" disabled>Buy All</button>
      </div>
    </section>
    
    <!-- User Inventory Section -->
    <section id="inventory-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Inventory Items</h2>
        <div id="inventory-items" class="terminal">
          Loading inventory...
        </div>
      </div>
    </section>
    
    <!-- General Output Section -->
    <section id="general-output-section" class="mb-4">
      <div id="general-output" class="terminal"></div>
    </section>
  </div>
  
  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider, signer, punkQuestContract, tokenContract;
    // Use your deployed contract addresses.
    const PUNKQUEST_ADDRESS = "0xb253c1C784bA13ca1C45daB6777210a83cEA4f73";
    const TOKEN_ADDRESS = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const NFT_ADDRESS = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
  
    // ABI for required methods
    const punkQuestABI = [
      "function batchBuyItems(uint256[] calldata itemIds, uint256[] calldata quantities) external",
      "function buyItem(uint256 itemId, uint256 quantity) external",
      "function inventory(address, uint256) view returns (uint256)",
      "function nextItemId() view returns (uint256)"
    ];
    const tokenABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
    const nftABI = [
      "function ownerOf(uint256 tokenId) view returns (address)"
    ];
  
    let shoppingCart = [];
    let allItems = [];
  
    function formatPrice(price) {
      return price + " tokens";
    }
  
    // Connect wallet and instantiate contracts
    document.getElementById("connect-wallet").addEventListener("click", async () => {
      if(window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          provider.getResolver = async (name) => null;
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          const shortAddress = walletAddress.substring(0, 6) + "..." + walletAddress.substring(walletAddress.length - 4);
          document.getElementById("wallet-info").innerHTML = `<p class="wallet-address">Connected: ${shortAddress}</p>`;
          punkQuestContract = new ethers.Contract(PUNKQUEST_ADDRESS, punkQuestABI, signer);
          tokenContract = new ethers.Contract(TOKEN_ADDRESS, tokenABI, signer);
          loadItems();
          loadUserInventory();
        } catch (error) {
          document.getElementById("wallet-info").innerHTML = `<p>Error: ${error.message}</p>`;
        }
      } else {
        document.getElementById("wallet-info").innerHTML = `<p>Please install MetaMask!</p>`;
      }
    });
  
    // Retrieve nextItemId from the contract.
    async function getNextItemId() {
      try {
        const nextId = await punkQuestContract.nextItemId();
        return nextId.toNumber();
      } catch (error) {
        console.error("Error getting nextItemId:", error);
        return 0;
      }
    }
  
    // Load items from weapons.json and armor.json and merge them.
    async function loadItems() {
      try {
        const nextId = await getNextItemId();
        const responseWeapons = await fetch("weapons.json");
        if (!responseWeapons.ok) {
          throw new Error(`HTTP error! status: ${responseWeapons.status}`);
        }
        const weaponsData = await responseWeapons.json();
        const responseArmors = await fetch("armor.json");
        const armorsData = await responseArmors.json();
  
        // Use <= (nextId - 1) so that items with id equal to nextId-1 are shown.
        const activeWeapons = weaponsData.filter(item => item.id <= (nextId - 1) && item.type === "Weapon");
        const activeArmors = armorsData.filter(item => item.id <= (nextId - 1) && item.type === "Armor");
  
        allItems = activeWeapons.concat(activeArmors);
  
        const itemsGrid = document.getElementById("itemsGrid");
        itemsGrid.innerHTML = "";
  
        allItems.forEach(item => {
          const card = document.createElement("div");
          card.className = "item-card";
          // Format price for display: if price >= 1000, show "X K"
          const price = parseFloat(item.price);
          const formattedPrice = price >= 1000 ? `${(price/1000).toFixed(1)}K` : price;
          card.innerHTML = `
            <div class="item-image">
              <img src="${item.image}" alt="${item.name}">
              <div class="durability-badge">${item.durability}</div>
              <div class="bonus-badge">${item.bonus}</div>
            </div>
            <div class="item-details">
              <div class="item-name">
                ${item.name}
                <button class="description-toggle" onclick="toggleDescription(this)">▼</button>
              </div>
              <div class="item-description">${item.description}</div>
            </div>
            <div class="quantity-controls">
              <div class="quantity-input">
                <label for="qty-${item.id}">Qty:</label>
                <input type="number" id="qty-${item.id}" value="0" min="0" />
              </div>
              <div class="price-display">${formattedPrice} $A</div>
            </div>
            <button class="btn add-to-cart-btn" data-id="${item.id}" data-price="${item.price}" data-name="${item.name}" data-type="${item.type}">Add to Cart</button>
          `;
          itemsGrid.appendChild(card);
        });
  
        const addButtons = document.getElementsByClassName("add-to-cart-btn");
        for (let btn of addButtons) {
          btn.addEventListener("click", (e) => {
            const itemId = e.target.getAttribute("data-id");
            const itemPrice = e.target.getAttribute("data-price");
            const itemName = e.target.getAttribute("data-name");
            const itemType = e.target.getAttribute("data-type");
            const qtyInput = document.getElementById(`qty-${itemId}`);
            const quantity = parseInt(qtyInput.value);
            if (quantity > 0) {
              addToCart({ id: Number(itemId), name: itemName, price: itemPrice, quantity: quantity, type: itemType });
              qtyInput.value = 0;
            }
          });
        }
      } catch (error) {
        console.error('Error loading items:', error);
        document.getElementById("general-output").innerText = "Error loading items: " + error.message;
      }
    }
  
    // Add item to shopping cart.
    function addToCart(item) {
      const existing = shoppingCart.find(i => i.id === item.id);
      if (existing) {
        existing.quantity += item.quantity;
      } else {
        shoppingCart.push(item);
      }
      updateCartUI();
    }
  
    // Update shopping cart UI and total cost.
    function updateCartUI() {
      const cartList = document.getElementById("cart-list");
      if (shoppingCart.length === 0) {
        cartList.innerHTML = "Your cart is empty.";
      } else {
        let html = "<table class='table'><thead><tr><th>Item</th><th>Qty</th><th>Cost</th></tr></thead><tbody>";
        let total = ethers.BigNumber.from(0);
        shoppingCart.forEach(item => {
          const cost = ethers.utils.parseUnits(item.price, 18).mul(item.quantity);
          total = total.add(cost);
          html += `<tr><td>${item.name} (${item.type})</td><td>${item.quantity}</td><td>${item.price} x ${item.quantity}</td></tr>`;
        });
        html += "</tbody></table>";
        cartList.innerHTML = html;
        document.getElementById("cart-total").innerText = "Total: " + ethers.utils.formatUnits(total, 18) + " A$";
        document.getElementById("buy-all-btn").disabled = total.isZero();
      }
    }
  
    // Batch purchase handler.
    document.getElementById("buy-all-btn").addEventListener("click", async () => {
      if (shoppingCart.length === 0) {
        alert("Your cart is empty.");
        return;
      }
      // Prepare arrays with item IDs as numbers and quantities.
      const itemIds = shoppingCart.map(item => Number(item.id));
      const quantities = shoppingCart.map(item => item.quantity);
      let totalCost = ethers.BigNumber.from(0);
      shoppingCart.forEach(item => {
        totalCost = totalCost.add(ethers.utils.parseUnits(item.price, 18).mul(item.quantity));
      });
      try {
        const walletAddress = await signer.getAddress();
        const allowance = await tokenContract.allowance(walletAddress, PUNKQUEST_ADDRESS);
        if (allowance.lt(totalCost)) {
          document.getElementById("general-output").innerText = "Approving spending for batch purchase. Please wait...";
          const approveTx = await tokenContract.approve(PUNKQUEST_ADDRESS, totalCost);
          await approveTx.wait();
        }
        document.getElementById("general-output").innerText = "Submitting batch purchase transaction...";
        const tx = await punkQuestContract.batchBuyItems(itemIds, quantities);
        await tx.wait();
        document.getElementById("general-output").innerText = "Batch purchase successful!";
        shoppingCart = [];
        updateCartUI();
        loadUserInventory(); // Refresh inventory after purchase.
      } catch (error) {
        document.getElementById("general-output").innerText = "Error during batch purchase: " + error.message;
      }
    });
  
    // Toggle description of item.
    function toggleDescription(button) {
      const itemDetails = button.closest('.item-details');
      const description = itemDetails.querySelector('.item-description');
      description.classList.toggle('expanded');
      button.classList.toggle('active');
    }
  
    // Load user's inventory from the contract using the merged list.
    async function loadUserInventory() {
      try {
        const walletAddress = await signer.getAddress();
        let inventoryHTML = "<table class='table'><thead><tr><th>Item</th><th>Quantity</th></tr></thead><tbody>";
        // Iterate through all items (from our merged list).
        for (let item of allItems) {
          const qty = await punkQuestContract.inventory(walletAddress, item.id);
          if (qty.gt(0)) {
            inventoryHTML += `<tr><td>${item.name} (${item.type}, ID: ${item.id})</td><td>${qty.toString()}</td></tr>`;
          }
        }
        inventoryHTML += "</tbody></table>";
        document.getElementById("inventory-items").innerHTML = inventoryHTML;
      } catch (error) {
        document.getElementById("inventory-items").innerText = "Error loading inventory: " + error.message;
      }
    }
  </script>
</body>
</html>