<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Armory Shopping Cart</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Modern fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
      background-image: repeating-linear-gradient(0deg, rgba(0,0,0,0.03), rgba(0,0,0,0.03) 1px, transparent 1px, transparent 4px);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 0 1px var(--accent-red), 0 0 0 2px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    header {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(180deg, var(--card-bg) 0%, var(--screen-bg) 100%);
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .items-grid {
      display: grid;
      gap: 1rem;
      padding: 1rem;
    }
    @media (max-width: 575px) {
      .items-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 576px) {
      .items-grid { grid-template-columns: repeat(4, 1fr); }
    }
    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-height: 400px;
    }
    .item-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .item-image { width: 100%; aspect-ratio: 1; margin-bottom: 1rem; border-radius: 4px; overflow: hidden; position: relative; }
    .item-image img { width: 100%; height: 100%; object-fit: cover; }
    .durability-badge { position: absolute; top: 10px; left: 10px; background: rgba(255,107,107,0.9); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: .8rem; font-weight: 600; }
    .bonus-badge      { position: absolute; bottom: 10px; left: 10px; background: rgba(77,171,247,0.9); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: .8rem; font-weight: 600; }
    .item-details { width: 100%; text-align: center; display: flex; flex-direction: column; align-items: center; gap: .5rem; }
    .item-description { margin: 0; font-size: .85rem; color: var(--primary-text); opacity: .7; max-height: 0; overflow: hidden; transition: max-height .3s ease, margin .3s ease; text-align: left; width: 100%; }
    .item-description.expanded { max-height: 200px; margin: .5rem 0; }
    .description-toggle { background: none; border: none; color: var(--accent-blue); cursor: pointer; font-size: .8rem; padding: .25rem .5rem; margin: .5rem 0; opacity: .8; transition: opacity .2s ease; }
    .description-toggle:hover { opacity: 1; }
    .quantity-controls { display: flex; align-items: center; justify-content: space-between; width: 100%; margin: 1rem 0; padding: .5rem; background: var(--bg-color); border-radius: 4px; }
    .quantity-input { display: flex; align-items: center; gap: .5rem; }
    .quantity-input input { width: 50px; text-align: center; border: 1px solid var(--card-border); border-radius: 4px; padding: 4px; }
    .price-display { font-weight: 600; color: var(--primary-text); background: var(--card-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--card-border); }
    .btn { font-family: 'Press Start 2P', monospace; font-size: .8rem; padding: .5rem 1rem; background: var(--card-bg); border: 2px solid var(--primary-text); color: var(--primary-text); text-transform: uppercase; cursor: pointer; margin-top: .5rem; box-shadow: 2px 2px 0 var(--primary-text); }
    .btn:hover { transform: translate(-2px,-2px); box-shadow: 4px 4px 0 var(--accent-blue); border-color: var(--accent-blue); }
    .terminal { background: var(--card-bg); color: var(--primary-text); padding: 1rem; font-family: 'Space Mono', monos-serif; font-size: .9rem; border: 1px solid var(--card-border); border-radius: 8px; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest Armory Shopping Cart</h1>
      <p>Select multiple items and quantities to purchase in one go</p>
    </header>

    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn">Connect Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
    </section>

    <section id="items-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Available Items</h2>
        <div id="itemsGrid" class="items-grid"></div>
      </div>
    </section>

    <section id="cart-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">Shopping Cart</h2>
        <div id="cart-list" class="terminal">Your cart is empty.</div>
        <div id="cart-total" class="terminal">Total: 0 A$</div>
        <button id="buy-all-btn" class="btn" disabled>Buy All</button>
      </div>
    </section>

    <section id="inventory-section" class="mb-4">
      <div class="card">
        <h2 class="section-title">My Inventory Items</h2>
        <div id="inventory-items" class="terminal">Connect wallet to load inventory…</div>
      </div>
    </section>

    <section id="general-output-section" class="mb-4">
      <div id="general-output" class="terminal"></div>
    </section>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    /*──────────────── CONSTANTS ───────────────*/
    const INFURA_PROJECT_ID = "cc0c8013b1e044dcba79d4f7ec3b2ba1";
    const NETWORK_RPC      = `https://base-mainnet.infura.io/v3/${INFURA_PROJECT_ID}`;
    const CHAIN_ID         = 8453; // Base mainnet

    const PUNKQUEST_ADDRESS = "0x64c46fca3f46442c7abd5303dc1c56a79f4e4273";
    const TOKEN_address    = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";

    /*──────────────── ABIs ────────────────────*/
    const punkQuestABI = [
      "function batchBuyItems(uint256[] ids, uint256[] qtys) external",
      "function inventory(address,uint256) view returns (uint256)",
      "function ownedItems(address,uint256) view returns (uint256 instanceId, uint256 templateId, uint256 durability, bool degraded)"
    ];
    const tokenABI = [
      "function balanceOf(address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)",
      "function allowance(address,address) view returns (uint256)"
    ];

    /*──────────────── GLOBALS ─────────────────*/
    let infuraProvider;  // sólo lectura
    let web3Provider;    // MetaMask
    let signer;          // MetaMask signer

    let punkQuestRead;   // read‑contract
    let tokenRead;
    let punkQuestWrite;  // write (connected to signer)
    let tokenWrite;

    let shoppingCart = [];
    let allItems = [];

    /*──────────────── INIT ───────────────────*/
    window.addEventListener("DOMContentLoaded", async () => {
      infuraProvider = new ethers.providers.JsonRpcProvider(NETWORK_RPC, { name: "base", chainId: CHAIN_ID });
      punkQuestRead  = new ethers.Contract(PUNKQUEST_ADDRESS, punkQuestABI, infuraProvider);
      tokenRead      = new ethers.Contract(TOKEN_address,  tokenABI,     infuraProvider);
      await loadItems();
    });

    /*────────────── WALLET ───────────────────*/
    document.getElementById("connect-wallet").addEventListener("click", async () => {
      if (!window.ethereum) { document.getElementById("wallet-info").innerText = "Install MetaMask"; return; }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        const network = await web3Provider.getNetwork();
        if (network.chainId !== CHAIN_ID) {
          await window.ethereum.request({ method: "wallet_switchEthereumChain", params:[{ chainId: "0x2105" }] }); // 0x2105 = 8453
        }
        signer = web3Provider.getSigner();

        const addr = await signer.getAddress();
        document.getElementById("wallet-info").innerHTML = `<p class="wallet-address">Connected: ${addr.slice(0,6)}…${addr.slice(-4)}</p>`;

        punkQuestWrite = new ethers.Contract(PUNKQUEST_ADDRESS, punkQuestABI, signer);
        tokenWrite     = new ethers.Contract(TOKEN_address,  tokenABI,     signer);

        loadUserInventory();
      } catch (err) {
        document.getElementById("wallet-info").innerText = "Error: " + err.message;
      }
    });

    /*────────────── ITEMS ───────────────────*/
    async function loadItems() {
      try {
        const res = await fetch("weapons.json");
        if (!res.ok) throw new Error("HTTP " + res.status);
        allItems = await res.json();
        displayItems(allItems);
      } catch (err) {
        document.getElementById("general-output").innerText = "Error loading items: " + err.message;
      }
    }

    function displayItems(items) {
      const grid = document.getElementById("itemsGrid"); grid.innerHTML = "";
      items.forEach(it => {
        const card = document.createElement("div"); card.className = "item-card";
        const priceTxt = parseFloat(it.price);
        card.innerHTML = `
          <div class="item-image"><img src="${it.image}" alt="${it.name}"><div class="durability-badge">${it.durability}</div><div class="bonus-badge">+${it.bonus}%</div></div>
          <div class="item-details"><div class="item-name">${it.name}<button class="description-toggle" onclick="toggleDescription(this)">▼</button></div><div class="item-description">${it.description}</div></div>
          <div class="quantity-controls"><div class="quantity-input"><label for="qty-${it.id}">Qty:</label><input type="number" id="qty-${it.id}" value="0" min="0"></div><div class="price-display">${priceTxt >= 1000 ? (priceTxt/1000).toFixed(1)+'K' : priceTxt} $A</div></div>
          <button class="btn add-to-cart-btn" data-id="${it.id}" data-price="${it.price}" data-name="${it.name}" data-type="${it.type}">Add to Cart</button>`;
        grid.appendChild(card);
      });
      Array.from(document.getElementsByClassName("add-to-cart-btn")).forEach(btn => btn.addEventListener("click", e => {
        const { id, price, name, type } = e.currentTarget.dataset;
        const qty = parseInt(document.getElementById(`qty-${id}`).value);
        if (qty>0) { addToCart({ id: Number(id), name, price: price.toString(), quantity: qty, type }); document.getElementById(`qty-${id}`).value = 0; }
      }));
    }

    /*────────────── CART ───────────────────*/
    function addToCart(item) {
      const ex = shoppingCart.find(i => i.id === item.id);
      if (ex) ex.quantity += item.quantity; else shoppingCart.push(item);
      updateCartUI();
    }

    function updateCartUI() {
      const cartList=document.getElementById("cart-list"), cartTotal=document.getElementById("cart-total"), buyBtn=document.getElementById("buy-all-btn");
      if (!shoppingCart.length){ cartList.innerText="Your cart is empty."; cartTotal.innerText="Total: 0 A$"; buyBtn.disabled=true; return; }
      let html="<table class='table'><thead><tr><th>Item</th><th>Qty</th><th>Cost</th></tr></thead><tbody>", totalBN=ethers.BigNumber.from(0);
      shoppingCart.forEach(({name,type,price,quantity})=>{ const cost=ethers.utils.parseUnits(price,18).mul(quantity); totalBN=totalBN.add(cost); html+=`<tr><td>${name} (${type})</td><td>${quantity}</td><td>${price}×${quantity}</td></tr>`; });
      cartList.innerHTML = html+"</tbody></table>";
      cartTotal.innerText = `Total: ${ethers.utils.formatUnits(totalBN,18)} A$`;
      buyBtn.disabled = totalBN.isZero();
    }

    /*────────────── BUY ALL ─────────────────*/
    document.getElementById("buy-all-btn").addEventListener("click", async()=>{
      if(!signer){alert("Connect wallet first");return;} if(!shoppingCart.length){alert("Your cart is empty.");return;}
      try{
        let totalCostBN=ethers.BigNumber.from(0);
        shoppingCart.forEach(({price,quantity})=>{ totalCostBN=totalCostBN.add(ethers.utils.parseUnits(price,18).mul(quantity)); });
        const addr=await signer.getAddress();
        const allowance=await tokenWrite.allowance(addr,PUNKQUEST_ADDRESS);
        if(allowance.lt(totalCostBN)){ document.getElementById("general-output").innerText="Approving tokens…"; const tx=await tokenWrite.approve(PUNKQUEST_ADDRESS,totalCostBN); await tx.wait(); }
        const ids=shoppingCart.map(i=>i.id); const qtys=shoppingCart.map(i=>i.quantity);
        document.getElementById("general-output").innerText="Submitting batch buy…";
        const tx=await punkQuestWrite.batchBuyItems(ids,qtys); await tx.wait();
        document.getElementById("general-output").innerText="Batch purchase successful!";
        shoppingCart=[]; updateCartUI(); loadUserInventory();
      }catch(err){ console.error(err); document.getElementById("general-output").innerText="Error: "+err.message; }
    });

    /*────────────── DESCRIPTION ─────────────*/
    function toggleDescription(btn){ const desc=btn.closest('.item-details').querySelector('.item-description'); desc.classList.toggle('expanded'); btn.classList.toggle('active'); }

    /*────────────── INVENTORY ───────────────*/
    async function loadUserInventory(){ if(!signer) return; const addr=await signer.getAddress(); let html="<table class='table'><thead><tr><th>Item</th><th>Qty</th></tr></thead><tbody>";
      for(const it of allItems){ try{ const q=await punkQuestWrite.inventory(addr,it.id); if(q.gt(0)) html+=`<tr><td>${it.name} (${it.type}, tpl ID ${it.id})</td><td>${q}</td></tr>`; }catch{}
      }
      const counts={}; for(let idx=0; idx<9999; idx++){ try{ const owned=await punkQuest
