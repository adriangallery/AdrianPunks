<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Admin Panel</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Modern fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: var(--screen-bg);
      padding: 20px;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    header {
      text-align: center;
      padding: 1rem 0;
    }
    header h1 {
      font-size: 2rem;
      margin: 0;
    }
    .form-control {
      margin-bottom: 1rem;
    }
    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 1rem;
      box-shadow: 2px 2px 0 var(--primary-text);
    }
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 var(--accent-blue);
      border-color: var(--accent-blue);
    }
    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin-top: 1rem;
    }
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest Admin Panel</h1>
      <p>Manage Weapons &amp; Events, plus Economic Snapshot</p>
    </header>
    
    <!-- Wallet Connection Section -->
    <div id="wallet-connection" class="mb-4">
      <button id="connect-admin" class="btn">Connect Admin Wallet</button>
      <div id="admin-wallet-info" class="mt-2"></div>
    </div>
    
    <!-- Weapons Management Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="section-title">Weapons Management</h2>
        <!-- Create Weapon Form -->
        <form id="create-weapon-form">
          <label for="weapon-price">Price (in tokens):</label>
          <input type="number" step="any" id="weapon-price" class="form-control" placeholder="e.g., 1000" required>
          
          <label for="weapon-bonus">Bonus (%) :</label>
          <input type="number" step="any" id="weapon-bonus" class="form-control" placeholder="e.g., 10" required>
          
          <label for="weapon-durability">Durability:</label>
          <input type="number" id="weapon-durability" class="form-control" placeholder="e.g., 100" required>
          
          <button type="submit" class="btn">Create Weapon</button>
        </form>
        <div id="create-weapon-output" class="terminal"></div>
        
        <!-- Update Weapon Form -->
        <form id="load-weapon-form">
          <label for="update-item-id">Weapon Item ID:</label>
          <input type="number" id="update-item-id" class="form-control" placeholder="e.g., 1" required>
          <button type="button" id="load-weapon-btn" class="btn">Load Weapon Data</button>
        </form>
        <form id="update-weapon-form" style="display:none;">
          <label for="update-weapon-price">New Price (in tokens):</label>
          <input type="number" step="any" id="update-weapon-price" class="form-control" placeholder="e.g., 1000" required>
          
          <label for="update-weapon-bonus">New Bonus (%) :</label>
          <input type="number" step="any" id="update-weapon-bonus" class="form-control" placeholder="e.g., 10" required>
          
          <label for="update-weapon-durability">New Durability:</label>
          <input type="number" id="update-weapon-durability" class="form-control" placeholder="e.g., 100" required>
          
          <button type="submit" class="btn">Update Weapon</button>
        </form>
        <div id="update-weapon-output" class="terminal"></div>
      </div>
    </div>
    
    <!-- Events Management Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="section-title">Events Management</h2>
        <!-- Create Event Form -->
        <form id="create-event-form">
          <label for="event-name">Event Name:</label>
          <input type="text" id="event-name" class="form-control" placeholder="e.g., Birds" required>
          
          <label for="event-adjustment">Adjustment (use negative for penalties, e.g., -10 for -10%):</label>
          <input type="number" step="any" id="event-adjustment" class="form-control" placeholder="e.g., -10" required>
          
          <label for="event-description">Description:</label>
          <input type="text" id="event-description" class="form-control" placeholder="Short and fun description" required>
          
          <button type="submit" class="btn">Create Event</button>
        </form>
        <div id="create-event-output" class="terminal"></div>
        
        <!-- Trigger Event Form -->
        <form id="trigger-event-form">
          <label for="trigger-token-id">Token ID:</label>
          <input type="number" id="trigger-token-id" class="form-control" placeholder="e.g., 1" required>
          
          <label for="trigger-event-id">Event ID:</label>
          <input type="number" id="trigger-event-id" class="form-control" placeholder="e.g., 1" required>
          
          <button type="submit" class="btn">Trigger Event</button>
        </form>
        <div id="trigger-event-output" class="terminal"></div>
      </div>
    </div>
    
    <!-- Economic Snapshot Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="section-title">Economic Snapshot</h2>
        <button id="get-snapshot-btn" class="btn">Get Snapshot</button>
        <div id="snapshot-output" class="terminal"></div>
      </div>
    </div>
    
  </div>
  
  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider, signer, punkQuestContract;
    // Actualiza esta dirección con la de tu contrato PunkQuest desplegado
    const PUNKQUEST_ADDRESS = "0xb253c1C784bA13ca1C45daB6777210a83cEA4f73";
    const punkQuestABI = [
      "function addItem(uint8 _type, uint256 _price, uint256 _bonus, uint256 _durability) external",
      "function updateItem(uint256 _itemId, uint256 _price, uint256 _bonus, uint256 _durability) external",
      "function items(uint256) view returns (uint256 price, uint256 bonus, uint256 durability, bool exists, uint8 itemType)",
      "function addEventDefinition(string memory name, int256 adjustment, string memory description) external onlyOwner",
      "function triggerEvent(uint256 tokenId, uint256 eventId) external onlyOwner",
      "function getEconomicSnapshot() view returns (uint256 totalStaked, uint256 totalItemsCreated, uint256 totalItemsPurchased, uint256 totalItemsEquipped)",
      "function owner() view returns (address)"
    ];
  
    // Conexión del Admin Wallet
    document.getElementById("connect-admin").addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          // Deshabilitar ENS resolver
          provider.getResolver = async (name) => null;
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          const shortAddr = walletAddress.substring(0, 6) + "..." + walletAddress.substring(walletAddress.length - 4);
          document.getElementById("admin-wallet-info").innerHTML = `<p class="wallet-address">Connected: ${shortAddr}</p>`;
          punkQuestContract = new ethers.Contract(PUNKQUEST_ADDRESS, punkQuestABI, signer);
        } catch (error) {
          document.getElementById("admin-wallet-info").innerHTML = `<p>Error connecting: ${error.message}</p>`;
        }
      } else {
        document.getElementById("admin-wallet-info").innerHTML = `<p>Please install MetaMask!</p>`;
      }
    });
  
    // --- Weapons Management ---
    // Crear arma
    document.getElementById("create-weapon-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const priceInput = document.getElementById("weapon-price").value;
      const bonusInput = document.getElementById("weapon-bonus").value;
      const durabilityInput = document.getElementById("weapon-durability").value;
      let priceParsed, bonusParsed;
      try {
        priceParsed = ethers.utils.parseUnits(priceInput, 18);
        // Si ingresa 10 para 10%, bonusParsed = 10 * 1e16 = 1e17.
        bonusParsed = ethers.BigNumber.from(bonusInput).mul("10000000000000000");
      } catch (error) {
        document.getElementById("create-weapon-output").innerText = "Error parsing numbers: " + error.message;
        return;
      }
      const durabilityParsed = parseInt(durabilityInput);
      try {
        const tx = await punkQuestContract.addItem(0, priceParsed, bonusParsed, durabilityParsed);
        document.getElementById("create-weapon-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("create-weapon-output").innerText = "Weapon created successfully!";
        document.getElementById("create-weapon-form").reset();
      } catch (error) {
        document.getElementById("create-weapon-output").innerText = "Error creating weapon: " + error.message;
      }
    });
  
    // Actualizar arma
    document.getElementById("load-weapon-btn").addEventListener("click", async () => {
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const itemId = document.getElementById("update-item-id").value;
      try {
        const weaponData = await punkQuestContract.items(itemId);
        if (!weaponData.exists || weaponData.itemType != 0) {
          document.getElementById("update-weapon-output").innerText = "Weapon not found with that ID.";
          return;
        }
        document.getElementById("update-weapon-price").value = ethers.utils.formatUnits(weaponData.price, 18);
        document.getElementById("update-weapon-bonus").value = ethers.utils.formatUnits(weaponData.bonus, 16);
        document.getElementById("update-weapon-durability").value = weaponData.durability.toString();
        document.getElementById("update-weapon-form").style.display = "block";
        document.getElementById("update-weapon-output").innerText = "Weapon data loaded. You can now update.";
      } catch (error) {
        document.getElementById("update-weapon-output").innerText = "Error loading weapon data: " + error.message;
      }
    });
  
    document.getElementById("update-weapon-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const itemId = document.getElementById("update-item-id").value;
      const priceInput = document.getElementById("update-weapon-price").value;
      const bonusInput = document.getElementById("update-weapon-bonus").value;
      const durabilityInput = document.getElementById("update-weapon-durability").value;
      try {
        const priceParsed = ethers.utils.parseUnits(priceInput, 18);
        const bonusParsed = ethers.BigNumber.from(bonusInput).mul("10000000000000000");
        const durabilityParsed = parseInt(durabilityInput);
        const tx = await punkQuestContract.updateItem(itemId, priceParsed, bonusParsed, durabilityParsed);
        document.getElementById("update-weapon-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("update-weapon-output").innerText = "Weapon updated successfully!";
        document.getElementById("update-weapon-form").reset();
        document.getElementById("update-weapon-form").style.display = "none";
      } catch (error) {
        document.getElementById("update-weapon-output").innerText = "Error updating weapon: " + error.message;
      }
    });
  
    // --- Events Management ---
    // Crear un nuevo evento
    document.getElementById("create-event-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const eventName = document.getElementById("event-name").value;
      const eventAdjustmentInput = document.getElementById("event-adjustment").value;
      const eventDescription = document.getElementById("event-description").value;
      let eventAdjustment;
      // Convertir el ajuste a fixed point (por ejemplo, -10 significa -10% y se convertirá a -1e17 si usas 1e17 para 10%)
      try {
        // Multiplicamos el valor ingresado (ej. -10) por 1e16 para obtener -1e17
        eventAdjustment = int256(ethers.BigNumber.from(eventAdjustmentInput).mul("10000000000000000"));
      } catch (error) {
        document.getElementById("create-event-output").innerText = "Error parsing adjustment: " + error.message;
        return;
      }
      try {
        const tx = await punkQuestContract.addEventDefinition(eventName, eventAdjustment, eventDescription);
        document.getElementById("create-event-output").innerText = "Event creation tx sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("create-event-output").innerText = "Event created successfully!";
        document.getElementById("create-event-form").reset();
      } catch (error) {
        document.getElementById("create-event-output").innerText = "Error creating event: " + error.message;
      }
    });
  
    // Disparar un evento manualmente
    document.getElementById("trigger-event-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const tokenId = document.getElementById("trigger-token-id").value;
      const eventId = document.getElementById("trigger-event-id").value;
      try {
        const tx = await punkQuestContract.triggerEvent(tokenId, eventId);
        document.getElementById("trigger-event-output").innerText = "Event triggering tx sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("trigger-event-output").innerText = "Event triggered successfully for token " + tokenId;
      } catch (error) {
        document.getElementById("trigger-event-output").innerText = "Error triggering event: " + error.message;
      }
    });
  
    // --- Economic Snapshot ---
    document.getElementById("get-snapshot-btn").addEventListener("click", async () => {
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      try {
        const snapshot = await punkQuestContract.getEconomicSnapshot();
        const output = `
Total Staked: ${snapshot.totalStaked.toString()}
Total Items Created: ${snapshot.totalItemsCreated.toString()}
Total Items Purchased: ${snapshot.totalItemsPurchased.toString()}
Total Items Equipped: ${snapshot.totalItemsEquipped.toString()}
        `;
        document.getElementById("snapshot-output").innerText = output;
      } catch (error) {
        document.getElementById("snapshot-output").innerText = "Error fetching snapshot: " + error.message;
      }
    });
  </script>
</body>
</html>