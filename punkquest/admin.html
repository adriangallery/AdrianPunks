<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Admin Panel</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Modern fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --primary-text: #2c3e50;
      --accent-red: #ff6b6b;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --screen-bg: #ffffff;
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: var(--screen-bg);
      padding: 20px;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    header {
      text-align: center;
      padding: 1rem 0;
    }
    header h1 {
      font-size: 2rem;
      margin: 0;
    }
    .form-control {
      margin-bottom: 1rem;
    }
    .btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      border: 2px solid var(--primary-text);
      color: var(--primary-text);
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 1rem;
      box-shadow: 2px 2px 0 var(--primary-text);
    }
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 var(--accent-blue);
      border-color: var(--accent-blue);
    }
    .terminal {
      background: var(--card-bg);
      color: var(--primary-text);
      padding: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PunkQuest Admin Panel</h1>
      <p>Create and Update Weapons</p>
    </header>
    
    <!-- Wallet Connection Section -->
    <div id="wallet-connection" class="mb-4">
      <button id="connect-admin" class="btn">Connect Admin Wallet</button>
      <div id="admin-wallet-info" class="mt-2"></div>
    </div>
    
    <!-- Create Weapon Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="section-title">Create New Weapon</h2>
        <form id="create-weapon-form">
          <label for="weapon-price">Price (in tokens):</label>
          <input type="number" step="any" id="weapon-price" class="form-control" placeholder="e.g., 1000" required>
  
          <label for="weapon-bonus">Bonus (%) :</label>
          <input type="number" step="any" id="weapon-bonus" class="form-control" placeholder="e.g., 10" required>
  
          <label for="weapon-durability">Durability:</label>
          <input type="number" id="weapon-durability" class="form-control" placeholder="e.g., 100" required>
  
          <button type="submit" class="btn">Create Weapon</button>
        </form>
        <div id="create-weapon-output" class="terminal"></div>
      </div>
    </div>
    
    <!-- Update Weapon Section -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="section-title">Update Weapon</h2>
        <form id="load-weapon-form">
          <label for="update-item-id">Weapon Item ID:</label>
          <input type="number" id="update-item-id" class="form-control" placeholder="e.g., 1" required>
          <button type="button" id="load-weapon-btn" class="btn">Load Weapon Data</button>
        </form>
        <form id="update-weapon-form" style="display:none;">
          <label for="update-weapon-price">New Price (in tokens):</label>
          <input type="number" step="any" id="update-weapon-price" class="form-control" placeholder="e.g., 1000" required>
  
          <label for="update-weapon-bonus">New Bonus (%) :</label>
          <input type="number" step="any" id="update-weapon-bonus" class="form-control" placeholder="e.g., 10" required>
  
          <label for="update-weapon-durability">New Durability:</label>
          <input type="number" id="update-weapon-durability" class="form-control" placeholder="e.g., 100" required>
  
          <button type="submit" class="btn">Update Weapon</button>
        </form>
        <div id="update-weapon-output" class="terminal"></div>
      </div>
    </div>
  
  </div>
  
  <!-- Bootstrap 5 JS and Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider, signer, punkQuestContract;
    // Update this with the deployed address of PunkQuest
    const PUNKQUEST_ADDRESS = "0xYourPunkQuestContractAddress"; // Replace with deployed address
    const punkQuestABI = [
      "function addItem(uint8 _type, uint256 _price, uint256 _bonus, uint256 _durability) external",
      "function updateItem(uint256 _itemId, uint256 _price, uint256 _bonus, uint256 _durability) external",
      "function items(uint256) view returns (uint256 price, uint256 bonus, uint256 durability, bool exists, uint8 itemType)",
      "function owner() view returns (address)"
    ];
  
    // Connect Admin Wallet
    document.getElementById("connect-admin").addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          // Disable ENS resolution workaround:
          provider.getResolver = async (name) => null;
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          const shortAddr = walletAddress.substring(0, 6) + "..." + walletAddress.substring(walletAddress.length - 4);
          document.getElementById("admin-wallet-info").innerHTML = `<p class="wallet-address">Connected: ${shortAddr}</p>`;
          punkQuestContract = new ethers.Contract(PUNKQUEST_ADDRESS, punkQuestABI, signer);
        } catch (error) {
          document.getElementById("admin-wallet-info").innerHTML = `<p>Error connecting: ${error.message}</p>`;
        }
      } else {
        document.getElementById("admin-wallet-info").innerHTML = `<p>Please install MetaMask!</p>`;
      }
    });
  
    // Create Weapon Form Submission
    document.getElementById("create-weapon-form").addEventListener("submit", async (event) => {
      event.preventDefault(); // Prevent default form submission
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      // Get form values
      const priceInput = document.getElementById("weapon-price").value;
      const bonusInput = document.getElementById("weapon-bonus").value;
      const durabilityInput = document.getElementById("weapon-durability").value;
  
      // Convert inputs:
      // Price -> 18 decimals.
      let priceParsed;
      let bonusParsed;
      try {
        priceParsed = ethers.utils.parseUnits(priceInput, 18);
        // If admin enters 10 for 10%, bonusParsed = 10 * 1e16 = 1e17.
        bonusParsed = ethers.BigNumber.from(bonusInput).mul("10000000000000000");
      } catch (error) {
        document.getElementById("create-weapon-output").innerText = "Error parsing numbers: " + error.message;
        return;
      }
      const durabilityParsed = parseInt(durabilityInput);
  
      // Call addItem with ItemType = 0 (Weapon)
      try {
        const tx = await punkQuestContract.addItem(0, priceParsed, bonusParsed, durabilityParsed);
        document.getElementById("create-weapon-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("create-weapon-output").innerText = "Weapon created successfully!";
        document.getElementById("create-weapon-form").reset();
      } catch (error) {
        document.getElementById("create-weapon-output").innerText = "Error creating weapon: " + error.message;
      }
    });
  
    // Load Weapon Data for Update
    document.getElementById("load-weapon-btn").addEventListener("click", async () => {
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const itemId = document.getElementById("update-item-id").value;
      try {
        const weaponData = await punkQuestContract.items(itemId);
        // weaponData returns (price, bonus, durability, exists, itemType)
        if (!weaponData.exists || weaponData.itemType != 0) { // 0 = Weapon
          document.getElementById("update-weapon-output").innerText = "Weapon not found with that ID.";
          return;
        }
        // Pre-fill form fields
        document.getElementById("update-weapon-price").value = ethers.utils.formatUnits(weaponData.price, 18);
        // Convert bonus from fixed point to percentage: bonus / 1e16
        document.getElementById("update-weapon-bonus").value = ethers.utils.formatUnits(weaponData.bonus, 16);
        document.getElementById("update-weapon-durability").value = weaponData.durability.toString();
        document.getElementById("update-weapon-form").style.display = "block";
        document.getElementById("update-weapon-output").innerText = "Weapon data loaded. You can now update.";
      } catch (error) {
        document.getElementById("update-weapon-output").innerText = "Error loading weapon data: " + error.message;
      }
    });
  
    // Update Weapon Form Submission
    document.getElementById("update-weapon-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!punkQuestContract) {
        alert("Please connect your admin wallet first.");
        return;
      }
      const itemId = document.getElementById("update-item-id").value;
      const priceInput = document.getElementById("update-weapon-price").value;
      const bonusInput = document.getElementById("update-weapon-bonus").value;
      const durabilityInput = document.getElementById("update-weapon-durability").value;
      try {
        const priceParsed = ethers.utils.parseUnits(priceInput, 18);
        const bonusParsed = ethers.BigNumber.from(bonusInput).mul("10000000000000000");
        const durabilityParsed = parseInt(durabilityInput);
        const tx = await punkQuestContract.updateItem(itemId, priceParsed, bonusParsed, durabilityParsed);
        document.getElementById("update-weapon-output").innerText = "Transaction sent... waiting for confirmation.";
        await tx.wait();
        document.getElementById("update-weapon-output").innerText = "Weapon updated successfully!";
        document.getElementById("update-weapon-form").reset();
        document.getElementById("update-weapon-form").style.display = "none";
      } catch (error) {
        document.getElementById("update-weapon-output").innerText = "Error updating weapon: " + error.message;
      }
    });
  </script>
</body>
</html>