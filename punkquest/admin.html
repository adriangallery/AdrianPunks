<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - PunkQuest</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom Styles -->
  <link rel="stylesheet" href="/market/styles/styles.css">
  <!-- Inline CSS para tema y estilos básicos -->
  <style>
    :root {
      --bg-color-light: #ffffff;
      --text-color-light: #333333;
      --bg-color-dark: #121212;
      --text-color-dark: #f4f4f4;
      --primary-color: #f39c12;
      --card-bg: #f8f9fa;
      --card-border: #f39c12;
    }
    body {
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
      font-family: "Share Tech Mono", monospace;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-theme {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <!-- Encabezado -->
    <header class="text-center mb-4">
      <h1>Admin Dashboard - PunkQuest</h1>
      <button id="theme-toggle" class="btn btn-secondary">Toggle Theme</button>
    </header>

    <!-- Conexión de Wallet y verificación de Owner -->
    <section id="wallet-connection" class="mb-4">
      <button id="connect-wallet" class="btn btn-primary">Conectar Wallet</button>
      <div id="wallet-info" class="mt-2"></div>
      <div id="owner-check" class="mt-2"></div>
    </section>
    <hr>

    <!-- Sección: Parámetros Básicos de Gamificación -->
    <section id="basic-params" class="mb-4">
      <h2>Parámetros Básicos de Gamificación</h2>
      <button id="read-basic-params" class="btn btn-info mb-2">Leer Parámetros Básicos</button>
      <div id="basic-params-output" class="mb-2"></div>
      <div class="mb-2">
        <label>Activation Fee:</label>
        <input type="text" id="input-activationFee" class="form-control">
      </div>
      <div class="mb-2">
        <label>Exit Fee:</label>
        <input type="text" id="input-exitFee" class="form-control">
      </div>
      <div class="mb-2">
        <label>Fast Level Upgrade Fee:</label>
        <input type="text" id="input-fastLevelUpgradeFee" class="form-control">
      </div>
      <div class="mb-2">
        <label>Fast Level Upgrade Bonus Increment:</label>
        <input type="text" id="input-fastLevelUpgradeBonusIncrement" class="form-control">
      </div>
      <button id="update-basic-params" class="btn btn-warning">Actualizar Parámetros Básicos</button>
    </section>
    <hr>

    <!-- Sección: Parámetros de Social Staking -->
    <section id="social-params" class="mb-4">
      <h2>Parámetros de Social Staking</h2>
      <button id="read-social-params" class="btn btn-info mb-2">Leer Parámetros de Social Staking</button>
      <div id="social-params-output" class="mb-2"></div>
      <div class="mb-2">
        <label>Social Min Tokens:</label>
        <input type="text" id="input-socialMinTokens" class="form-control">
      </div>
      <div class="mb-2">
        <label>Social Boost Bonus:</label>
        <input type="text" id="input-socialBoostBonus" class="form-control">
      </div>
      <div class="mb-2">
        <label>Social Boost Duration:</label>
        <input type="text" id="input-socialBoostDuration" class="form-control">
      </div>
      <div class="mb-2">
        <label>Social Boost Active Until:</label>
        <input type="text" id="input-socialBoostActiveUntil" class="form-control">
      </div>
      <button id="update-social-params" class="btn btn-warning">Actualizar Parámetros de Social Staking</button>
    </section>
    <hr>

    <!-- Sección: Parámetros de Niveles -->
    <section id="level-params" class="mb-4">
      <h2>Parámetros de Niveles</h2>
      <button id="read-level-params" class="btn btn-info mb-2">Leer Parámetros de Niveles</button>
      <div id="level-params-output" class="mb-2"></div>
      <div class="mb-2">
        <label>Thresholds (separados por coma):</label>
        <input type="text" id="input-thresholds" class="form-control">
      </div>
      <div class="mb-2">
        <label>Bonuses (separados por coma):</label>
        <input type="text" id="input-bonuses" class="form-control">
      </div>
      <button id="update-level-params" class="btn btn-warning">Actualizar Parámetros de Niveles</button>
    </section>
    <hr>

    <!-- Sección: Consultar Información de Item -->
    <section id="item-info" class="mb-4">
      <h2>Consultar Información de Item</h2>
      <div class="mb-2">
        <label>Item ID:</label>
        <input type="text" id="input-item-id" class="form-control">
      </div>
      <button id="read-item" class="btn btn-info">Leer Información de Item</button>
      <div id="item-output" class="mt-2"></div>
    </section>
    <hr>

    <!-- Sección: Retirar Fondos -->
    <section id="withdraw-funds" class="mb-4">
      <h2>Retirar Fondos (Admin)</h2>
      <button id="withdraw-button" class="btn btn-danger">Retirar Fondos</button>
      <div id="withdraw-output" class="mt-2"></div>
    </section>

    <div id="admin-output" class="mt-3"></div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Ethers.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Script Admin -->
  <script>
    let provider, signer;
    let stakingContract; // Usamos el contrato de staking para las funciones admin
    const connectWalletButton = document.getElementById("connect-wallet");
    const walletInfoDiv = document.getElementById("wallet-info");
    const ownerCheckDiv = document.getElementById("owner-check");
    const adminOutputDiv = document.getElementById("admin-output");

    // Dirección del contrato de staking
    const STAKING_ADDRESS = "0xeEC1A809acB57acABa196C6677f65EcC4c6f4491";

    // ABI extendido: incluye funciones de lectura, actualización y administración
    const stakingABI = [
      // --- Funciones de lectura ---
      // Verificar Owner (se asume que el contrato implementa Ownable)
      {
        "inputs": [],
        "name": "owner",
        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
      },
      // Lectura de parámetros básicos
      {
        "inputs": [],
        "name": "getBasicGamificationParameters",
        "outputs": [
          {"internalType": "uint256", "name": "activationFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "exitFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeBonusIncrement_", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      // Lectura de parámetros de social staking
      {
        "inputs": [],
        "name": "getSocialStakingParameters",
        "outputs": [
          {"internalType": "uint256", "name": "socialMinTokens_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostBonus_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostDuration_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostActiveUntil_", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      // Lectura de parámetros de niveles
      {
        "inputs": [],
        "name": "getLevelParameters",
        "outputs": [
          {"internalType": "uint256[]", "name": "thresholds", "type": "uint256[]"},
          {"internalType": "uint256[]", "name": "bonuses", "type": "uint256[]"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      // Consultar información de un item
      {
        "inputs": [{"internalType": "uint256", "name": "itemId", "type": "uint256"}],
        "name": "getItem",
        "outputs": [
          {"internalType": "uint256", "name": "price", "type": "uint256"},
          {"internalType": "uint256", "name": "bonus", "type": "uint256"},
          {"internalType": "bool", "name": "exists", "type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      },

      // --- Funciones de actualización (solamente accesibles para el owner) ---
      {
        "inputs": [
          {"internalType": "uint256", "name": "activationFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "exitFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeFee_", "type": "uint256"},
          {"internalType": "uint256", "name": "fastLevelUpgradeBonusIncrement_", "type": "uint256"}
        ],
        "name": "setBasicGamificationParameters",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256", "name": "socialMinTokens_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostBonus_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostDuration_", "type": "uint256"},
          {"internalType": "uint256", "name": "socialBoostActiveUntil_", "type": "uint256"}
        ],
        "name": "setSocialStakingParameters",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256[]", "name": "thresholds", "type": "uint256[]"},
          {"internalType": "uint256[]", "name": "bonuses", "type": "uint256[]"}
        ],
        "name": "setLevelParameters",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      // Función para retirar fondos (adminWithdraw)
      {
        "inputs": [],
        "name": "adminWithdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    // Conexión de wallet y verificación de owner
    connectWalletButton.addEventListener("click", async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          const walletAddress = await signer.getAddress();
          walletInfoDiv.innerHTML = `<p>Wallet: ${walletAddress}</p>`;
          
          // Inicializar el contrato de staking
          stakingContract = new ethers.Contract(STAKING_ADDRESS, stakingABI, signer);
          // Verificar el owner
          const ownerAddress = await stakingContract.owner();
          if(walletAddress.toLowerCase() === ownerAddress.toLowerCase()){
            ownerCheckDiv.innerHTML = `<p style="color:green;">Conectado como Owner</p>`;
          } else {
            ownerCheckDiv.innerHTML = `<p style="color:red;">No eres el Owner. Acceso restringido.</p>`;
          }
        } catch (error) {
          walletInfoDiv.innerHTML = `<p style="color:red;">Error al conectar la wallet: ${error.message}</p>`;
        }
      } else {
        walletInfoDiv.innerHTML = `<p style="color:red;">Por favor instala MetaMask!</p>`;
      }
    });

    // --- Funciones Admin ---

    // Leer parámetros básicos
    document.getElementById("read-basic-params").addEventListener("click", async () => {
      try {
        const params = await stakingContract.getBasicGamificationParameters();
        const output = `Activation Fee: ${params[0].toString()}<br>
                        Exit Fee: ${params[1].toString()}<br>
                        Fast Level Upgrade Fee: ${params[2].toString()}<br>
                        Fast Level Upgrade Bonus Increment: ${params[3].toString()}`;
        document.getElementById("basic-params-output").innerHTML = output;
      } catch (error) {
        document.getElementById("basic-params-output").innerHTML = "Error: " + error.message;
      }
    });

    // Actualizar parámetros básicos
    document.getElementById("update-basic-params").addEventListener("click", async () => {
      const activationFee = document.getElementById("input-activationFee").value;
      const exitFee = document.getElementById("input-exitFee").value;
      const fastLevelUpgradeFee = document.getElementById("input-fastLevelUpgradeFee").value;
      const fastLevelUpgradeBonusIncrement = document.getElementById("input-fastLevelUpgradeBonusIncrement").value;
      try {
        const tx = await stakingContract.setBasicGamificationParameters(activationFee, exitFee, fastLevelUpgradeFee, fastLevelUpgradeBonusIncrement);
        await tx.wait();
        adminOutputDiv.innerHTML = `<p style="color:green;">Parámetros básicos actualizados correctamente.</p>`;
      } catch (error) {
        adminOutputDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    });

    // Leer parámetros de Social Staking
    document.getElementById("read-social-params").addEventListener("click", async () => {
      try {
        const params = await stakingContract.getSocialStakingParameters();
        const output = `Social Min Tokens: ${params[0].toString()}<br>
                        Social Boost Bonus: ${params[1].toString()}<br>
                        Social Boost Duration: ${params[2].toString()}<br>
                        Social Boost Active Until: ${params[3].toString()}`;
        document.getElementById("social-params-output").innerHTML = output;
      } catch (error) {
        document.getElementById("social-params-output").innerHTML = "Error: " + error.message;
      }
    });

    // Actualizar parámetros de Social Staking
    document.getElementById("update-social-params").addEventListener("click", async () => {
      const socialMinTokens = document.getElementById("input-socialMinTokens").value;
      const socialBoostBonus = document.getElementById("input-socialBoostBonus").value;
      const socialBoostDuration = document.getElementById("input-socialBoostDuration").value;
      const socialBoostActiveUntil = document.getElementById("input-socialBoostActiveUntil").value;
      try {
        const tx = await stakingContract.setSocialStakingParameters(socialMinTokens, socialBoostBonus, socialBoostDuration, socialBoostActiveUntil);
        await tx.wait();
        adminOutputDiv.innerHTML = `<p style="color:green;">Parámetros de Social Staking actualizados correctamente.</p>`;
      } catch (error) {
        adminOutputDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    });

    // Leer parámetros de Niveles
    document.getElementById("read-level-params").addEventListener("click", async () => {
      try {
        const params = await stakingContract.getLevelParameters();
        const thresholds = params[0];
        const bonuses = params[1];
        const output = `Thresholds: ${thresholds.join(", ")}<br>
                        Bonuses: ${bonuses.join(", ")}`;
        document.getElementById("level-params-output").innerHTML = output;
      } catch (error) {
        document.getElementById("level-params-output").innerHTML = "Error: " + error.message;
      }
    });

    // Actualizar parámetros de Niveles
    document.getElementById("update-level-params").addEventListener("click", async () => {
      const thresholdsInput = document.getElementById("input-thresholds").value;
      const bonusesInput = document.getElementById("input-bonuses").value;
      const thresholdsArray = thresholdsInput.split(",").map(x => parseInt(x.trim()));
      const bonusesArray = bonusesInput.split(",").map(x => parseInt(x.trim()));
      try {
        const tx = await stakingContract.setLevelParameters(thresholdsArray, bonusesArray);
        await tx.wait();
        adminOutputDiv.innerHTML = `<p style="color:green;">Parámetros de Niveles actualizados correctamente.</p>`;
      } catch (error) {
        adminOutputDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    });

    // Consultar información de un item
    document.getElementById("read-item").addEventListener("click", async () => {
      const itemId = document.getElementById("input-item-id").value;
      try {
        const item = await stakingContract.getItem(itemId);
        const output = `Price: ${item[0].toString()}<br>Bonus: ${item[1].toString()}<br>Exists: ${item[2]}`;
        document.getElementById("item-output").innerHTML = output;
      } catch (error) {
        document.getElementById("item-output").innerHTML = "Error: " + error.message;
      }
    });

    // Función para retirar fondos (adminWithdraw)
    document.getElementById("withdraw-button").addEventListener("click", async () => {
      try {
        const tx = await stakingContract.adminWithdraw();
        await tx.wait();
        document.getElementById("withdraw-output").innerHTML = `<p style="color:green;">Fondos retirados correctamente.</p>`;
      } catch (error) {
        document.getElementById("withdraw-output").innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    });

    // Funcionalidad del Theme Toggle
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark-theme");
      } else {
        document.body.classList.remove("dark-theme");
      }
      localStorage.setItem("theme", theme);
    }

    document.getElementById("theme-toggle").addEventListener("click", () => {
      const currentTheme = localStorage.getItem("theme") || "light";
      const newTheme = currentTheme === "light" ? "dark" : "light";
      applyTheme(newTheme);
    });

    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme") || "light";
      applyTheme(savedTheme);
    });
  </script>
</body>
</html>