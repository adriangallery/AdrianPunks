<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PunkQuest Marketplace</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg-color: #f0f0f0;
      --primary-text: #333333;
      --accent-purple: #8a2be2;
      --accent-purple-hover: #7a1dd2;
      --accent-blue: #4dabf7;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --card-selected-border: #8a2be2;
      --screen-bg: #ffffff;
      --navbar-height: 60px;
      --error-bg: #f8d7da;
      --error-border: #f5c6cb;
      --error-text: #721c24;
      --success-bg: #d4edda;
      --success-border: #c3e6cb;
      --success-text: #155724;
    }
    
    body {
      background-color: var(--bg-color);
      color: var(--primary-text);
      font-family: 'Share Tech Mono', monospace;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      padding-top: calc(var(--navbar-height) + 20px);
    }
    
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: var(--screen-bg);
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    header {
      text-align: center;
      padding: 2rem;
      margin-bottom: 2rem;
      position: relative;
    }
    
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--primary-text);
      font-weight: 600;
      letter-spacing: 1px;
    }
    
    header p {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--primary-text);
      opacity: 0.8;
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1.5rem;
      color: var(--primary-text);
      font-weight: 600;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 0.5rem;
    }
    
    .token-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      padding: 0;
      margin: 0;
    }
    
    .store-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      padding: 0;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      .token-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .store-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 480px) {
      .token-grid {
        grid-template-columns: 1fr;
      }
      .store-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .token-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .token-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .token-card img {
      width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 4px;
      aspect-ratio: 1/1;
      background-color: #f0f0f0;
      transition: opacity 0.3s ease;
    }
    
    .token-card img.loading {
      opacity: 0.5;
    }
    
    .token-card img.error {
      opacity: 0.3;
    }
    
    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .item-type {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .type-weapon {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    
    .type-armor {
      background-color: #e0e7ff;
      color: #4338ca;
    }
    
    .item-bonus {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .item-durability {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .item-price {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .token-info {
      padding: 0.5rem 0;
    }
    
    .token-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .token-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .status-staked {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .status-not-staked {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .token-gear {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .selected-token {
      border: 2px solid var(--card-selected-border);
      box-shadow: 0 0 0 2px var(--card-selected-border);
    }
    
    .btn-connect {
      background-color: var(--accent-purple);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .btn-connect:hover {
      background-color: var(--accent-purple-hover);
    }
    
    .btn-action {
      background-color: var(--accent-purple);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
      text-align: center;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .btn-action:hover {
      background-color: var(--accent-purple-hover);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: #6c757d;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-add-cart {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 0.5rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .btn-add-cart:hover {
      background-color: #0b5ed7;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--card-border);
    }
    
    .account-display {
      display: inline-block;
      background-color: #f0f0f0;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
    
    .alert-danger {
      background-color: var(--error-bg);
      border: 1px solid var(--error-border);
      color: var(--error-text);
    }
    
    .alert-success {
      background-color: var(--success-bg);
      border: 1px solid var(--success-border);
      color: var(--success-text);
    }
    
    .nav-tabs {
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 1.5rem;
    }
    
    .nav-link {
      color: var(--primary-text);
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }
    
    .nav-link.active {
      color: var(--accent-purple);
      border-bottom: 2px solid var(--accent-purple);
    }
    
    .tab-content {
      padding: 1rem;
    }
    
    .inventory-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    
    .inventory-count {
      background-color: var(--accent-purple);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .badge {
      margin-left: 0.5rem;
    }
    
    .footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--card-border);
      color: #9ca3af;
      font-size: 0.875rem;
    }
    
    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
      margin-right: 0.5rem;
    }
    
    .small-quantity {
      width: 3rem;
      text-align: center;
      margin: 0 0.5rem;
    }
    
    .equipped-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: var(--accent-purple);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .reward-info {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
    
    .reward-value {
      font-weight: bold;
      color: var(--accent-purple);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">PunkQuest</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-bs-target="#tokensSection" id="tokensTab">My Tokens</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-bs-target="#storeSection" id="storeTab">Store</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-bs-target="#inventorySection" id="inventoryTab">Inventory</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-bs-target="#cartSection" id="cartTab">Cart <span id="cartBadge" class="badge bg-danger">0</span></a>
          </li>
        </ul>
      </div>
      <div id="account-section" class="text-end" style="display: none;">
        <span id="tokenBalance" class="text-white me-3">$ADRIAN: 0</span>
        <span id="accountDisplay" class="account-display text-white"></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Header -->
    <header>
      <h1>PunkQuest Marketplace</h1>
      <p>Buy items, equip your AdrianPunks, and earn rewards</p>
    </header>
    
    <!-- Connect Wallet Section -->
    <div id="connect-section" class="text-center mb-4">
      <button id="connectWalletBtn" class="btn-connect">Connect Wallet</button>
    </div>
    
    <!-- Alert Messages -->
    <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>
    <div id="successAlert" class="alert alert-success" style="display: none;"></div>
    
    <!-- Tab Content Sections -->
    <div class="tab-content">
      <!-- Tokens Section -->
      <div id="tokensSection" class="tab-pane active">
        <div class="card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0">Your AdrianPunks</h2>
            <div>
              <button id="selectAllBtn" class="btn-secondary btn-action">Select All</button>
              <button id="claimAllBtn" class="btn-action">Claim All Rewards</button>
            </div>
          </div>
          
          <div id="loading-tokens" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your tokens...</p>
          </div>
          
          <div id="no-tokens-message" class="text-center py-5" style="display: none;">
            <p>You don't own any AdrianPunks yet</p>
          </div>
          
          <!-- Token Grid -->
          <div id="token-grid" class="token-grid mb-4"></div>
          
          <!-- Token Actions -->
          <div id="token-actions" style="display: none;">
            <div class="d-flex flex-wrap">
              <button id="stakeBtn" class="btn-action">Stake Selected</button>
              <button id="unstakeBtn" class="btn-action">Unstake Selected</button>
              <button id="claimBtn" class="btn-action">Claim Selected</button>
              <button id="levelUpBtn" class="btn-action">Fast Level Upgrade</button>
            </div>
          </div>
        </div>
        
        <!-- Equipment Section -->
        <div id="equipment-section" class="card" style="display: none;">
          <h2 class="section-title">Equip Items</h2>
          
          <div id="no-token-selected" class="text-center my-3">
            <p>Select a token to equip items</p>
          </div>
          
          <div id="token-equipment" style="display: none;">
            <div class="row mb-3">
              <div class="col-md-6">
                <h5>Currently Equipped</h5>
                <div id="current-equipment" class="p-3 bg-light rounded">
                  <div id="weapon-slot">
                    <p>Weapon Slot: <span id="current-weapon">None</span></p>
                  </div>
                  <div id="armor-slot">
                    <p>Armor Slot: <span id="current-armor">None</span></p>
                  </div>
                  <div id="extra-slots">
                    <p>Extra Slots: <span id="current-extras">None</span></p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h5>Your Inventory</h5>
                <div id="equipment-inventory" class="p-3 bg-light rounded">
                  <p>Loading inventory...</p>
                </div>
              </div>
            </div>
            <button id="purchaseSlotBtn" class="btn-action">Purchase Extra Slot</button>
          </div>
        </div>
      </div>
      
      <!-- Store Section -->
      <div id="storeSection" class="tab-pane">
        <div class="card">
          <h2 class="section-title">Item Store</h2>
          
          <div id="loading-store" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading store items...</p>
          </div>
          
          <!-- Filter Controls -->
          <div class="mb-3">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-secondary active" data-filter="all">All Items</button>
              <button type="button" class="btn btn-outline-secondary" data-filter="weapon">Weapons</button>
              <button type="button" class="btn btn-outline-secondary" data-filter="armor">Armor</button>
            </div>
          </div>
          
          <!-- Item Grid -->
          <div id="store-grid" class="store-grid"></div>
        </div>
      </div>
      
      <!-- Inventory Section -->
      <div id="inventorySection" class="tab-pane">
        <div class="card">
          <h2 class="section-title">Your Inventory</h2>
          
          <div id="loading-inventory" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your inventory...</p>
          </div>
          
          <div id="no-inventory-message" class="text-center py-5" style="display: none;">
            <p>Your inventory is empty. Visit the store to buy items!</p>
          </div>
          
          <!-- Inventory List -->
          <div id="inventory-list"></div>
        </div>
      </div>
      
      <!-- Cart Section -->
      <div id="cartSection" class="tab-pane">
        <div class="card">
          <h2 class="section-title">Shopping Cart</h2>
          
          <div id="empty-cart-message" class="text-center py-5">
            <p>Your cart is empty. Add items from the store!</p>
          </div>
          
          <!-- Cart Items -->
          <div id="cart-items"></div>
          
          <!-- Cart Summary -->
          <div id="cart-summary" class="mt-3" style="display: none;">
            <hr>
            <div class="d-flex justify-content-between">
              <h5>Total:</h5>
              <h5 id="cart-total">0 $ADRIAN</h5>
            </div>
            <button id="approveBtn" class="btn-action w-100 mb-2">Approve $ADRIAN</button>
            <button id="checkoutBtn" class="btn-action w-100" disabled>Checkout</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p id="contractAddressInfo"></p>
      <p>© 2025 PunkQuest</p>
    </div>
  </div>

  <!-- Modal for Item Details -->
  <div class="modal fade" id="itemDetailsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemDetailsTitle">Item Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="itemDetailsContent">
          <!-- Content will be dynamically inserted -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="addToCartModal">Add to Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Configuración y lógica de la aplicación -->
  <script>
    /* -----------------------------------------------------------
       Adrian Punks  – Marketplace / Quest dApp
       Autor: ChatGPT · Mayo 2025
       ----------------------------------------------------------- */

    /* ------------------ 1.  CONFIGURACIÓN BÁSICA ------------------ */

    const CFG = {
      network: {
        chainIdHex: "0x2105",          // Base mainnet
        chainIdDec: 8453,
        rpc: "https://base-mainnet.infura.io/v3/cc0c8013b1e044dcba79d4f7ec3b2ba1"
      },
      addresses: {
        punks:  "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566",
        quest:  "0x6c1BFa0AfB84e314DF2e8B9a88C3530e0b19a49F",
        token:  "0xD2a4684edFc70D2B01600416f50Fc5733bFc97D5",
        multicall: "0xcA11bde05977b3631167028862bE2a173976CA11"
      },
      abi: { 
        punks: [
          "function balanceOf(address owner) view returns (uint256)",
          "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
          "function tokenURI(uint256 tokenId) view returns (string)",
          "function ownerOf(uint256 tokenId) view returns (address)",
          "function getApproved(uint256 tokenId) view returns (address)",
          "function isApprovedForAll(address owner, address operator) view returns (bool)",
          "function approve(address to, uint256 tokenId)",
          "function setApprovalForAll(address operator, bool approved)",
          "function transferFrom(address from, address to, uint256 tokenId)",
          "function safeTransferFrom(address from, address to, uint256 tokenId)",
          "function safeTransferFrom(address from, address to, uint256 tokenId, bytes data)"
        ],
        quest: [
          "function stake(uint256 id)",
          "function unstake(uint256 id)",
          "function claimRewards(uint256 id) returns (uint256)",
          "function batchStake(uint256[] ids)",
          "function batchUnstake(uint256[] ids)",
          "function batchClaimRewards(uint256[] ids) returns (uint256)",
          "function getTokenDetailedInfo(uint256 id) view returns (uint256, uint256, uint256, uint256, uint256, int256, uint256)",
          "function getTokenStats(uint256 id) view returns (uint256, uint256)",
          "function getTokenArmoryDetails(uint256 id) view returns (uint256, uint256, uint256[], uint256)",
          "function activationFee() view returns (uint256)",
          "function exitFee() view returns (uint256)",
          "function claimFee() view returns (uint256)",
          "function fastLevelUpgradeFee() view returns (uint256)",
          "function extraSlotCost() view returns (uint256)",
          "function repairFee() view returns (uint256)",
          "function baseRewardRate() view returns (uint256)",
          "function eventChance() view returns (uint256)",
          "function eventCooldown() view returns (uint256)",
          "function positiveEventBonus() view returns (uint256)",
          "function negativeEventPenalty() view returns (uint256)",
          "function maxFastLevelBonus() view returns (uint256)",
          "function fastLevelUpgradeBonusIncrement() view returns (uint256)",
          "function maxSlots() view returns (uint256)",
          "function socialMinTokens() view returns (uint256)",
          "function socialBoostBonus() view returns (uint256)",
          "function socialBoostDuration() view returns (uint256)",
          "function socialBoostActiveUntil() view returns (uint256)",
          "function totalStaked() view returns (uint256)",
          "function totalItemsEquipped() view returns (uint256)",
          "function totalItemsPurchased() view returns (uint256)",
          "function getGlobalStats() view returns (uint256, uint256, uint256)",
          "function getEconomicSnapshot() view returns (uint256, uint256, uint256, uint256)",
          "function getWalletStats(address w, uint256[] tokenIds) view returns (uint256[], uint256, uint256)",
          "function pendingPassiveReward(uint256 id) view returns (uint256)",
          "function pendingGameReward(uint256 id) view returns (uint256)",
          "function pendingTotalReward(uint256 id) view returns (uint256)",
          "function randomTriggerEvent(uint256 tokenId)",
          "function triggerEvent(uint256 tokenId, uint256 id)",
          "function triggerAdvancedEvent(uint256 tokenId, uint256 ev)",
          "function addEventDefinition(string n, int256 adj, string d)",
          "function addAdvancedEventDefinition(string n, int256 adj, string d, uint256 deg)",
          "function setEventParameters(uint256 c, uint256 chance, uint256 pos, uint256 neg)",
          "function setEventsPaused(bool p)",
          "function addItem(uint8 t, uint256 p, uint256 b, uint256 d, bool degr)",
          "function updateItem(uint256 id, uint256 p, uint256 b, uint256 d)",
          "function buyItem(uint256 id, uint256 qty)",
          "function batchBuyItems(uint256[] ids, uint256[] qtys)",
          "function equipItem(uint256 tokenId, uint256 itemId)",
          "function equipItemInstance(uint256 tokenId, uint256 instId)",
          "function equipExtraItemInstance(uint256 tokenId, uint256 instId)",
          "function repairItem(uint256 inst, uint256 tokenId)",
          "function purchaseFastLevelUpgrade(uint256 id)",
          "function purchaseExtraSlots(uint256 tokenId, uint256 q)",
          "function addRewardToken(address t)",
          "function depositRewardFunds(uint256 a)",
          "function withdrawRewardFunds(uint256 a, address to)",
          "function setActivationFee(uint256 v)",
          "function setExitFee(uint256 v)",
          "function setClaimFee(uint256 v)",
          "function setFastLevelUpgradeFee(uint256 v)",
          "function setExtraSlotCost(uint256 v)",
          "function setRepairFee(uint256 v)",
          "function setBaseRewardRate(uint256 v)",
          "function setFastLevelUpgradeBonusIncrement(uint256 v)",
          "function setMaxFastLevelBonus(uint256 v)",
          "function setMaxSlots(uint256 v)",
          "function setLevelParameters(uint256[] th, uint256[] bn)",
          "function setSocialStakingParameters(uint256 m, uint256 b, uint256 d)",
          "function setArtistWallet(address w)",
          "function setFeeWallet(address w)",
          "function owner() view returns (address)",
          "function renounceOwnership()",
          "function transferOwnership(address newOwner)"
        ],
        erc20: [
          "function balanceOf(address account) view returns (uint256)",
          "function allowance(address owner, address spender) view returns (uint256)",
          "function approve(address spender, uint256 amount) returns (bool)",
          "function transfer(address to, uint256 amount) returns (bool)",
          "function transferFrom(address from, address to, uint256 amount) returns (bool)",
          "function decimals() view returns (uint8)",
          "function symbol() view returns (string)",
          "function name() view returns (string)",
          "function totalSupply() view returns (uint256)",
          "function stake(uint256 amount)",
          "function withdrawStake()",
          "function calculateReward(address staker) view returns (uint256)",
          "function stakedBalance(address account) view returns (uint256)",
          "function stakingStart(address account) view returns (uint256)",
          "function rewardRate() view returns (uint256)",
          "function updateRewardRate(uint256 _newRewardRate)",
          "function taxFee() view returns (uint256)",
          "function creatorFee() view returns (uint256)",
          "function burnFee() view returns (uint256)",
          "function taxAddress() view returns (address)",
          "function creatorAddress() view returns (address)",
          "function isFeeExempt(address account) view returns (bool)",
          "function setFeeExemption(address account, bool exempt)",
          "function updateTaxFee(uint256 _newTaxFee)",
          "function updateCreatorFee(uint256 _newCreatorFee)",
          "function updateBurnFee(uint256 _newBurnFee)",
          "function updateTaxAddress(address _newTaxAddress)",
          "function updateCreatorAddress(address _newCreatorAddress)",
          "function owner() view returns (address)",
          "function renounceOwnership()",
          "function transferOwnership(address newOwner)"
        ]
      },
      imgPath:  "/market/halfxadrianimages/",
      placeholder: "/market/halfxadrianimages/placeholder.jpg"
    };

    /* ------------------ 2.  ESTADO GLOBAL ------------------ */

    const S = {
      provider:     null,
      signer:       null,
      account:      "",
      contracts:    {},
      ownedTokens:  [],
      selected:     new Set(),
      storeItems:   [],
      inventory:    {},
      cart:         [],
      fees:         {},
      decimals:     18,
      symbol:       "ADRIAN",
      loading:      false,
      currentTab:   "tokens"
    };

    /* ------------------ 3.  DOM CORTO ------------------ */

    const $ = selector => document.querySelector(selector);
    const $$ = selector => document.querySelectorAll(selector);

    /* Elementos Reutilizados */
    const E = {
      connectBtn:   $("#connectWalletBtn"),
      accountBox:   $("#accountDisplay"),
      balBox:       $("#tokenBalance"),
      error:        $("#errorAlert"),
      ok:           $("#successAlert"),
      loadingTok:   $("#loading-tokens"),
      noTok:        $("#no-tokens-message"),
      grid:         $("#token-grid"),
      tokActions:   $("#token-actions"),
      stakeBtn:     $("#stakeBtn"),
      unstakeBtn:   $("#unstakeBtn"),
      claimBtn:     $("#claimBtn"),
      lvlBtn:       $("#levelUpBtn"),
      selectAll:    $("#selectAllBtn"),
      storeLoad:    $("#loading-store"),
      storeGrid:    $("#store-grid"),
      cartBadge:    $("#cartBadge"),
      cartItems:    $("#cart-items"),
      cartSum:      $("#cart-summary"),
      cartTotal:    $("#cart-total"),
      approveBtn:   $("#approveBtn"),
      checkoutBtn:  $("#checkoutBtn"),
      tabs:         $$(".nav-link")
    };

    /* ------------------ 4.  UTILIDADES ------------------ */

    const fmt = (bn, dec = S.decimals, fixed = 2) =>
      Number(ethers.utils.formatUnits(bn, dec)).toFixed(fixed);

    const notify = (box, msg) => {
      box.textContent = msg;
      box.style.display = "block";
      setTimeout(() => (box.style.display = "none"), 5000);
    };

    const handleErr = err => notify(E.error, err.message ?? "Error inesperado");

    const withLoad = fn => async (...a) => {
      S.loading = true; toggleUI();
      try { return await fn(...a); }
      catch (e) { handleErr(e); }
      finally { S.loading = false; toggleUI(); }
    };

    /* ------------------ 5.  CONEXIÓN WALLET ------------------ */

    async function connect() {
      if (!window.ethereum) throw new Error("Instala MetaMask para continuar");
      const [acc] = await window.ethereum.request({ method: "eth_requestAccounts" });
      
      /* Red Base */
      if ((await ethereum.request({ method: "eth_chainId" })) !== CFG.network.chainIdHex) {
        try {
          await ethereum.request({ method: "wallet_switchEthereumChain",
                                   params: [{ chainId: CFG.network.chainIdHex }] });
        } catch (e) {
          if (e.code === 4902)
            await ethereum.request({ method: "wallet_addEthereumChain",
                                     params: [{ ...CFG.network,
                                                chainId: CFG.network.chainIdHex }] });
          else throw e;
        }
      }

      S.provider  = new ethers.providers.Web3Provider(window.ethereum);
      S.signer    = S.provider.getSigner();
      S.account   = acc;
      
      /* Instancias de contrato */
      const make = (addr, abi) => new ethers.Contract(addr, abi, S.signer);
      S.contracts.punks  = make(CFG.addresses.punks,  CFG.abi.punks);
      S.contracts.quest  = make(CFG.addresses.quest,  CFG.abi.quest);
      S.contracts.token  = make(CFG.addresses.token,  CFG.abi.erc20);
      
      /* Leer decimals & symbol */
      [S.decimals, S.symbol] = await Promise.all([
          S.contracts.token.decimals(),  S.contracts.token.symbol() ]);

      notify(E.ok, "Wallet conectada correctamente");
      renderAccount(); await bootstrapData();
    }

    function renderAccount() {
      E.accountBox.textContent = `${S.account.slice(0, 6)}…${S.account.slice(-4)}`;
      E.accountBox.parentElement.style.display = "block";
    }

    /* ------------------ 6.  CARGA INICIAL ------------------ */

    async function bootstrapData() {
      await Promise.all([loadFees(), loadBalance(), loadTokens(), loadStore()]);
    }

    /* --- 6-a  BALANCE -------------------------------------- */
    async function loadBalance() {
      const bal = await S.contracts.token.balanceOf(S.account);
      E.balBox.textContent = `$${S.symbol}: ${fmt(bal, S.decimals, 2)}`;
    }

    /* --- 6-b  COMISIONES ----------------------------------- */
    async function loadFees() {
      const Q = S.contracts.quest;
      const [activation, exit, claim, levelUp, extra] = await Promise.all([
        Q.activationFee(), Q.exitFee(), Q.claimFee(),
        Q.fastLevelUpgradeFee(), Q.extraSlotCost()
      ]);
      S.fees = { activation, exit, claim, levelUp, extra };
    }

    /* --- 6-c  TOKEN NFTs ----------------------------------- */
    async function loadTokens() {
      E.loadingTok.style.display = "block"; E.grid.innerHTML = "";
      const bal = (await S.contracts.punks.balanceOf(S.account)).toNumber();
      if (!bal) { E.noTok.style.display = "block"; return; }

      /* Obtener Ids mediante multicall */
      const iface = new ethers.utils.Interface(CFG.abi.punks);
      const calls = [...Array(bal).keys()].map(i => ({
          target: CFG.addresses.punks,
          allowFailure: false,
          callData: iface.encodeFunctionData("tokenOfOwnerByIndex", [S.account, i])
      }));
      const results = await new ethers.Contract(
            CFG.addresses.multicall,
            ["function aggregate3(tuple(address,bool,bytes)[]) view returns((bool,bytes)[])"],
            S.provider
          ).aggregate3(calls);

      S.ownedTokens = results.map(r =>
          iface.decodeFunctionResult("tokenOfOwnerByIndex", r.returnData)[0].toNumber());

      renderTokens();
    }

    /* Renderizado de tarjetas NFT */
    function renderTokens() {
      E.grid.innerHTML = "";
      S.ownedTokens.forEach(id => {
        const card = document.createElement("div");
        card.className = "token-card" + (S.selected.has(id) ? " selected-token" : "");
        card.onclick = () => toggleSelect(id);

        const img   = new Image();
        img.src     = `${CFG.imgPath}${id}.jpg`;
        img.onerror = () => (img.src = CFG.placeholder);
        card.append(img);

        const info  = document.createElement("div");
        info.className = "token-info";
        info.innerHTML = `<div class="token-title">Adrian #${id}</div>`;
        card.append(info);

        E.grid.append(card);
      });
      toggleUI();
    }

    /* Selección */
    function toggleSelect(id) {
      S.selected.has(id) ? S.selected.delete(id) : S.selected.add(id);
      renderTokens();
    }

    /* --- 6-d  TIENDA --------------------------------------- */
    async function loadStore() {
      E.storeLoad.style.display = "block";
      const nextId = (await S.contracts.quest.nextItemId()).toNumber();

      S.storeItems = [];
      for (let i = 1; i < nextId; i++) {
        const item = await S.contracts.quest.items(i);
        if (!item.exists) continue;       // omitidos no existentes
        S.storeItems.push({ id: i, ...item });
      }
      renderStore();
    }

    function renderStore(filter = "all") {
      E.storeGrid.innerHTML = "";
      const f = filter === "all" ? () => true :
                filter === "weapon" ? it => it.itemType === 0 :
                it => it.itemType === 1;

      S.storeItems.filter(f).forEach(it => {
        const card = document.createElement("div");
        card.className = "item-card";
        card.onclick = () => showItem(it);
        card.innerHTML = `
          <div class="item-type ${it.itemType === 0 ? "type-weapon" : "type-armor"}">
            ${it.itemType === 0 ? "Weapon" : "Armor"}
          </div>
          <div class="item-bonus">Bonus: ${it.bonus}%</div>
          <div class="item-durability">Durability: ${it.durability}</div>
          <div class="item-price">${fmt(it.price)} $${S.symbol}</div>`;
        E.storeGrid.append(card);
      });
      E.storeLoad.style.display = "none";
    }

    /* Item → modal */
    function showItem(item) {
      $("#itemDetailsTitle").textContent = `Item #${item.id}`;
      $("#itemDetailsContent").innerHTML = `
         <p><strong>Tipo:</strong> ${item.itemType === 0 ? "Weapon" : "Armor"}</p>
         <p><strong>Bono:</strong> ${item.bonus}%</p>
         <p><strong>Durabilidad:</strong> ${item.durability}</p>
         <p><strong>Precio:</strong> ${fmt(item.price)} $${S.symbol}</p>`;
      $("#addToCartModal").onclick = () => { addToCart(item.id, 1); };
      new bootstrap.Modal("#itemDetailsModal").show();
    }

    /* ------------------ 7.  CARRITO ------------------ */

    function addToCart(id, qty = 1) {
      const found = S.cart.find(i => i.id === id);
      found ? (found.qty += qty) : S.cart.push({ id, qty });
      renderCart();
    }

    function renderCart() {
      E.cartItems.innerHTML = "";
      let total = ethers.BigNumber.from(0);
      S.cart.forEach(it => {
        const storeIt = S.storeItems.find(s => s.id === it.id);
        const li = document.createElement("div");
        li.className = "cart-item";
        li.innerHTML = `
          <span>#${it.id} × ${it.qty}</span>
          <strong>${fmt(storeIt.price.mul(it.qty))}</strong>`;
        E.cartItems.append(li);
        total = total.add(storeIt.price.mul(it.qty));
      });
      E.cartTotal.textContent = `${fmt(total)} $${S.symbol}`;
      E.cartBadge.textContent = S.cart.length;
      E.checkoutBtn.disabled = !S.cart.length;
      E.cartSum.style.display = S.cart.length ? "block" : "none";
    }

    /* APROBAR → TOKEN */
    const approve = withLoad(async () => {
      const total = S.cart.reduce((sum, it) => {
        const price = S.storeItems.find(s => s.id === it.id).price;
        return sum.add(price.mul(it.qty));
      }, ethers.BigNumber.from(0));
      const allowance = await S.contracts.token.allowance(S.account, CFG.addresses.quest);
      if (allowance.gte(total)) return notify(E.ok, "Allowance suficiente 👍");

      const tx = await S.contracts.token.approve(CFG.addresses.quest, total);
      await tx.wait(); notify(E.ok, "Allowance actualizado");
    });

    const checkout = withLoad(async () => {
      for (const it of S.cart) {
        const tx = await S.contracts.quest.buyItem(it.id, it.qty);
        await tx.wait();
      }
      notify(E.ok, "¡Compra completada!");
      S.cart = []; renderCart(); await loadInventory();
    });

    /* ------------------ 8.  INVENTARIO ------------------ */

    async function loadInventory() {
      $("#loading-inventory").style.display = "block";
      const inv = {};
      await Promise.all(S.storeItems.map(async it => {
        const qty = await S.contracts.quest.inventory(S.account, it.id);
        if (qty.gt(0)) inv[it.id] = qty.toNumber();
      }));
      S.inventory = inv;
      renderInventory();
    }

    function renderInventory() {
      const list = $("#inventory-list");
      list.innerHTML = "";
      Object.entries(S.inventory).forEach(([id, qty]) => {
        const li = document.createElement("div");
        li.className = "inventory-item";
        li.innerHTML = `<span>Item #${id}</span><span class="inventory-count">${qty}</span>`;
        list.append(li);
      });
      $("#no-inventory-message").style.display = Object.keys(S.inventory).length ? "none" : "block";
      $("#loading-inventory").style.display = "none";
    }

    /* ------------------ 9.  TOKENS → ACCIONES ------------------ */

    const batch = withLoad(async (fnName, msg) => {
      if (!S.selected.size) return;
      const ids = [...S.selected];
      const tx  = await S.contracts.quest[fnName](ids);
      await tx.wait(); notify(E.ok, msg);
      await loadTokens(); S.selected.clear();
    });

    /* ------------------ 10.  UI & EVENTOS ------------------ */

    function toggleUI() {
      /* botones */
      const sel = S.selected.size;
      E.tokActions.style.display = sel ? "block" : "none";
      E.stakeBtn.textContent     = `Stake (${sel})`;
      E.unstakeBtn.textContent   = `Unstake (${sel})`;
      E.claimBtn.textContent     = `Claim (${sel})`;
      /* select-all */
      E.selectAll.textContent = sel === S.ownedTokens.length ? "Deselect All" : "Select All";
    }

    /* ------------------ 11.  INICIALIZACIÓN ------------------ */

    document.addEventListener('DOMContentLoaded', () => {
      // Event listeners para los botones
      E.connectBtn.addEventListener('click', withLoad(connect));
      E.selectAll.addEventListener('click', () => {
        if (S.selected.size === S.ownedTokens.length) S.selected.clear();
        else S.ownedTokens.forEach(id => S.selected.add(id));
        renderTokens();
      });

      // Event listeners para las pestañas
      E.tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          const target = e.target.dataset.bsTarget;
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
          });
          document.querySelector(target).classList.add('active');
          E.tabs.forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
          if (e.target.id === 'inventoryTab') loadInventory();
        });
      });

      // Botones de acciones
      E.stakeBtn.addEventListener('click', () => batch("batchStake", "Tokens stakeados"));
      E.unstakeBtn.addEventListener('click', () => batch("batchUnstake", "Tokens des-stakeados"));
      E.claimBtn.addEventListener('click', () => batch("batchClaimRewards", "Recompensas reclamadas"));
      E.lvlBtn.addEventListener('click', withLoad(async () => {
        if (S.selected.size !== 1) return notify(E.error, "Selecciona solo 1 token");
        const tokenId = [...S.selected][0];
        const tx = await S.contracts.quest.purchaseFastLevelUpgrade(tokenId);
        await tx.wait(); notify(E.ok, "Token subido de nivel");
      }));

      // Botones del carrito
      E.approveBtn.addEventListener('click', approve);
      E.checkoutBtn.addEventListener('click', checkout);

      // Verificar si la wallet ya está conectada
      if (window.ethereum) {
        window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
          if (accounts.length > 0) withLoad(connect)();
        });
      }
    });
  </script>
</body>
</html>