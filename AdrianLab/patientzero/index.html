<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatientZERO - Rehabilitation Center</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'VT323', monospace;
            background: #1a1a1a;
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 4.5rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 .patient {
            color: #ff4444;
        }

        .header h1 .zero {
            color: #00ff00;
        }

        .header .subtitle {
            font-size: 1.45rem;
            color: #cccccc;
            margin-bottom: 20px;
            font-family: 'VT323', monospace;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            color: #aaaaaa;
        }

        .connect-section {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .connect-btn {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-family: 'VT323', monospace;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .account-section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .wallet-address {
            background: #2a2a2a;
            padding: 10px 15px;
            border-radius: 10px;
            font-family: monospace;
            font-weight: bold;
            color: #00ff00;
        }

        .disconnect-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'VT323', monospace;
        }

        .disconnect-btn:hover {
            background: #c82333;
        }

        .main-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
            font-family: 'VT323', monospace;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: #333;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-family: 'VT323', monospace;
        }

        .tab-btn.active {
            background: #ff4444;
        }

        .tab-btn:hover {
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: 1px solid #333;
            position: relative;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .profile-image {
            width: 100%;
            height: 200px;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .profile-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff00;
            font-size: 1.2rem;
        }

        .profile-info {
            padding: 20px;
        }

        .profile-name {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff4444;
        }

        .profile-reward {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #00ff00;
        }

        .profile-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #cccccc;
        }

        .profile-traits {
            margin-bottom: 15px;
        }

        .traits-title {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .trait-tag {
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .claim-btn {
            width: 100%;
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,0,0.3);
        }

        .claim-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .my-adrians-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .adrian-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: 1px solid #333;
            cursor: pointer;
        }

        .adrian-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .adrian-card.selected {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .adrian-image {
            width: 100%;
            height: 200px;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .adrian-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .adrian-info {
            padding: 15px;
        }

        .adrian-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .adrian-id {
            font-size: 1rem;
            color: #cccccc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #00ff00;
            font-size: 1.2rem;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff4444;
            font-size: 1.2rem;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #cccccc;
            font-size: 1.2rem;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 1.1rem;
        }

        .status-success {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .status-error {
            background: rgba(255, 0, 0, 0.1);
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        .status-loading {
            background: rgba(0, 0, 255, 0.1);
            color: #0088ff;
            border: 1px solid #0088ff;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 3rem;
            }
            
            .profiles-grid {
                grid-template-columns: 1fr;
            }
            
            .my-adrians-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="patient">Patient</span><span class="zero">ZERO</span></h1>
            <div class="subtitle">Rehabilitation Center</div>
            <p>Find and recover Adrians matching specific trait profiles</p>
        </div>

        <div class="connect-section" id="connectSection">
            <h2>Connect Your Wallet</h2>
            <p>Connect your wallet to access the rehabilitation center</p>
            <button class="connect-btn" id="connectBtn">Connect Wallet</button>
        </div>

        <div class="account-section" id="accountSection">
            <div class="wallet-info">
                <div>
                    <strong>Connected:</strong>
                    <span class="wallet-address" id="walletAddress"></span>
                </div>
                <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>
            </div>
        </div>

        <div class="main-section" id="mainSection" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" data-tab="bounties">Active Bounties</button>
                <button class="tab-btn" data-tab="my-adrians">My Adrians</button>
            </div>

            <div class="tab-content active" id="bounties-tab">
                <div class="section-title">Active Bounty Profiles</div>
                <div id="profilesGrid" class="profiles-grid">
                    <div class="loading">Loading bounty profiles...</div>
                </div>
            </div>

            <div class="tab-content" id="my-adrians-tab">
                <div class="section-title">My Adrians</div>
                <div id="adriansGrid" class="my-adrians-grid">
                    <div class="loading">Loading your AdrianZERO tokens...</div>
                </div>
            </div>
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>

    <script>
        // Configuration
        const PATIENTZERO_CONTRACT = '0x3609806f1ddd58850b995229a4b9cc9a4127ae45';
        const ADRIANZERO_CONTRACT = '0x6E369BF0E4e0c106192D606FB6d85836d684DA75';
        const ALCHEMY_API_KEY = '5qIXA1UZxOAzi8b9l0nrYmsQBO9-W7Ot';
        const NETWORK = 'base-mainnet';

        // State variables
        let currentAccount = null;
        let patientZeroContract = null;
        let adrianCoreContract = null;
        let myAdrians = [];
        let activeProfiles = [];
        let selectedAdrian = null;

        // DOM elements
        const connectSection = document.getElementById('connectSection');
        const accountSection = document.getElementById('accountSection');
        const mainSection = document.getElementById('mainSection');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const walletAddress = document.getElementById('walletAddress');
        const profilesGrid = document.getElementById('profilesGrid');
        const adriansGrid = document.getElementById('adriansGrid');
        const statusMessage = document.getElementById('statusMessage');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkWalletConnection();
        });

        function setupEventListeners() {
            connectBtn.addEventListener('click', connectWallet);
            disconnectBtn.addEventListener('click', disconnectWallet);
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const tabId = btn.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    updateUI();
                    loadData();
                }
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showStatus('Please install MetaMask to use this application', 'error');
                return;
            }

            try {
                showStatus('Connecting to wallet...', 'loading');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                updateUI();
                loadData();
                showStatus('Wallet connected successfully!', 'success');
            } catch (error) {
                showStatus('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        function disconnectWallet() {
            currentAccount = null;
            updateUI();
            showStatus('Wallet disconnected', 'success');
        }

        function updateUI() {
            if (currentAccount) {
                connectSection.style.display = 'none';
                accountSection.style.display = 'block';
                mainSection.style.display = 'block';
                walletAddress.textContent = currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
            } else {
                connectSection.style.display = 'block';
                accountSection.style.display = 'none';
                mainSection.style.display = 'none';
            }
        }

        async function loadData() {
            if (!currentAccount) return;
            
            await Promise.all([
                loadActiveProfiles(),
                loadMyAdrians()
            ]);
        }

        async function loadActiveProfiles() {
            try {
                showStatus('Loading active bounty profiles...', 'loading');
                
                // Load ethers if not available
                if (typeof window.ethers === 'undefined') {
                    await loadEthers();
                }

                const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                const contract = new window.ethers.Contract(PATIENTZERO_CONTRACT, getPatientZeroABI(), provider);
                
                // Get active profile IDs
                const activeProfileIds = await contract.getActiveProfiles();
                
                // Get profile details for each active profile
                const profiles = [];
                for (const profileId of activeProfileIds) {
                    const profile = await contract.getProfile(profileId);
                    profiles.push({
                        id: profileId,
                        name: profile.profileName,
                        traitIds: profile.traitIds,
                        reward: profile.reward,
                        active: profile.active,
                        recovered: profile.recovered
                    });
                }
                
                activeProfiles = profiles;
                displayProfiles(profiles);
                showStatus(`Loaded ${profiles.length} active bounty profiles`, 'success');
                
            } catch (error) {
                console.error('Error loading profiles:', error);
                showStatus('Error loading bounty profiles: ' + error.message, 'error');
                profilesGrid.innerHTML = '<div class="error">Failed to load bounty profiles</div>';
            }
        }

        async function loadMyAdrians() {
            try {
                showStatus('Loading your AdrianZERO tokens...', 'loading');
                
                // Load specifically ERC721 tokens from AdrianZERO contract
                const response = await fetch(`https://${NETWORK}.g.alchemy.com/nft/v3/${ALCHEMY_API_KEY}/getNFTsForOwner?owner=${currentAccount}&contractAddresses=${ADRIANZERO_CONTRACT}&withMetadata=true&pageSize=50&tokenType=ERC721`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Alchemy API error:', response.status, errorText);
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('AdrianZERO data received:', data);
                
                // Process and filter AdrianZERO tokens
                myAdrians = (data.ownedNfts || []).map(nft => {
                    // First, verify this is from the AdrianZERO contract
                    if (nft.contract && nft.contract.address.toLowerCase() !== ADRIANZERO_CONTRACT.toLowerCase()) {
                        console.log(`Skipping token from different contract: ${nft.contract.address}`);
                        return null;
                    }
                    
                    // Extract tokenId
                    let tokenId;
                    if (nft.tokenId) {
                        tokenId = nft.tokenId;
                    } else if (nft.id && nft.id.tokenId) {
                        tokenId = nft.id.tokenId;
                    } else {
                        console.error("No tokenId found in NFT:", nft);
                        return null;
                    }
                    
                    // Convert tokenId to integer
                    let tokenIdInt;
                    if (typeof tokenId === 'number') {
                        tokenIdInt = tokenId;
                    } else if (tokenId.startsWith('0x')) {
                        tokenIdInt = parseInt(tokenId, 16);
                    } else {
                        tokenIdInt = parseInt(tokenId, 10);
                    }
                    
                    if (isNaN(tokenIdInt)) {
                        console.error("Invalid tokenId format:", tokenId);
                        return null;
                    }
                    
                    // Extract title/name
                    let title = `Adrian #${tokenIdInt}`;
                    if (nft.title) {
                        title = nft.title;
                    } else if (nft.name) {
                        title = nft.name;
                    } else if (nft.metadata && nft.metadata.name) {
                        title = nft.metadata.name;
                    }
                    
                    // Extract image URL with multiple fallbacks
                    let imageUrl = "";
                    
                    // Try multiple locations for image URL (same logic as traitlab)
                    if (nft.raw && nft.raw.metadata && nft.raw.metadata.image) {
                        imageUrl = nft.raw.metadata.image;
                    } else if (nft.media && Array.isArray(nft.media) && nft.media.length > 0) {
                        const mediaSources = ['gateway', 'raw', 'thumbnail', 'format'];
                        for (const source of mediaSources) {
                            if (nft.media[0][source] && typeof nft.media[0][source] === 'string') {
                                imageUrl = nft.media[0][source];
                                break;
                            }
                        }
                    } else if (nft.metadata) {
                        const imageProps = ['image', 'image_url', 'imageUrl', 'imageURI', 'image_uri', 'imageData'];
                        for (const prop of imageProps) {
                            if (nft.metadata[prop] && typeof nft.metadata[prop] === 'string') {
                                imageUrl = nft.metadata[prop];
                                break;
                            }
                        }
                    }
                    
                    // Clean up IPFS URLs
                    if (imageUrl && imageUrl.startsWith('ipfs://')) {
                        imageUrl = imageUrl.replace('ipfs://', 'https://ipfs.io/ipfs/');
                    }
                    
                    return {
                        tokenId: tokenIdInt,
                        title: title,
                        imageUrl: imageUrl,
                        contract: nft.contract.address,
                        contractName: nft.contract.name || 'AdrianZERO',
                        metadata: nft.metadata || {}
                    };
                }).filter(token => token !== null);
                
                console.log('Processed AdrianZERO tokens:', myAdrians);
                displayMyAdrians(myAdrians);
                showStatus(`Loaded ${myAdrians.length} AdrianZERO tokens`, 'success');
                
            } catch (error) {
                console.error('Error loading AdrianZERO tokens:', error);
                showStatus('Error loading your AdrianZERO tokens: ' + error.message, 'error');
                adriansGrid.innerHTML = '<div class="error">Failed to load your AdrianZERO tokens</div>';
            }
        }

        function displayProfiles(profiles) {
            if (profiles.length === 0) {
                profilesGrid.innerHTML = '<div class="no-data">No active bounty profiles found</div>';
                return;
            }

            profilesGrid.innerHTML = profiles.map(profile => `
                <div class="profile-card">
                    <div class="profile-image">
                        <div class="image-loading">Generating preview...</div>
                        <img src="" alt="${profile.name}" style="display: none;" onload="this.style.display='block'; this.previousElementSibling.style.display='none';" onerror="this.previousElementSibling.textContent='Image failed to load'; this.previousElementSibling.style.background='rgba(255,0,0,0.1)';">
                    </div>
                    <div class="profile-info">
                        <div class="profile-name">${profile.name}</div>
                        <div class="profile-reward">Reward: ${window.ethers.utils.formatEther(profile.reward)} $ADRIAN</div>
                        <div class="profile-stats">
                            <span>Recovered: ${profile.recovered}</span>
                            <span>Profile ID: ${profile.id}</span>
                        </div>
                        <div class="profile-traits">
                            <div class="traits-title">Required Traits:</div>
                            <div class="traits-list">
                                ${profile.traitIds.map(traitId => `<span class="trait-tag">${traitId}</span>`).join('')}
                            </div>
                        </div>
                        <button class="claim-btn" onclick="claimBounty(${profile.id})" disabled>
                            Select Adrian First
                        </button>
                    </div>
                </div>
            `).join('');

            // Generate images for each profile
            profiles.forEach((profile, index) => {
                generateProfileImage(profile, index);
            });
        }

        function displayMyAdrians(adrians) {
            if (adrians.length === 0) {
                adriansGrid.innerHTML = '<div class="no-data">No AdrianZERO tokens found</div>';
                return;
            }

            adriansGrid.innerHTML = adrians.map(adrian => `
                <div class="adrian-card" onclick="selectAdrian('${adrian.tokenId}')">
                    <div class="adrian-image">
                        <img src="${adrian.imageUrl}" alt="${adrian.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMkEyQTJBIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+'">
                    </div>
                    <div class="adrian-info">
                        <div class="adrian-name">${adrian.title}</div>
                        <div class="adrian-id">Token ID: ${adrian.tokenId}</div>
                    </div>
                </div>
            `).join('');
        }

        function selectAdrian(tokenId) {
            // Remove previous selection
            document.querySelectorAll('.adrian-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            event.currentTarget.classList.add('selected');
            
            selectedAdrian = tokenId;
            
            // Update claim buttons
            document.querySelectorAll('.claim-btn').forEach(btn => {
                btn.textContent = 'Claim Bounty';
                btn.disabled = false;
            });
            
            showStatus(`Selected Adrian #${tokenId}`, 'success');
        }

        async function claimBounty(profileId) {
            if (!selectedAdrian) {
                showStatus('Please select an Adrian first', 'error');
                return;
            }

            try {
                showStatus('Preparing bounty claim transaction...', 'loading');
                
                const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contract = new window.ethers.Contract(PATIENTZERO_CONTRACT, getPatientZeroABI(), signer);
                
                const tx = await contract.claimBounty(selectedAdrian, profileId);
                showStatus('Transaction sent! Waiting for confirmation...', 'loading');
                
                await tx.wait();
                showStatus('Bounty claimed successfully! Adrian has been deposited.', 'success');
                
                // Refresh data
                await loadData();
                
            } catch (error) {
                console.error('Error claiming bounty:', error);
                showStatus('Error claiming bounty: ' + error.message, 'error');
            }
        }

        async function generateProfileImage(profile, index) {
            try {
                // Build query parameters from trait IDs
                const queryParams = profile.traitIds.map(traitId => `trait=${traitId}`);
                const queryString = queryParams.join('&');
                
                // Use a placeholder token ID (1) for the base image
                const imageUrl = `https://adrianlab.vercel.app/api/render/custom/1?${queryString}`;
                
                // Update the image source
                const profileCards = document.querySelectorAll('.profile-card');
                if (profileCards[index]) {
                    const img = profileCards[index].querySelector('img');
                    if (img) {
                        img.src = imageUrl;
                    }
                }
                
            } catch (error) {
                console.error('Error generating profile image:', error);
            }
        }

        async function loadEthers() {
            return new Promise((resolve, reject) => {
                if (typeof window.ethers !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load ethers'));
                document.head.appendChild(script);
            });
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        function getPatientZeroABI() {
            return [
                "function getActiveProfiles() external view returns (uint256[] memory)",
                "function getProfile(uint256 profileId) external view returns (string memory profileName, uint256[] memory traitIds, uint256 reward, bool active, uint256 recovered)",
                "function claimBounty(uint256 tokenId, uint256 profileId) external",
                "function isPatientZERO(uint256 tokenId, uint256 profileId) external view returns (bool)"
            ];
        }

        // Handle wallet changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    currentAccount = accounts[0];
                    updateUI();
                    loadData();
                }
            });
        }
    </script>
</body>
</html> 