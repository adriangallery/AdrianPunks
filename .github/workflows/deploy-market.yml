name: Deploy Market to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'market/index.html'
      - '.github/workflows/deploy-market.yml'
      - 'market/**/*.js'
      - 'market/**/*.css'
      - 'market/**/*.json'
      - 'swap/**'
      - 'index.html'
      - 'components/**'
      - 'quest/**'
      - 'toggler/**'
      - 'activity/**'
      - 'dump/**'
      - 'lib/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy-pages.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Inject Alchemy API key into HTML files
        run: |
          echo "üîç Verificando secret ALCHEMY_API_KEY..."
          if [ -z "${{ secrets.ALCHEMY_API_KEY }}" ]; then
            echo "‚ùå ERROR: ALCHEMY_API_KEY secret is not set or is empty"
            echo "   Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   Add secret named: ALCHEMY_API_KEY"
            exit 1
          fi

          echo "‚úÖ Secret encontrado (length: ${#ALCHEMY_API_KEY})"
          echo "üîß Inyectando ALCHEMY_API_KEY directamente en archivos HTML..."

          # Create inline script with API key
          INLINE_SCRIPT="<script>window.ALCHEMY_API_KEY = '${{ secrets.ALCHEMY_API_KEY }}';</script>"

          echo "üìù Script a inyectar:"
          echo "   <script>window.ALCHEMY_API_KEY = '[REDACTED]';</script>"

          # Inject into market/index.html (before closing </head>)
          echo "üìÑ Procesando market/index.html..."
          sed -i.bak "s|</head>|  ${INLINE_SCRIPT}\n</head>|" market/index.html
          echo "‚úÖ Inyectado en market/index.html"

          # Inject into marketosintegration/index.html
          echo "üìÑ Procesando marketosintegration/index.html..."
          sed -i.bak "s|</head>|  ${INLINE_SCRIPT}\n</head>|" marketosintegration/index.html
          echo "‚úÖ Inyectado en marketosintegration/index.html"

          # Verify injection
          echo "üîç Verificando inyecci√≥n..."
          if grep -q "window.ALCHEMY_API_KEY" market/index.html; then
            echo "‚úÖ Verificaci√≥n exitosa - API key encontrado en HTML"
            KEY_LENGTH=$(echo -n "${{ secrets.ALCHEMY_API_KEY }}" | wc -c)
            echo "   Secret length: ${KEY_LENGTH} chars"
            echo "   First 10 chars: $(echo "${{ secrets.ALCHEMY_API_KEY }}" | cut -c1-10)..."
          else
            echo "‚ùå ERROR: No se pudo inyectar el API key"
            echo "   Contenido cerca de </head>:"
            grep -A 2 -B 2 "</head>" market/index.html || true
            exit 1
          fi

      - name: Prepare deploy folder with subpath /market
        run: |
          echo "üì¶ Preparando carpeta de despliegue..."
          rm -rf site-dist
          mkdir -p site-dist/market

          # Copiar ra√≠z del sitio (index, favicon) para evitar 404 en /
          cp index.html site-dist/ || true
          cp favicon.ico site-dist/ || true

          # Copiar favicon usado por swap
          if [ -f adrian1.ico ]; then
            cp adrian1.ico site-dist/
          elif [ -f favicon.ico ]; then
            cp favicon.ico site-dist/adrian1.ico
          fi

          # Copiar market y swap (con API key ya inyectado)
          echo "üìÅ Copiando market con API key inyectado..."
          cp -r market/* site-dist/market/
          cp -r swap site-dist/swap

          # Verificar que el API key est√° inyectado
          if grep -q "window.ALCHEMY_API_KEY" site-dist/market/index.html; then
            echo "‚úÖ API key verificado en site-dist/market/index.html"
          else
            echo "‚ùå ERROR: API key no encontrado en HTML desplegado"
            exit 1
          fi

          # Copiar components para index.html
          if [ -d components ]; then
            cp -r components site-dist/components
          fi

          # Copiar quest para quest/index.html
          if [ -d quest ]; then
            cp -r quest site-dist/quest
          fi

          # Copiar toggler para toggler/index.html (referenciado en men√∫s)
          if [ -d toggler ]; then
            cp -r toggler site-dist/toggler
          fi

          # Copiar activity para activity/index.html (referenciado en men√∫s)
          if [ -d activity ]; then
            cp -r activity site-dist/activity
          fi

          # Copiar dump para dump/index.html
          if [ -d dump ]; then
            cp -r dump site-dist/dump
          fi

          # Copiar lib para database.js
          if [ -d lib ]; then
            cp -r lib site-dist/lib
          fi

          echo "adrianpunks.com" > site-dist/CNAME
          echo "‚úÖ Preparaci√≥n completa"

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site-dist

      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v4

