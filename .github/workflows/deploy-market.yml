name: Deploy Market to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'market/index.html'
      - '.github/workflows/deploy-market.yml'
      - 'market/supabase-config.js'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Supabase config file
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ] || [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "Error: SUPABASE_URL or SUPABASE_ANON_KEY secrets are not set"
            exit 1
          fi
          if [ -z "${{ secrets.ALCHEMY_API_KEY }}" ]; then
            echo "Error: ALCHEMY_API_KEY secret is not set"
            exit 1
          fi
          echo "Creating Supabase config file..."
          mkdir -p market
          cat > market/supabase-config.js << EOF
          // Auto-generated by GitHub Actions - DO NOT EDIT
          window.SUPABASE_URL = '${{ secrets.SUPABASE_URL }}';
          window.SUPABASE_ANON_KEY = '${{ secrets.SUPABASE_ANON_KEY }}';
          window.ALCHEMY_API_KEY = '${{ secrets.ALCHEMY_API_KEY }}';
          EOF
          echo "Config file created successfully"

      - name: Verify config file
        run: |
          if [ ! -f "market/supabase-config.js" ]; then
            echo "Error: supabase-config.js file not created"
            exit 1
          fi
          if ! grep -q "window.SUPABASE_URL" market/supabase-config.js; then
            echo "Error: SUPABASE_URL not found in config file"
            exit 1
          fi
          if ! grep -q "window.SUPABASE_ANON_KEY" market/supabase-config.js; then
            echo "Error: SUPABASE_ANON_KEY not found in config file"
            exit 1
          fi
          if ! grep -q "window.ALCHEMY_API_KEY" market/supabase-config.js; then
            echo "Error: ALCHEMY_API_KEY not found in config file"
            exit 1
          fi
          echo "Config file verified successfully"
          echo "First 20 chars of SUPABASE_URL: $(grep -o "window.SUPABASE_URL = '[^']*'" market/supabase-config.js | sed "s/.*'\(.\{20\}\).*/\1/")"
          echo "First 20 chars of SUPABASE_ANON_KEY: $(grep -o "window.SUPABASE_ANON_KEY = '[^']*'" market/supabase-config.js | sed "s/.*'\(.\{20\}\).*/\1/")"
          echo "First 20 chars of ALCHEMY_API_KEY: $(grep -o "window.ALCHEMY_API_KEY = '[^']*'" market/supabase-config.js | sed "s/.*'\(.\{20\}\).*/\1/")"

      - name: Commit and push config file to main
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add market/supabase-config.js
          git diff --staged --quiet || git commit -m "chore: Update Supabase config [skip ci]"
          git push origin main

