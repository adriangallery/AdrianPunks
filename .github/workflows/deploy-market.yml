name: Deploy Market to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'market/index.html'
      - '.github/workflows/deploy-market.yml'
      - 'market/**/*.js'
      - 'market/**/*.css'
      - 'market/**/*.json'
      - 'swap/**'
      - 'index.html'
      - 'components/**'
      - 'quest/**'
      - 'toggler/**'
      - 'activity/**'
      - 'dump/**'
      - 'lib/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy-pages.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove existing config files from repository
        run: |
          echo "Removing existing config files from repository to ensure clean generation..."
          rm -f market/supabase-config.js
          rm -f market/runtime-config.js
          echo "✅ Existing files removed"

      - name: Create Supabase config files from GitHub Secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ] || [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "Error: SUPABASE_URL or SUPABASE_ANON_KEY secrets are not set"
            exit 1
          fi
          if [ -z "${{ secrets.ALCHEMY_API_KEY }}" ]; then
            echo "Error: ALCHEMY_API_KEY secret is not set"
            exit 1
          fi
          echo "Creating Supabase config files from GitHub Secrets..."
          mkdir -p market
          # Generate file using printf to properly escape and include secrets
          {
            echo "// Auto-generated by GitHub Actions during deployment - DO NOT EDIT MANUALLY"
            echo "// This file is generated from GitHub Secrets and should not contain hardcoded values"
            echo "// Values are injected during deployment by GitHub Actions workflows"
            echo "// Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            printf "window.SUPABASE_URL = '%s';\n" "${{ secrets.SUPABASE_URL }}"
            printf "window.SUPABASE_ANON_KEY = '%s';\n" "${{ secrets.SUPABASE_ANON_KEY }}"
            printf "window.ALCHEMY_API_KEY = '%s';\n" "${{ secrets.ALCHEMY_API_KEY }}"
          } | tee market/supabase-config.js > market/runtime-config.js
          echo "✅ Config files created successfully from GitHub Secrets"
          echo "supabase-config.js size: $(wc -c < market/supabase-config.js) bytes"
          echo "runtime-config.js size: $(wc -c < market/runtime-config.js) bytes"
          echo "File content (first 300 chars of runtime-config.js):"
          head -c 300 market/runtime-config.js
          echo ""

      - name: Verify config file
        run: |
          if [ ! -f "market/supabase-config.js" ]; then
            echo "Error: supabase-config.js file not created"
            exit 1
          fi
          if ! grep -q "window.SUPABASE_URL" market/supabase-config.js; then
            echo "Error: SUPABASE_URL not found in config file"
            exit 1
          fi
          if ! grep -q "window.SUPABASE_ANON_KEY" market/supabase-config.js; then
            echo "Error: SUPABASE_ANON_KEY not found in config file"
            exit 1
          fi
          if ! grep -q "window.ALCHEMY_API_KEY" market/supabase-config.js; then
            echo "Error: ALCHEMY_API_KEY not found in config file"
            exit 1
          fi
          if [ ! -f "market/runtime-config.js" ]; then
            echo "Error: runtime-config.js file not created"
            exit 1
          fi
          if ! diff -q market/supabase-config.js market/runtime-config.js >/dev/null; then
            echo "Warning: runtime-config.js differs from supabase-config.js"
          fi
          echo "Config file verified successfully"
          echo "First 20 chars of SUPABASE_URL: $(grep -o "window.SUPABASE_URL = '[^']*'" market/supabase-config.js | sed "s/.*'\(.\{20\}\).*/\1/")"
          echo "First 20 chars of SUPABASE_ANON_KEY: $(grep -o "window.SUPABASE_ANON_KEY = '[^']*'" market/supabase-config.js | sed "s/.*'\(.\{20\}\).*/\1/")"
          echo "First 20 chars of ALCHEMY_API_KEY: $(grep -o "window.ALCHEMY_API_KEY = '[^']*'" market/supabase-config.js | sed "s/.*'\(.\{20\}\).*/\1/")"

      - name: Verify generated file before deploy
        run: |
          echo "Verifying supabase-config.js content before deploy..."
          if [ -f "market/supabase-config.js" ]; then
            echo "File exists, checking content..."
            if grep -q "window.SUPABASE_URL = ''" market/supabase-config.js; then
              echo "❌ ERROR: File still has empty values!"
              exit 1
            fi
            if ! grep -q "https://" market/supabase-config.js; then
              echo "❌ ERROR: SUPABASE_URL is not a valid URL!"
              exit 1
            fi
            echo "✅ File verified - contains real values"
            echo "File size: $(wc -c < market/supabase-config.js) bytes"
            echo "File location: $(pwd)/market/supabase-config.js"
            ls -la market/supabase-config.js
            echo "First few lines:"
            head -5 market/supabase-config.js
          else
            echo "❌ ERROR: File does not exist!"
            exit 1
          fi
          echo "Verifying runtime-config.js mirrors supabase-config.js..."
          if [ -f "market/runtime-config.js" ]; then
            ls -la market/runtime-config.js
            head -5 market/runtime-config.js
            if ! diff -q market/supabase-config.js market/runtime-config.js >/dev/null; then
              echo "❌ ERROR: runtime-config.js differs from supabase-config.js!"
              exit 1
            fi
          else
            echo "❌ ERROR: runtime-config.js does not exist!"
            exit 1
          fi

      - name: List files in market directory before deploy
        run: |
          echo "Files in market/ directory:"
          ls -la market/ | grep -E "supabase|\.js$" | head -20
          echo ""
          echo "Content of supabase-config.js before deploy:"
          cat market/supabase-config.js
          echo ""
          echo "Content of runtime-config.js before deploy:"
          cat market/runtime-config.js
          echo ""
          echo "Verifying file has real values (not empty):"
          if grep -q "window.SUPABASE_URL = ''" market/supabase-config.js; then
            echo "❌ ERROR: File has empty values!"
            exit 1
          fi
          if ! grep -q "https://" market/supabase-config.js; then
            echo "❌ ERROR: SUPABASE_URL is not a valid URL!"
            exit 1
          fi
          echo "✅ File verified - contains real values"

      - name: Final verification before deploy
        run: |
          echo "Final verification of supabase-config.js:"
          if [ ! -f "market/supabase-config.js" ]; then
            echo "❌ ERROR: File does not exist!"
            exit 1
          fi
          echo "File exists. Content:"
          cat market/supabase-config.js
          echo ""
          if grep -q "window.SUPABASE_URL = ''" market/supabase-config.js; then
            echo "❌ ERROR: File has empty values!"
            exit 1
          fi
          if ! grep -q "https://" market/supabase-config.js; then
            echo "❌ ERROR: SUPABASE_URL is not a valid URL!"
            exit 1
          fi
          echo "✅ Final verification passed - file ready for deploy"
          echo "Final verification of runtime-config.js:"
          if [ ! -f "market/runtime-config.js" ]; then
            echo "❌ ERROR: runtime-config.js does not exist!"
            exit 1
          fi
          if grep -q "window.SUPABASE_URL = ''" market/runtime-config.js; then
            echo "❌ ERROR: runtime-config.js has empty values!"
            exit 1
          fi
          if ! grep -q "https://" market/runtime-config.js; then
            echo "❌ ERROR: runtime-config.js SUPABASE_URL is not a valid URL!"
            exit 1
          fi
          if ! diff -q market/supabase-config.js market/runtime-config.js >/dev/null; then
            echo "❌ ERROR: runtime-config.js differs from supabase-config.js!"
            exit 1
          fi
          echo "✅ runtime-config.js verified"

      - name: Prepare deploy folder with subpath /market
        run: |
          rm -rf site-dist
          mkdir -p site-dist/market
          # Copiar raíz del sitio (index, favicon) para evitar 404 en /
          cp index.html site-dist/ || true
          cp favicon.ico site-dist/ || true
          # Copiar favicon usado por swap
          if [ -f adrian1.ico ]; then
            cp adrian1.ico site-dist/
          elif [ -f favicon.ico ]; then
            cp favicon.ico site-dist/adrian1.ico
          fi
          # Copiar market y swap
          cp -r market/* site-dist/market/
          cp -r swap site-dist/swap
          # Copiar components para index.html
          if [ -d components ]; then
            cp -r components site-dist/components
          fi
          # Copiar quest para quest/index.html
          if [ -d quest ]; then
            cp -r quest site-dist/quest
          fi
          # Copiar toggler para toggler/index.html (referenciado en menús)
          if [ -d toggler ]; then
            cp -r toggler site-dist/toggler
          fi
          # Copiar activity para activity/index.html (referenciado en menús)
          if [ -d activity ]; then
            cp -r activity site-dist/activity
          fi
          # Copiar dump para dump/index.html
          if [ -d dump ]; then
            cp -r dump site-dist/dump
          fi
          # Copiar lib para database.js (SQLite)
          if [ -d lib ]; then
            cp -r lib site-dist/lib
          fi
          # Copiar config también a swap por seguridad (referencia relativa y redundancia)
          if [ -f market/supabase-config.js ]; then
            cp market/supabase-config.js site-dist/swap/supabase-config.js
            cp market/runtime-config.js site-dist/swap/runtime-config.js || true
          fi
          echo "adrianpunks.com" > site-dist/CNAME

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site-dist

      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v4

