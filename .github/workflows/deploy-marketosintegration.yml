name: Deploy marketosintegration with OpenSea config

on:
  push:
    branches:
      - main
    paths:
      - 'marketosintegration/**'
      - '.github/workflows/deploy-marketosintegration.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy-marketosintegration:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy-pages.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove existing config files (marketosintegration)
        run: |
          echo "Removing existing config files to ensure clean generation..."
          rm -f marketosintegration/supabase-config.js
          rm -f marketosintegration/runtime-config.js
          rm -f marketosintegration/opensea-config.js
          echo "✅ Existing files removed"

      - name: Generate config files from GitHub Secrets (Supabase / Alchemy) for marketosintegration
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ] || [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "Error: SUPABASE_URL or SUPABASE_ANON_KEY secrets are not set"
            exit 1
          fi
          if [ -z "${{ secrets.ALCHEMY_API_KEY }}" ]; then
            echo "Error: ALCHEMY_API_KEY secret is not set"
            exit 1
          fi
          mkdir -p marketosintegration
          {
            echo "// Auto-generated by GitHub Actions during deployment - DO NOT EDIT MANUALLY"
            echo "// Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            printf "window.SUPABASE_URL = '%s';\n" "${{ secrets.SUPABASE_URL }}"
            printf "window.SUPABASE_ANON_KEY = '%s';\n" "${{ secrets.SUPABASE_ANON_KEY }}"
            printf "window.ALCHEMY_API_KEY = '%s';\n" "${{ secrets.ALCHEMY_API_KEY }}"
          } | tee marketosintegration/supabase-config.js > marketosintegration/runtime-config.js
          echo "✅ Supabase/Alchemy configs generated"

      - name: Generate config files from GitHub Secrets (Supabase / Alchemy) for market
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ] || [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "Error: SUPABASE_URL or SUPABASE_ANON_KEY secrets are not set"
            exit 1
          fi
          if [ -z "${{ secrets.ALCHEMY_API_KEY }}" ]; then
            echo "Error: ALCHEMY_API_KEY secret is not set"
            exit 1
          fi
          mkdir -p market
          {
            echo "// Auto-generated by GitHub Actions during deployment - DO NOT EDIT MANUALLY"
            echo "// Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            printf "window.SUPABASE_URL = '%s';\n" "${{ secrets.SUPABASE_URL }}"
            printf "window.SUPABASE_ANON_KEY = '%s';\n" "${{ secrets.SUPABASE_ANON_KEY }}"
            printf "window.ALCHEMY_API_KEY = '%s';\n" "${{ secrets.ALCHEMY_API_KEY }}"
          } | tee market/supabase-config.js > market/runtime-config.js
          echo "✅ Supabase/Alchemy configs generated (market)"

      - name: Generate OpenSea config from GitHub Secrets
        run: |
          if [ -z "${{ secrets.OPENSEA_COLLECTION_SLUG }}" ]; then
            echo "Error: OPENSEA_COLLECTION_SLUG secret is not set"
            exit 1
          fi
          # At least one API credential must exist
          if [ -z "${{ secrets.OPENSEA_API_KEY }}" ] && [ -z "${{ secrets.OPENSEA_MCP_TOKEN }}" ] && [ -z "${{ secrets.OPENSEA_API_KEY_FALLBACK }}" ]; then
            echo "Error: No OpenSea API key provided (set OPENSEA_API_KEY or OPENSEA_MCP_TOKEN or OPENSEA_API_KEY_FALLBACK)"
            exit 1
          fi
          {
            echo "// Auto-generated by GitHub Actions during deployment - DO NOT EDIT MANUALLY"
            echo "// Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            printf "window.OPENSEA_API_KEY = '%s';\n" "${{ secrets.OPENSEA_API_KEY }}"
            printf "window.OPENSEA_MCP_TOKEN = '%s';\n" "${{ secrets.OPENSEA_MCP_TOKEN }}"
            printf "window.OPENSEA_API_KEY_FALLBACK = '%s';\n" "${{ secrets.OPENSEA_API_KEY_FALLBACK }}"
            printf "window.OPENSEA_COLLECTION_SLUG = '%s';\n" "${{ secrets.OPENSEA_COLLECTION_SLUG }}"
          } > marketosintegration/opensea-config.js
          echo "✅ OpenSea config generated"

      - name: Fetch OpenSea listings to static cache (avoid CORS)
        env:
          OPENSEA_API_KEY: ${{ secrets.OPENSEA_API_KEY }}
          OPENSEA_MCP_TOKEN: ${{ secrets.OPENSEA_MCP_TOKEN }}
          OPENSEA_API_KEY_FALLBACK: ${{ secrets.OPENSEA_API_KEY_FALLBACK }}
          OPENSEA_COLLECTION_SLUG: ${{ secrets.OPENSEA_COLLECTION_SLUG }}
        run: |
          set -euo pipefail
          cd marketosintegration

          KEY="${OPENSEA_API_KEY:-}"
          if [ -z "$KEY" ]; then KEY="${OPENSEA_MCP_TOKEN:-}"; fi
          if [ -z "$KEY" ]; then KEY="${OPENSEA_API_KEY_FALLBACK:-}"; fi

          if [ -z "${OPENSEA_COLLECTION_SLUG:-}" ]; then
            echo '{"listings":[],"fetchedAt":null,"error":"missing slug"}' > opensea-cache.json
            exit 0
          fi

          if [ -z "$KEY" ]; then
            echo '{"listings":[],"fetchedAt":null,"error":"missing api key"}' > opensea-cache.json
            exit 0
          fi

          URL="https://api.opensea.io/api/v2/listings/collection/${OPENSEA_COLLECTION_SLUG}/all?limit=50&order_by=eth_price&order_direction=asc"
          echo "Fetching OpenSea listings server-side..."
          if curl -sS -H "X-API-KEY: ${KEY}" "$URL" -o opensea-cache.json; then
            echo "✅ OpenSea cache generado (server-side)"
          else
            echo '{"listings":[],"fetchedAt":null,"error":"fetch failed"}' > opensea-cache.json
            echo "⚠️ OpenSea cache vacío (fetch falló)"
          fi

      - name: Verify generated configs
        run: |
          for f in supabase-config.js runtime-config.js opensea-config.js; do
            if [ ! -f "marketosintegration/$f" ]; then
              echo "❌ ERROR: marketosintegration/$f missing"
              exit 1
            fi
          done
          for f in supabase-config.js runtime-config.js; do
            if [ ! -f "market/$f" ]; then
              echo "❌ ERROR: market/$f missing"
              exit 1
            fi
          done
          if grep -q "window.SUPABASE_URL = ''" marketosintegration/supabase-config.js; then
            echo "❌ ERROR: SUPABASE_URL empty"
            exit 1
          fi
          if ! grep -q "https://" marketosintegration/supabase-config.js; then
            echo "❌ ERROR: SUPABASE_URL not valid"
            exit 1
          fi
          if ! diff -q marketosintegration/supabase-config.js marketosintegration/runtime-config.js >/dev/null; then
            echo "❌ ERROR: runtime-config.js differs from supabase-config.js"
            exit 1
          fi
          if ! grep -q "window.OPENSEA_COLLECTION_SLUG" marketosintegration/opensea-config.js; then
            echo "❌ ERROR: OPENSEA_COLLECTION_SLUG missing in opensea-config.js"
            exit 1
          fi
          if [ ! -f marketosintegration/opensea-cache.json ]; then
            echo "❌ ERROR: opensea-cache.json missing"
            exit 1
          fi
          if ! diff -q marketosintegration/supabase-config.js marketosintegration/runtime-config.js >/dev/null; then
            echo "❌ ERROR: runtime-config.js differs from supabase-config.js (marketosintegration)"
            exit 1
          fi
          if ! diff -q market/supabase-config.js market/runtime-config.js >/dev/null; then
            echo "❌ ERROR: runtime-config.js differs from supabase-config.js (market)"
            exit 1
          fi
          echo "✅ Configs verified"

      - name: Prepare deploy folder with subpath /marketosintegration
        run: |
          rm -rf site-dist
          mkdir -p site-dist
          # Copy root landing (keep existing site intact)
          cp index.html site-dist/ || true
          cp favicon.ico site-dist/ || true
          if [ -f adrian1.ico ]; then cp adrian1.ico site-dist/; fi
          # Copy existing site sections to preserve pages site
          [ -d market ] && cp -r market site-dist/market
          [ -d swap ] && cp -r swap site-dist/swap
          [ -d components ] && cp -r components site-dist/components
          [ -d quest ] && cp -r quest site-dist/quest
          [ -d toggler ] && cp -r toggler site-dist/toggler
          [ -d activity ] && cp -r activity site-dist/activity
          # Copy marketosintegration
          cp -r marketosintegration site-dist/marketosintegration
          echo "adrianpunks.com" > site-dist/CNAME

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site-dist

      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v4

