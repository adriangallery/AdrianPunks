<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdrianPunks Market v3.3</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    #tokenBalance {
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      #tokenBalance {
        margin-top: 70px;
      }
    }
    .modal-dialog {
      max-width: 500px;
    }
    .modal-body img {
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }
    /* Asegurar que el backdrop se elimine correctamente */
    .modal-backdrop {
      opacity: 0.5;
    }
    body.modal-open {
      overflow: auto !important;
      padding-right: 0 !important;
    }
    .offer-form {
      transition: all 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    .offer-form.hiding {
      opacity: 0;
      transform: translateY(-10px);
    }
    .modal-body {
      max-height: 80vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .trait-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      font-size: 0.9em;
      padding: 8px 12px;
    }
  </style>
  <!-- Load ethers.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- Include the menu -->
  <div id="menu-container"></div>
  <script>
    // Load the menu
    fetch('components/menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('menu-container').innerHTML = html;
        // Load menu.js after menu HTML is loaded
        const script = document.createElement('script');
        script.src = 'components/menu.js';
        document.head.appendChild(script);
      })
      .catch(error => console.error('Error loading menu:', error));
  </script>

  <!-- Main Container -->
  <div class="container">
    <h2 id="tokenBalance">Balance: Loading...</h2>
    
    <!-- Botones para funciones adicionales -->
    <div class="mt-3 text-center mb-4">
      <div class="btn-group">
        <button class="btn btn-warning" onclick="openFloorOfferPopup()">Make Floor Offer üí∞</button>
        <button class="btn btn-info" onclick="openMyOffersModal()">My Offers üìù</button>
        <button class="btn btn-secondary" onclick="openMyListingsModal()">My Listings üìÉ</button>
        <button class="btn btn-dark" onclick="openRecentActivityModal()">Recent Activity üîÑ</button>
      </div>
    </div>

    <div id="floorOfferSection" style="cursor:pointer; margin-bottom:20px;">
      <span id="floorOfferText">Highest floor offer: -- $ADRIAN</span>
    </div>
    <div class="nft-grid" id="nftGrid"></div>
  </div>

  <!-- Modal para NFT Details -->
  <div class="modal fade" id="nftModal" tabindex="-1" aria-labelledby="nftModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" id="nftModalContent">
        <!-- Contenido cargado din√°micamente -->
      </div>
    </div>
  </div>

  <!-- Modal for My Offers -->
  <div class="modal fade" id="myOffersModal" tabindex="-1" aria-labelledby="myOffersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="myOffersModalLabel">My Offers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="myOffersContent">
          <!-- Lista de ofertas se inyecta aqu√≠ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for My Listings -->
  <div class="modal fade" id="myListingsModal" tabindex="-1" aria-labelledby="myListingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="myListingsModalLabel">My Listings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="myListingsContent">
          <!-- Listado de mis listados -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Recent Activity -->
  <div class="modal fade" id="recentActivityModal" tabindex="-1" aria-labelledby="recentActivityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="recentActivityModalLabel">Recent Activity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="recentActivityContent">
          <!-- Datos de actividad reciente se inyectan aqu√≠ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Floor Offer Popup -->
  <div class="modal fade" id="floorOfferPopupModal" tabindex="-1" aria-labelledby="floorOfferPopupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="floorOfferPopupModalLabel">Make Floor Offer for the Collection</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="floorOfferPopupContent">
          <div id="floorOfferForm">
            <label>Offer Amount (in $ADRIAN): 
              <input type="text" id="popupOfferAmount" value="10000" class="form-control">
            </label>
            <button class="btn btn-primary mt-2" onclick="makeFloorOfferPopup()">Submit Floor Offer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Main Script: NFT loading and Contract Interactions -->
  <script>
    /*********** Global Variables and Contract Setup ***********/
    let nftData = [];
    let provider, signer, userAccount;
    let tokenContract, nftContract, marketplaceContract;
    
    // Direcciones de contratos y ABIs
    const TOKEN_ADDRESS  = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const NFT_ADDRESS    = "0x4b9afc775d3D1969F727e81BA970B19b9e8054EF";
    // Nueva direcci√≥n de AdrianMarket
    const MARKET_ADDRESS = "0xe746999546e65c44543a443cc1e9b5fe168ede5d";

    // ABI actualizado del contrato AdrianMarket (se incluyen las funciones nuevas)
    const MARKET_ABI = [
      // Funciones de listings
      "function createListing(address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 duration, uint8 nftTypeParam) external",
      "function cancelListing(uint256 listingId) external",
      "function buyListing(uint256 listingId, uint256 purchaseQuantity) external",
      "function editListing(uint256 listingId, uint256 newPrice, uint256 newDuration) external",
      "function getActiveListingsDetailed() external view returns (tuple(uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime, uint8 nftType)[])",
      "function getMyListings(address seller) external view returns (tuple(uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime, uint8 nftType)[])",
      // Floor offers
      "function floorOffers(address) external view returns (uint256, address, bool)",
      "function setFloorOffer(address collection, uint256 offerAmount) external",
      "function acceptFloorOffer(address collection, uint256 tokenId, uint8 nftTypeParam) external",
      // Listing Offers
      "function makeOffer(uint256 listingId, uint256 quantity, uint256 offerAmount) external",
      "function withdrawOffer(uint256 listingId) external",
      "function acceptOffer(uint256 listingId, address buyer) external",
      "function getMyListingOffers(address buyer) external view returns (tuple(uint256 id, uint256 listingId, address buyer, uint256 tokenId, uint256 quantity, uint256 offerAmount, bool exists)[])",
      // Token offers (para tokens no listados)
      "function makeTokenOffer(address collection, uint256 tokenId, uint256 quantity, uint256 offerAmount) external",
      "function withdrawTokenOffer(address collection, uint256 tokenId) external",
      "function acceptTokenOffer(address collection, uint256 tokenId, uint256 offerId, uint8 nftTypeParam) external",
      "function getMyTokenOffers(address buyer) external view returns (tuple(uint256 id, address collection, uint256 tokenId, uint256 quantity, uint256 offerAmount, address buyer, bool exists)[])",
      // Trait offers (ya expuestas p√∫blicamente)
      "function setTraitOffer(string traitType, string traitValue, uint256 offerAmount) external",
      "function cancelTraitOffer(string traitType, string traitValue) external",
      "function acceptTraitOffer(string traitType, string traitValue, uint256 tokenId, address collection, uint8 nftTypeParam) external",
      // Read admin values
      "function commissionPercentage() external view returns (uint256)",
      "function commissionWallet() external view returns (address)",
      "function paymentToken() external view returns (address)"
    ];

    // ABI de los tokens y NFTs (no modificadas)
    const TOKEN_ABI = [
      "function balanceOf(address account) view returns (uint256)",
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
    const NFT_ABI = [
      "function tokenURI(uint256 tokenId) view returns (string)"
    ];
    
    async function initContracts() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAccount = await signer.getAddress();
        tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
        nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
        marketplaceContract = new ethers.Contract(MARKET_ADDRESS, MARKET_ABI, signer);
        updateTokenBalance();
        loadFloorOffer();
      } else {
        console.error("Ethereum provider not found.");
      }
    }
    
    /*********** NFT Data Loading and Display ***********/
    async function loadNFTs() {
      try {
        const response = await fetch('adrianpunks.json');
        if (!response.ok) {
          throw new Error('Error loading NFTs');
        }
        const data = await response.json();
        nftData = data.collection || [];
        displayNFTs(nftData);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('nftGrid').innerHTML = 
          `<div class="alert alert-danger">Error loading NFTs: ${error.message}</div>`;
      }
    }
    
    function displayNFTs(nfts) {
      const grid = document.getElementById('nftGrid');
      grid.innerHTML = '';
    
      if (!nfts || nfts.length === 0) {
        grid.innerHTML = '<div class="alert alert-info">No NFTs found</div>';
        return;
      }
    
      nfts.forEach(nft => {
        const card = document.createElement('div');
        card.className = 'card nft-card';
        card.innerHTML = `
          <img src="${nft.image}" class="card-img-top" alt="${nft.name}" onerror="this.src='placeholder.png'">
          <div class="card-body">
              <h5 class="card-title">${nft.name}</h5>
              <p class="card-text">Rarity: ${nft.rarity.toFixed(2)}</p>
              <button class="btn btn-primary" onclick="showNFTDetails('${nft.name}')">View Details</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    function showNFTDetails(nftName) {
      fetch('adrianpunks.json')
        .then(response => response.json())
        .then(data => {
          const nft = data.collection.find(n => n.name === nftName);
          if (nft) {
            const modalContent = document.getElementById('nftModalContent');
            modalContent.innerHTML = `
              <div class="modal-header">
                <h5 class="modal-title">${nft.name}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <img src="${nft.image}" class="img-fluid rounded mb-3" alt="${nft.name}" onerror="this.src='placeholder.png'">
                <div class="nft-details text-start">
                  <p><strong>Description:</strong> ${nft.description}</p>
                  <p><strong>Compiler:</strong> ${nft.compiler}</p>
                  <p><strong>Masterminds:</strong> ${nft.masterminds.join(', ')}</p>
                  <p><strong>Rarity:</strong> ${nft.rarity.toFixed(2)}</p>
                  <h6>Attributes:</h6>
                  <ul class="list-group">
                    ${nft.attributes.map(attr => 
                      `<li class="list-group-item">
                        <strong>${attr.trait_type}:</strong> ${attr.value}
                        <button class="btn btn-sm btn-outline-primary" onclick="openTraitOfferForm('${attr.trait_type}', '${attr.value}')" title="Make Trait Offer">üí∞</button>
                      </li>`
                    ).join('')}
                  </ul>
                  <div class="text-center mt-3">
                    <button class="btn btn-success" onclick="buyNFT('${nft.name}')">Buy NFT</button>
                    <button class="btn btn-secondary" onclick="openMakeTokenOfferForm('${nft.name.split('#')[1]}')">Make Token Offer</button>
                  </div>
                </div>
              </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('nftModal'));
            const modalElement = document.getElementById('nftModal');
            modalElement.addEventListener('hidden.bs.modal', function () {
              document.body.classList.remove('modal-open');
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) { backdrop.remove(); }
              modalContent.innerHTML = '';
            });
            modal.show();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error loading NFT details');
        });
    }
    
    /*********** Contract Interaction Functions ***********/
    
    async function buyNFT(nftName) {
      try {
        if (!marketplaceContract || !tokenContract) {
          alert("Please connect your wallet to continue.");
          return;
        }
        const response = await fetch('adrianpunks.json');
        const data = await response.json();
        const nft = data.collection.find(n => n.name === nftName);
        if (!nft) { alert("NFT not found."); return; }
        const tokenId = parseInt(nft.name.split("#")[1]);
        const price = await marketplaceContract.buyListing(tokenId, 1);
        console.log("NFT Price:", price.toString());
        const currentAllowance = await tokenContract.allowance(userAccount, MARKET_ADDRESS);
        if (currentAllowance.lt(price)) {
          const txApprove = await tokenContract.approve(MARKET_ADDRESS, price);
          await txApprove.wait();
        }
        const txPurchase = await marketplaceContract.buyListing(tokenId, 1);
        await txPurchase.wait();
        alert("Purchase successful!");
      } catch (error) {
        console.error("Error purchasing NFT:", error);
        alert("Error purchasing NFT: " + error.message);
      }
    }
    
    async function updateTokenBalance() {
      try {
        const balanceRaw = await tokenContract.balanceOf(userAccount);
        const balance = parseFloat(ethers.utils.formatUnits(balanceRaw, 18));
        let formattedBalance = balance >= 1000000 ? (balance / 1000000).toFixed(1) + 'M' :
                              balance >= 1000 ? (balance / 1000).toFixed(1) + 'K' :
                              balance.toFixed(1);
        document.getElementById("tokenBalance").innerText = `Balance: ${formattedBalance} $ADRIAN`;
      } catch (error) {
        console.error("Error fetching token balance:", error);
        document.getElementById("tokenBalance").innerText = "Balance: Error";
      }
    }
    
    async function loadFloorOffer() {
      try {
        const floorOffer = await marketplaceContract.floorOffers(NFT_ADDRESS);
        const offerAmount = floorOffer.offerAmount;
        const floorSection = document.getElementById("floorOfferSection");
        if (floorOffer.active && offerAmount.gt(0)) {
          document.getElementById("floorOfferText").innerText = 
            `Highest floor offer: ${ethers.utils.formatUnits(offerAmount, 18)} $ADRIAN`;
          floorSection.classList.remove("no-offer");
        } else {
          document.getElementById("floorOfferText").innerText = "No floor offer set";
          floorSection.classList.add("no-offer");
        }
      } catch (error) {
        console.error("Error loading floor offer:", error);
      }
    }
    
    async function sweepFloor() {
      if (!marketplaceContract) {
        alert("Please connect your wallet first.");
        return;
      }
      const countStr = prompt("How many tokens do you want to purchase from the floor?");
      const numTokens = parseInt(countStr);
      if (isNaN(numTokens) || numTokens <= 0) {
        alert("Invalid number. Please try again.");
        return;
      }
      try {
        const activeListings = await marketplaceContract.getActiveListingsDetailed();
        let listingsArr = activeListings.filter(listing => listing.expirationTime > Math.floor(Date.now() / 1000));
        listingsArr.sort((a, b) => Number(a.price) - Number(b.price));
        let tokensBought = 0;
        for (let listing of listingsArr) {
          if (tokensBought >= numTokens) break;
          try {
            const requiredAmount = listing.price.div(listing.quantity);
            const currentAllowance = await tokenContract.allowance(userAccount, MARKET_ADDRESS);
            if (currentAllowance.lt(requiredAmount)) {
              const txApprove = await tokenContract.approve(MARKET_ADDRESS, requiredAmount);
              await txApprove.wait();
            }
            const txBuy = await marketplaceContract.buyListing(listing.id, 1, { gasLimit: 1000000 });
            await txBuy.wait();
            tokensBought++;
            console.log(`Token purchased from listing ${listing.id}`);
          } catch (err) {
            console.error("Error purchasing listing " + listing.id, err);
          }
        }
        alert(`Sweep Floor complete! You purchased ${tokensBought} token(s).`);
      } catch (error) {
        console.error("Error during Sweep Floor:", error);
        alert("Error during Sweep Floor: " + error.message);
      }
    }
    
    /*********** New Functions for Frontend Reads and Offers ***********/
    
    // Function to open the "My Listings" modal and load user's listings
    async function openMyListingsModal() {
      if (!marketplaceContract) {
        alert("Please connect your wallet first.");
        return;
      }
      try {
        const myListings = await marketplaceContract.getMyListings(userAccount);
        let contentHtml = "";
        if (myListings.length === 0) {
          contentHtml = "<p class='text-center'>No listings found.</p>";
        } else {
          contentHtml = "<ul class='list-group'>";
          myListings.forEach(listing => {
            contentHtml += `<li class="list-group-item">
              Listing #${listing.id.toString()} - Token #${listing.tokenId.toString()} - Price: ${ethers.utils.formatUnits(listing.price, 18)} $ADRIAN - Qty: ${listing.quantity.toString()}
            </li>`;
          });
          contentHtml += "</ul>";
        }
        document.getElementById("myListingsContent").innerHTML = contentHtml;
        let modal = new bootstrap.Modal(document.getElementById('myListingsModal'));
        modal.show();
      } catch (e) {
        console.error(e);
        alert("Error loading my listings: " + e.message);
      }
    }
    
    // Function to open the "Recent Activity" modal loading active listings
    async function openRecentActivityModal() {
      if (!marketplaceContract) {
        alert("Please connect your wallet first.");
        return;
      }
      try {
        const activeListings = await marketplaceContract.getActiveListingsDetailed();
        let contentHtml = "";
        if (activeListings.length === 0) {
          contentHtml = "<p class='text-center'>No active listings.</p>";
        } else {
          contentHtml = "<ul class='list-group'>";
          activeListings.forEach(listing => {
            contentHtml += `<li class="list-group-item">
              Listing #${listing.id.toString()} - Seller: ${listing.seller} - Token #${listing.tokenId.toString()} - Price: ${ethers.utils.formatUnits(listing.price, 18)} $ADRIAN - Qty: ${listing.quantity.toString()} - Expires: ${new Date(listing.expirationTime * 1000).toLocaleString()}
            </li>`;
          });
          contentHtml += "</ul>";
        }
        document.getElementById("recentActivityContent").innerHTML = contentHtml;
        let modal = new bootstrap.Modal(document.getElementById('recentActivityModal'));
        modal.show();
      } catch (e) {
        console.error(e);
        alert("Error loading recent activity: " + e.message);
      }
    }
    
    // Function to open the "My Offers" modal (combining listing and token offers)
    async function openMyOffersModal() {
      if (!marketplaceContract) {
        alert("Please connect your wallet first.");
        return;
      }
      try {
        const listingOffers = await marketplaceContract.getMyListingOffers(userAccount);
        const tokenOffers = await marketplaceContract.getMyTokenOffers(userAccount);
        let contentHtml = "";
        if (listingOffers.length === 0 && tokenOffers.length === 0) {
          contentHtml = "<p class='text-center'>No active offers yet. Go make one!</p>";
        } else {
          if (listingOffers.length > 0) {
            contentHtml += "<h6>Listing Offers:</h6><ul class='list-group mb-3'>";
            listingOffers.forEach(offer => {
              contentHtml += `<li class="list-group-item">
                Offer #${offer.id.toString()} on Listing #${offer.listingId.toString()} - Token #${offer.tokenId.toString()} - Offer: ${ethers.utils.formatUnits(offer.offerAmount, 18)} $ADRIAN - Qty: ${offer.quantity.toString()}
                <div class="mt-2">
                  <button class="btn btn-sm btn-danger" onclick="cancelOffer(${offer.listingId})">Cancel Offer</button>
                  <button class="btn btn-sm btn-primary" onclick="promptModifyOffer(${offer.listingId}, ${offer.offerAmount.toString()}, ${offer.tokenId})">Modify Offer</button>
                </div>
              </li>`;
            });
            contentHtml += "</ul>";
          }
          if (tokenOffers.length > 0) {
            contentHtml += "<h6>Token Offers (Non-listed):</h6><ul class='list-group'>";
            tokenOffers.forEach(offer => {
              contentHtml += `<li class="list-group-item">
                Token Offer #${offer.id.toString()} on Token #${offer.tokenId.toString()} - Offer: ${ethers.utils.formatUnits(offer.offerAmount, 18)} $ADRIAN - Qty: ${offer.quantity.toString()}
                <div class="mt-2">
                  <button class="btn btn-sm btn-danger" onclick="cancelTokenOffer('${offer.collection}', ${offer.tokenId})">Cancel Token Offer</button>
                </div>
              </li>`;
            });
            contentHtml += "</ul>";
          }
        }
        document.getElementById("myOffersContent").innerHTML = contentHtml;
        let modal = new bootstrap.Modal(document.getElementById('myOffersModal'));
        modal.show();
      } catch (error) {
        console.error(error);
        alert("Error loading your offers. Please try again later.");
      }
    }
    
    async function cancelOffer(listingId) {
      try {
        const tx = await marketplaceContract.withdrawOffer(listingId, { gasLimit: 1000000 });
        await tx.wait();
        alert("Offer canceled.");
        openMyOffersModal();
      } catch (error) {
        console.error("Error canceling offer:", error);
        alert("Error canceling your offer: " + error.message);
      }
    }
    
    async function promptModifyOffer(listingId, currentOfferAmount, tokenId) {
      const newOfferAmountStr = prompt("Enter new offer amount:", ethers.utils.formatUnits(currentOfferAmount, 18));
      if (newOfferAmountStr != null) {
        try {
          const newOfferAmountWei = ethers.utils.parseUnits(newOfferAmountStr, 18);
          const tx = await marketplaceContract.modifyOffer(listingId, newOfferAmountWei, { gasLimit: 1000000 });
          await tx.wait();
          alert("Offer updated!");
          openMyOffersModal();
        } catch (error) {
          console.error("Error modifying offer:", error);
          alert("Could not update your offer: " + error.message);
        }
      }
    }
    
    // ----- Functions for Token Offers (Non-listed tokens) -----
    function openMakeTokenOfferForm(tokenId) {
      closeAllOfferForms();
      const modalBody = document.querySelector('.modal-body');
      const offerFormId = `tokenOfferForm_${tokenId}`;
      const offerForm = document.createElement('div');
      offerForm.id = offerFormId;
      offerForm.className = 'offer-form mt-4';
      offerForm.style.display = 'none';
      offerForm.innerHTML = `
        <div class="border-top pt-3">
          <h5 class="mb-3">Make Token Offer for Token #${tokenId}</h5>
          <div class="form-group">
            <label class="mb-2">Offer Amount (in $ADRIAN):</label>
            <input type="text" id="tokenOfferAmount_${tokenId}" value="10000" class="form-control mb-3">
          </div>
          <div class="form-group">
            <label class="mb-2">Quantity:</label>
            <input type="text" id="tokenOfferQuantity_${tokenId}" value="1" class="form-control mb-3">
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-primary" onclick="makeTokenOffer('${tokenId}')">Submit Token Offer</button>
            <button class="btn btn-outline-secondary" onclick="closeAllOfferForms()">Cancel</button>
          </div>
        </div>
      `;
      modalBody.appendChild(offerForm);
      setTimeout(() => {
        offerForm.style.display = 'block';
        offerForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
    
    async function makeTokenOffer(tokenId) {
      if (!tokenId) {
        alert("Error: Invalid Token ID");
        return;
      }
      const offerAmount = document.getElementById(`tokenOfferAmount_${tokenId}`).value;
      const quantity = document.getElementById(`tokenOfferQuantity_${tokenId}`).value;
      const offerAmountWei = ethers.utils.parseUnits(offerAmount, 18);
      const qty = parseInt(quantity);
      try {
        const tx = await marketplaceContract.makeTokenOffer(NFT_ADDRESS, tokenId, qty, offerAmountWei);
        await tx.wait();
        alert("Token offer created successfully!");
        closeAllOfferForms();
      } catch (error) {
        console.error("Error creating token offer:", error);
        alert("Error creating token offer: " + error.message);
      }
    }
    
    async function cancelTokenOffer(collection, tokenId) {
      try {
        const tx = await marketplaceContract.withdrawTokenOffer(collection, tokenId, { gasLimit: 1000000 });
        await tx.wait();
        alert("Token offer canceled.");
        openMyOffersModal();
      } catch (error) {
        console.error("Error canceling token offer:", error);
        alert("Error canceling token offer: " + error.message);
      }
    }
    
    // Function to close any open offer forms
    function closeAllOfferForms() {
      const existingForms = document.querySelectorAll('.offer-form');
      existingForms.forEach(form => {
        form.style.opacity = '0';
        setTimeout(() => form.remove(), 300);
      });
    }
    
    // ----- Functions for Trait Offers remain unchanged -----
    function openTraitOfferForm(traitType, traitValue) {
      closeAllOfferForms();
      const modalBody = document.querySelector('.modal-body');
      const offerFormId = `traitOfferForm_${traitType}_${traitValue}`;
      const offerForm = document.createElement('div');
      offerForm.id = offerFormId;
      offerForm.className = 'offer-form mt-4';
      offerForm.style.display = 'none';
      offerForm.innerHTML = `
        <div class="border-top pt-3">
          <h5 class="mb-3">Make Trait Offer</h5>
          <div class="form-group mb-3">
            <div class="trait-info mb-3">
              <span class="badge bg-primary me-2">${traitType}</span>
              <span class="badge bg-secondary">${traitValue}</span>
            </div>
            <label class="mb-2">Offer Amount (in $ADRIAN):</label>
            <input type="text" id="traitOfferAmount_${traitType}_${traitValue}" value="5000" class="form-control">
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-primary" onclick="makeTraitOffer('${traitType}', '${traitValue}')">Submit Trait Offer</button>
            <button class="btn btn-outline-secondary" onclick="closeAllOfferForms()">Cancel</button>
          </div>
        </div>
      `;
      modalBody.appendChild(offerForm);
      setTimeout(() => {
        offerForm.style.display = 'block';
        offerForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
    
    async function makeTraitOffer(traitType, traitValue) {
      const offerAmount = document.getElementById(`traitOfferAmount_${traitType}_${traitValue}`).value;
      const offerAmountWei = ethers.utils.parseUnits(offerAmount, 18);
      try {
        const allowance = await tokenContract.allowance(userAccount, MARKET_ADDRESS);
        if (allowance.lt(offerAmountWei)) {
          const txApprove = await tokenContract.approve(MARKET_ADDRESS, offerAmountWei);
          await txApprove.wait();
          alert("Approved " + ethers.utils.formatUnits(offerAmountWei, 18) + " $ADRIAN tokens for trait offer.");
        }
        const tx = await marketplaceContract.setTraitOffer(traitType, traitValue, offerAmountWei);
        await tx.wait();
        alert("Trait offer created successfully!");
        closeAllOfferForms();
      } catch (error) {
        console.error("Error creating trait offer:", error);
        alert("Error creating trait offer: " + error.message);
      }
    }
    
    // Floor Offer Popup function remains as before
    async function openFloorOfferPopup() {
      const modal = new bootstrap.Modal(document.getElementById('floorOfferPopupModal'));
      modal.show();
    }
    
    async function makeFloorOfferPopup() {
      const offerAmount = document.getElementById("popupOfferAmount").value;
      const offerAmountWei = ethers.utils.parseUnits(offerAmount, 18);
      try {
        const allowance = await tokenContract.allowance(userAccount, MARKET_ADDRESS);
        if (allowance.lt(offerAmountWei)) {
          const txApprove = await tokenContract.approve(MARKET_ADDRESS, offerAmountWei);
          await txApprove.wait();
          alert("Approved " + ethers.utils.formatUnits(offerAmountWei, 18) + " $ADRIAN tokens.");
        }
        const tx = await marketplaceContract.setFloorOffer(NFT_ADDRESS, offerAmountWei);
        await tx.wait();
        alert("Floor offer created successfully!");
        loadFloorOffer();
      } catch (error) {
        console.error("Error creating floor offer:", error);
        alert("Error creating floor offer: " + error.message);
      }
    }
    
    // Initialize contracts and load NFTs on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initContracts();
      loadNFTs();
    });
  </script>
</body>
</html>