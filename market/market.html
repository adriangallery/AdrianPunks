<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdrianPunks Market v3.6</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/market/styles.css">
  <style>
    /* Tus estilos existentes */
    #tokenBalance { margin-top: 10px; }
    @media (max-width: 768px) { #tokenBalance { margin-top: 70px; } }
    .modal-dialog { max-width: 500px; }
    .modal-body img { max-width: 300px; margin: 0 auto; display: block; }
    .modal-backdrop { opacity: 0.5; }
    body.modal-open { overflow: auto !important; padding-right: 0 !important; }
    .offer-form { transition: all 0.3s ease; opacity: 1; transform: translateY(0); }
    .offer-form.hiding { opacity: 0; transform: translateY(-10px); }
    .modal-body { max-height: 80vh; overflow-y: auto; scroll-behavior: smooth; }
    .trait-info { display: flex; align-items: center; gap: 8px; }
    .badge { font-size: 0.9em; padding: 8px 12px; }
  </style>
  <!-- Load ethers.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- Menu y demás elementos de la página… -->
  <div id="menu-container"></div>
  <script>
    fetch('components/menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('menu-container').innerHTML = html;
        const script = document.createElement('script');
        script.src = 'components/menu.js';
        document.head.appendChild(script);
      })
      .catch(error => console.error('Error loading menu:', error));
  </script>

  <div class="container">
    <!-- Resto del HTML para mostrar balances, botones, grid, etc. -->
    <h2 id="tokenBalance" class="mb-2">Balance: Loading...</h2>
    <!-- ... -->
    <div class="nft-grid" id="nftGrid"></div>
  </div>

  <!-- Modal para NFT Details, My Offers, Listings, Floor Offer Popup, etc. -->
  <!-- ... (No se modifica el HTML de los modals en este ejemplo) ... -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Main Script: NFT loading and Contract Interactions -->
  <script>
    /*********** Global Variables and Contract Setup ***********/
    let nftData = [];
    let provider, signer, userAccount;
    let tokenContract, nftContract, marketplaceContract;
    let activeListingsData = [];
    let currentSortOrder = 'asc';

    // Direcciones y ABIs actualizadas
    const TOKEN_ADDRESS  = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const NFT_ADDRESS    = "0x79BE8AcdD339C7b92918fcC3fd3875b5Aaad7566";
    const MARKET_ADDRESS = "0x4B09395Dd0B826Ab3D54272D5dba6769D1640297"; // Nueva CA

    // Nuevo ABI del contrato AdrianMarket (actualizado)
    const MARKET_ABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "_paymentToken", "type": "address" }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      { "inputs": [ { "internalType": "address", "name": "owner", "type": "address" } ], "name": "OwnableInvalidOwner", "type": "error" },
      { "inputs": [ { "internalType": "address", "name": "account", "type": "address" } ], "name": "OwnableUnauthorizedAccount", "type": "error" },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "collection", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "seller", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "FloorOfferAccepted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "collection", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "FloorOfferSet",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" }
        ],
        "name": "ListingCancelled",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "seller", "type": "address" },
          { "indexed": false, "internalType": "address", "name": "collection", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "quantity", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "price", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "expirationTime", "type": "uint256" },
          { "indexed": false, "internalType": "enum AdrianMarket.NFTType", "name": "nftType", "type": "uint8" }
        ],
        "name": "ListingCreated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "newPrice", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "newExpirationTime", "type": "uint256" }
        ],
        "name": "ListingEdited",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "quantity", "type": "uint256" }
        ],
        "name": "ListingPurchased",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "address", "name": "seller", "type": "address" }
        ],
        "name": "OfferAccepted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "quantity", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "OfferCreated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "indexed": true, "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" }
        ],
        "name": "OfferWithdrawn",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
      },
      { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "address", "name": "account", "type": "address" } ], "name": "Paused", "type": "event" },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "collection", "type": "address" },
          { "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "address", "name": "seller", "type": "address" },
          { "indexed": false, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "TokenOfferAccepted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "collection", "type": "address" },
          { "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "quantity", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "TokenOfferCreated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "indexed": true, "internalType": "address", "name": "collection", "type": "address" },
          { "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "address", "name": "buyer", "type": "address" }
        ],
        "name": "TokenOfferWithdrawn",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": false, "internalType": "string", "name": "traitType", "type": "string" },
          { "indexed": false, "internalType": "string", "name": "traitValue", "type": "string" },
          { "indexed": true, "internalType": "address", "name": "seller", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "TraitOfferAccepted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": false, "internalType": "string", "name": "traitType", "type": "string" },
          { "indexed": false, "internalType": "string", "name": "traitValue", "type": "string" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" }
        ],
        "name": "TraitOfferCancelled",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": false, "internalType": "string", "name": "traitType", "type": "string" },
          { "indexed": false, "internalType": "string", "name": "traitValue", "type": "string" },
          { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "TraitOfferSet",
        "type": "event"
      },
      { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "address", "name": "account", "type": "address" } ], "name": "Unpaused", "type": "event" },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "uint8", "name": "nftTypeParam", "type": "uint8" },
          { "internalType": "address[]", "name": "buyers", "type": "address[]" }
        ],
        "name": "acceptMultipleFloorOffers",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "internalType": "address", "name": "buyer", "type": "address" }
        ],
        "name": "acceptOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "uint256", "name": "offerId", "type": "uint256" },
          { "internalType": "uint8", "name": "nftTypeParam", "type": "uint8" }
        ],
        "name": "acceptTokenOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "traitType", "type": "string" },
          { "internalType": "string", "name": "traitValue", "type": "string" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint8", "name": "nftTypeParam", "type": "uint8" }
        ],
        "name": "acceptTraitOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "name": "activeListings",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "internalType": "uint256", "name": "purchaseQuantity", "type": "uint256" }
        ],
        "name": "buyListing",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [ { "internalType": "uint256", "name": "listingId", "type": "uint256" } ],
        "name": "cancelListing",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "traitType", "type": "string" },
          { "internalType": "string", "name": "traitValue", "type": "string" }
        ],
        "name": "cancelTraitOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "uint256", "name": "quantity", "type": "uint256" },
          { "internalType": "uint256", "name": "price", "type": "uint256" },
          { "internalType": "uint256", "name": "duration", "type": "uint256" },
          { "internalType": "uint8", "name": "nftTypeParam", "type": "uint8" }
        ],
        "name": "createListing",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "internalType": "uint256", "name": "newPrice", "type": "uint256" },
          { "internalType": "uint256", "name": "newDuration", "type": "uint256" }
        ],
        "name": "editListing",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "name": "floorOffers",
        "outputs": [
          { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
          { "internalType": "address", "name": "buyer", "type": "address" },
          { "internalType": "bool", "name": "active", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getActiveListingsDetailed",
        "outputs": [
          {
            "components": [
              { "internalType": "uint256", "name": "id", "type": "uint256" },
              { "internalType": "address", "name": "seller", "type": "address" },
              { "internalType": "address", "name": "collection", "type": "address" },
              { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
              { "internalType": "uint256", "name": "quantity", "type": "uint256" },
              { "internalType": "uint256", "name": "price", "type": "uint256" },
              { "internalType": "uint256", "name": "expirationTime", "type": "uint256" },
              { "internalType": "enum AdrianMarket.NFTType", "name": "nftType", "type": "uint8" }
            ],
            "internalType": "struct AdrianMarket.Listing[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getActiveTokenListings",
        "outputs": [
          {
            "components": [
              { "internalType": "address", "name": "collection", "type": "address" },
              { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
              { "internalType": "uint256", "name": "totalQuantity", "type": "uint256" }
            ],
            "internalType": "struct AdrianMarket.TokenListing[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "listingId", "type": "uint256" }
        ],
        "name": "getListing",
        "outputs": [
          {
            "components": [
              { "internalType": "uint256", "name": "id", "type": "uint256" },
              { "internalType": "address", "name": "seller", "type": "address" },
              { "internalType": "address", "name": "collection", "type": "address" },
              { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
              { "internalType": "uint256", "name": "quantity", "type": "uint256" },
              { "internalType": "uint256", "name": "price", "type": "uint256" },
              { "internalType": "uint256", "name": "expirationTime", "type": "uint256" },
              { "internalType": "enum AdrianMarket.NFTType", "name": "nftType", "type": "uint8" }
            ],
            "internalType": "struct AdrianMarket.Listing",
            "name": "",
            "type": "tuple"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "buyer", "type": "address" }
        ],
        "name": "getMyListingOffers",
        "outputs": [
          {
            "components": [
              { "internalType": "uint256", "name": "id", "type": "uint256" },
              { "internalType": "uint256", "name": "listingId", "type": "uint256" },
              { "internalType": "address", "name": "buyer", "type": "address" },
              { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
              { "internalType": "uint256", "name": "quantity", "type": "uint256" },
              { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
              { "internalType": "bool", "name": "exists", "type": "bool" }
            ],
            "internalType": "struct AdrianMarket.Offer[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "buyer", "type": "address" }
        ],
        "name": "getMyTokenOffers",
        "outputs": [
          {
            "components": [
              { "internalType": "uint256", "name": "id", "type": "uint256" },
              { "internalType": "address", "name": "collection", "type": "address" },
              { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
              { "internalType": "uint256", "name": "quantity", "type": "uint256" },
              { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
              { "internalType": "address", "name": "buyer", "type": "address" },
              { "internalType": "bool", "name": "exists", "type": "bool" }
            ],
            "internalType": "struct AdrianMarket.TokenOffer[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "getTokenOffersForToken",
        "outputs": [
          {
            "components": [
              { "internalType": "uint256", "name": "id", "type": "uint256" },
              { "internalType": "address", "name": "collection", "type": "address" },
              { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
              { "internalType": "uint256", "name": "quantity", "type": "uint256" },
              { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
              { "internalType": "address", "name": "buyer", "type": "address" },
              { "internalType": "bool", "name": "exists", "type": "bool" }
            ],
            "internalType": "struct AdrianMarket.TokenOffer[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "listingIdCounter",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "", "type": "uint256" },
          { "internalType": "address", "name": "", "type": "address" }
        ],
        "name": "offers",
        "outputs": [
          { "internalType": "uint256", "name": "id", "type": "uint256" },
          { "internalType": "uint256", "name": "listingId", "type": "uint256" },
          { "internalType": "address", "name": "buyer", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "uint256", "name": "quantity", "type": "uint256" },
          { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
          { "internalType": "bool", "name": "exists", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "name": "offersByBuyer",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "uint256[]", "name": "", "type": "uint256[]" },
          { "internalType": "uint256[]", "name": "", "type": "uint256[]" },
          { "internalType": "bytes", "name": "", "type": "bytes" }
        ],
        "name": "onERC1155BatchReceived",
        "outputs": [ { "internalType": "bytes4", "name": "", "type": "bytes4" } ],
        "stateMutability": "pure",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "uint256", "name": "", "type": "uint256" },
          { "internalType": "uint256", "name": "", "type": "uint256" },
          { "internalType": "bytes", "name": "", "type": "bytes" }
        ],
        "name": "onERC1155Received",
        "outputs": [ { "internalType": "bytes4", "name": "", "type": "bytes4" } ],
        "stateMutability": "pure",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [ { "internalType": "address", "name": "", "type": "address" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "paused",
        "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "paymentToken",
        "outputs": [ { "internalType": "contract IERC20", "name": "", "type": "address" } ],
        "stateMutability": "view",
        "type": "function"
      },
      { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "setFloorOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "traitType", "type": "string" },
          { "internalType": "string", "name": "traitValue", "type": "string" },
          { "internalType": "uint256", "name": "offerAmount", "type": "uint256" }
        ],
        "name": "setTraitOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "bytes4", "name": "interfaceId", "type": "bytes4" }
        ],
        "name": "supportsInterface",
        "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "name": "tokenOfferById",
        "outputs": [
          { "internalType": "uint256", "name": "id", "type": "uint256" },
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "uint256", "name": "quantity", "type": "uint256" },
          { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
          { "internalType": "address", "name": "buyer", "type": "address" },
          { "internalType": "bool", "name": "exists", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "tokenOfferCounter",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "bytes32", "name": "", "type": "bytes32" },
          { "internalType": "address", "name": "", "type": "address" }
        ],
        "name": "tokenOfferIndex",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "", "type": "address" },
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "name": "tokenOffersByBuyer",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "traitOfferIdCounter",
        "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "bytes32", "name": "", "type": "bytes32" }
        ],
        "name": "traitOffers",
        "outputs": [
          { "internalType": "uint256", "name": "id", "type": "uint256" },
          { "internalType": "string", "name": "traitType", "type": "string" },
          { "internalType": "string", "name": "traitValue", "type": "string" },
          { "internalType": "uint256", "name": "offerAmount", "type": "uint256" },
          { "internalType": "address", "name": "buyer", "type": "address" },
          { "internalType": "bool", "name": "active", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      { "inputs": [ { "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" }
        ],
        "name": "withdrawFloorOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "listingId", "type": "uint256" }
        ],
        "name": "withdrawOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "collection", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "withdrawTokenOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];
    
    // ABI de tokens y NFTs (sin cambios)
    const TOKEN_ABI = [
      "function balanceOf(address account) view returns (uint256)",
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
    const NFT_ABI = [
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function ownerOf(uint256 tokenId) view returns (address)",
      "function getApproved(uint256 tokenId) view returns (address)",
      "function approve(address to, uint256 tokenId) external",
      "function isApprovedForAll(address owner, address operator) view returns (bool)",
      "function setApprovalForAll(address operator, bool approved) external"
    ];
    
    async function initContracts() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAccount = await signer.getAddress();
        tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
        nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
        marketplaceContract = new ethers.Contract(MARKET_ADDRESS, MARKET_ABI, signer);
        updateTokenBalance();
        loadFloorOffer();
      } else {
        console.error("Ethereum provider not found.");
      }
    }
    
    /*********** NFT Data Loading and Display Functions ***********/
    // (Funciones de carga de NFTs, filtrado de traits, renderización, etc. se mantienen en gran medida iguales)
    // ...
    
    async function loadActiveListings() {
      try {
        activeListingsData = await marketplaceContract.getActiveListingsDetailed();
        activeListingsData = activeListingsData.filter(listing => 
          listing.expirationTime > Math.floor(Date.now() / 1000)
        );
        console.log("Active listings loaded:", activeListingsData);
      } catch (error) {
        console.error("Error loading active listings:", error);
        activeListingsData = [];
      }
    }
    
    async function loadNFTs() {
      try {
        const response = await fetch('adrianpunks.json');
        if (!response.ok) throw new Error('Error loading NFTs');
        const data = await response.json();
        nftData = data.collection || [];
        await loadActiveListings();
        // Extraer traits y renderizar filtros
        // ...
        filterAndDisplayNFTs();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('nftGrid').innerHTML = `<div class="alert alert-danger">Error loading NFTs: ${error.message}</div>`;
      }
    }
    
    /*********** Contract Interaction Functions ***********/
    
    // Función de compra actualizada para usar listing.id en lugar de tokenId
    async function buyNFT(nftName) {
      try {
        if (!marketplaceContract || !tokenContract) {
          alert("Please connect your wallet to continue.");
          return;
        }
        const response = await fetch('adrianpunks.json');
        const data = await response.json();
        const nft = data.collection.find(n => n.name === nftName);
        if (!nft) { 
          alert("NFT not found.");
          return;
        }
        const tokenId = parseInt(nft.name.split("#")[1]);
        const listing = activeListingsData.find(listing => 
          listing.tokenId.toString() === tokenId.toString() &&
          listing.expirationTime > Math.floor(Date.now() / 1000)
        );
        if (!listing) {
          alert("No active listing found for this NFT.");
          return;
        }
        const price = listing.price;
        const currentAllowance = await tokenContract.allowance(userAccount, MARKET_ADDRESS);
        if (currentAllowance.lt(price)) {
          const txApprove = await tokenContract.approve(MARKET_ADDRESS, price);
          await txApprove.wait();
        }
        const txPurchase = await marketplaceContract.buyListing(listing.id, 1);
        await txPurchase.wait();
        alert("Purchase successful!");
      } catch (error) {
        console.error("Error purchasing NFT:", error);
        alert("Error purchasing NFT: " + error.message);
      }
    }
    
    // Función para aceptar una floor offer actualizada: se usa acceptMultipleFloorOffers
    async function acceptFloorOffer(tokenId) {
      try {
        const floorOffer = await marketplaceContract.floorOffers(NFT_ADDRESS);
        if (!floorOffer.active) {
          alert("No active floor offer found for this collection.");
          return;
        }
        const owner = await nftContract.ownerOf(tokenId);
        if (owner.toLowerCase() !== userAccount.toLowerCase()) {
          alert("You are not the owner of this token.");
          return;
        }
        const approvedAddress = await nftContract.getApproved(tokenId);
        if (approvedAddress.toLowerCase() !== MARKET_ADDRESS.toLowerCase()) {
          const txApprove = await nftContract.approve(MARKET_ADDRESS, tokenId);
          await txApprove.wait();
        }
        // Usar acceptMultipleFloorOffers enviando un array con el único buyer
        const buyers = [floorOffer.buyer];
        const tx = await marketplaceContract.acceptMultipleFloorOffers(NFT_ADDRESS, tokenId, 1, buyers, { gasLimit: 1000000 });
        await tx.wait();
        alert("Floor offer accepted successfully!");
        const modal = bootstrap.Modal.getInstance(document.getElementById('nftModal'));
        modal.hide();
        loadNFTs();
      } catch (error) {
        console.error("Error accepting floor offer:", error);
        alert("Error accepting floor offer: " + error.message);
      }
    }
    
    // Función para cancelar la floor offer usando withdrawFloorOffer
    async function cancelFloorOffer() {
      try {
        const tx = await marketplaceContract.withdrawFloorOffer(NFT_ADDRESS, { gasLimit: 1000000 });
        await tx.wait();
        alert("Floor offer cancelled successfully!");
        loadFloorOffers();
      } catch (error) {
        console.error("Error cancelling floor offer:", error);
        alert("Error cancelling floor offer: " + error.message);
      }
    }
    
    // Las funciones para ofertas de token, trait, listings, etc. se mantienen similares,
    // revisa y ajusta las llamadas si la estructura de datos del contrato ha cambiado.
    // ...
    
    document.addEventListener('DOMContentLoaded', async () => {
      await initContracts();
      loadNFTs();
    });
  </script>
</body>
</html>