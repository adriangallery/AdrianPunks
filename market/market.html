<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdrianPunks Market v3.1</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Cargar ethers.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- Incluir el menú -->
  <div id="menu-container"></div>

  <div class="container">
    <div class="nft-grid" id="nftGrid"></div>
  </div>

  <!-- Modal para mostrar detalles del NFT -->
  <div class="modal" id="nftModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="nftModalContent">
        <!-- El contenido del modal se llenará dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Scripts del menú y Bootstrap -->
  <script src="components/menu.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Script principal: carga de NFTs e interacciones con contratos -->
  <script>
    /*********** Configuración e Interacción con Contratos ***********/
    // Direcciones de contratos (reemplaza con las direcciones reales si es necesario)
    const MARKET_ADDRESS = "0xcef57f12a949586ec2d7bbf9ee8a4b3a7e7abc73";
    const PUNKS_ADDRESS = "0x4b9afc775d3D1969F727e81BA970B19b9e8054EF";
    const TOKEN_ADDRESS  = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";

    // ABIs mínimas para interactuar con cada contrato
    const MARKET_ABI = [
      "function buyNFT(uint256 tokenId) external",
      "function getNFTPrice(uint256 tokenId) view returns (uint256)"
    ];
    const PUNKS_ABI = [
      "function tokenURI(uint256 tokenId) view returns (string)"
    ];
    const TOKEN_ABI = [
      "function balanceOf(address account) view returns (uint256)",
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];

    let marketContract, punksContract, tokenContract, signer;

    async function initContracts() {
      if (window.ethereum) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        marketContract = new ethers.Contract(MARKET_ADDRESS, MARKET_ABI, signer);
        punksContract  = new ethers.Contract(PUNKS_ADDRESS, PUNKS_ABI, provider);
        tokenContract   = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
      } else {
        console.error("Proveedor de Ethereum no encontrado");
      }
    }

    /*********** Carga y Visualización de NFTs ***********/
    async function loadNFTs() {
      try {
        const response = await fetch('adrianpunks.json');
        if (!response.ok) {
          throw new Error('Error al cargar los NFTs');
        }
        const data = await response.json();
        displayNFTs(data.collection);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('nftGrid').innerHTML = 
          `<div class="alert alert-danger">Error al cargar los NFTs: ${error.message}</div>`;
      }
    }

    function displayNFTs(nfts) {
      const grid = document.getElementById('nftGrid');
      grid.innerHTML = '';

      if (!nfts || nfts.length === 0) {
        grid.innerHTML = '<div class="alert alert-info">No se encontraron NFTs</div>';
        return;
      }

      nfts.forEach(nft => {
        const card = document.createElement('div');
        card.className = 'card nft-card';
        card.innerHTML = `
          <img src="${nft.image}" class="card-img-top" 
               alt="${nft.name}" 
               onerror="this.src='placeholder.png'">
          <div class="card-body">
              <h5 class="card-title">${nft.name}</h5>
              <p class="card-text">Rareza: ${nft.rarity.toFixed(2)}</p>
              <button class="btn btn-primary" onclick="showNFTDetails('${nft.name}')">
                  Ver detalles
              </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function showNFTDetails(nftName) {
      fetch('adrianpunks.json')
        .then(response => response.json())
        .then(data => {
          const nft = data.collection.find(n => n.name === nftName);
          if (nft) {
            const modalContent = document.getElementById('nftModalContent');
            modalContent.innerHTML = `
              <div class="modal-header">
                  <h5 class="modal-title">${nft.name}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <img src="${nft.image}" class="img-fluid mb-3" 
                       alt="${nft.name}" 
                       onerror="this.src='placeholder.png'">
                  <div class="nft-details">
                      <p><strong>Descripción:</strong> ${nft.description}</p>
                      <p><strong>Compilador:</strong> ${nft.compiler}</p>
                      <p><strong>Masterminds:</strong> ${nft.masterminds.join(', ')}</p>
                      <p><strong>Rareza:</strong> ${nft.rarity.toFixed(2)}</p>
                      <h6>Atributos:</h6>
                      <ul class="list-group">
                          ${nft.attributes.map(attr => 
                            `<li class="list-group-item">
                              <strong>${attr.trait_type}:</strong> ${attr.value}
                            </li>`
                          ).join('')}
                      </ul>
                      <button class="btn btn-success mt-3" onclick="comprarNFT('${nft.name}')">
                          Comprar NFT
                      </button>
                  </div>
              </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('nftModal'));
            modal.show();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cargar los detalles del NFT');
        });
    }

    /*********** Función para Comprar NFT (interacción con contratos) ***********/
    async function comprarNFT(nftName) {
      try {
        // Verificar que los contratos estén inicializados
        if (!marketContract || !tokenContract) {
          alert("Conecta tu wallet para continuar.");
          return;
        }
        // Obtener el NFT por nombre
        const response = await fetch('adrianpunks.json');
        const data = await response.json();
        const nft = data.collection.find(n => n.name === nftName);
        if (!nft) {
          alert("NFT no encontrado.");
          return;
        }
        // Extraer tokenId del nombre (ej. "AdrianPunks#1")
        const tokenId = parseInt(nft.name.split("#")[1]);
        // Obtener el precio del NFT desde el contrato de mercado
        const precio = await marketContract.getNFTPrice(tokenId);
        console.log("Precio del NFT:", precio.toString());
        // Revisar el allowance; si es menor al precio, aprobar el gasto
        const allowance = await tokenContract.allowance(await signer.getAddress(), MARKET_ADDRESS);
        if (allowance.lt(precio)) {
          const txAprobar = await tokenContract.approve(MARKET_ADDRESS, precio);
          await txAprobar.wait();
        }
        // Ejecutar la compra
        const txCompra = await marketContract.buyNFT(tokenId);
        await txCompra.wait();
        alert("¡Compra realizada con éxito!");
      } catch (error) {
        console.error("Error al comprar el NFT:", error);
        alert("Error al comprar el NFT: " + error.message);
      }
    }

    // Inicializar contratos y cargar NFTs cuando la página esté lista
    document.addEventListener('DOMContentLoaded', async () => {
      await initContracts();
      loadNFTs();
    });
  </script>
</body>
</html>